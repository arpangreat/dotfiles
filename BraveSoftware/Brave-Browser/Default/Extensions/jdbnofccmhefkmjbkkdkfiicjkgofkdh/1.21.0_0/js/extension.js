/*! (c) Philipp KÃ¶nig under GPL-3.0 */
(e=>{"use strict";e.BookmarkHelper=function(t){this.removeEntry=l=>new Promise((a=>{const r=t.helper.entry.getDataById(l);if(r&&r.url){const l=t.helper.list.getActiveBookmarkBox().find("a["+e.attr.id+"='"+r.id+"']");l.data("restore",r);const i=e("<span></span>").addClass(e.cl.sidebar.removeMask).append("<em>"+t.helper.i18n.get("sidebar_deleted")+"</em>").append("<span>"+t.helper.i18n.get("sidebar_undo_deletion")+"</span>").appendTo(l);e.delay(100).then((()=>{l.addClass(e.cl.sidebar.removed),i.children("span")[0].offsetTop>0&&i.children("em").remove()})),t.helper.selection.deselect(r.id),this.performDeletion(r.id,!0).then(a)}else t.helper.overlay.create("delete",t.helper.i18n.get("contextmenu_delete_dir"),r),a()})),this.editEntry=e=>new Promise((l=>{const a=t.helper.model.getData("u/additionalInfo");a[e.id]={desc:e.additionalInfo},Promise.all([t.helper.model.call("updateBookmark",{id:e.id,title:e.title,url:e.url,preventReload:!0}),t.helper.model.setData({"u/additionalInfo":a})]).then(l)})),this.restoreEntry=l=>new Promise((a=>{if(l&&l.length()>0){const r=l.data("restore");l.removeClass(e.cl.sidebar.removed).addClass(e.cl.sidebar.restored),e.delay(500).then((()=>(l.children("span."+e.cl.sidebar.removeMask).remove(),t.helper.model.call("createBookmark",r)))).then((a=>{const i=[];if(a&&a.created){l.attr(e.attr.id,a.created);const o=t.helper.model.getData("u/additionalInfo");o[r.id]&&(o[a.created]=o[r.id],i.push(t.helper.model.setData({"u/additionalInfo":o})))}return i.push(t.helper.entry.init()),Promise.all(i)})).then((()=>{a()}))}else a()})),this.performDeletion=(e,l=!1)=>new Promise((a=>{t.helper.model.call("deleteBookmark",{id:e,preventReload:l}).then((()=>{a()}))})),this.pinEntry=e=>new Promise((a=>{const r=t.helper.model.getData("u/pinnedEntries");let i=-1;Object.values(r).forEach((e=>{i=Math.max(i,e.index)})),r[e.id]={index:i+1},l(r).then(a)})),this.unpinEntry=e=>new Promise((a=>{const r=t.helper.model.getData("u/pinnedEntries");delete r[e.id],l(r).then(a)})),this.reorderPinnedEntries=e=>new Promise((a=>{const r=t.helper.model.getData("u/pinnedEntries");let i=0;if(e.prevId){const l=t.helper.entry.getDataById(e.prevId);i=l.pinnedIndex+1}Object.keys(r).forEach((l=>{+l==+e.id?(r[l].index=i,t.helper.entry.addData(l,"pinnedIndex",i)):r[l].index>=i&&(r[l].index++,t.helper.entry.addData(l,"pinnedIndex",r[l].index))})),l(r).then(a)}));const l=e=>new Promise((l=>{Promise.all([t.helper.model.call("removeCache",{name:"htmlList"}),t.helper.model.call("removeCache",{name:"htmlPinnedEntries"}),t.helper.model.setData({"u/pinnedEntries":e})]).then(l)}))},e.CheckboxHelper=function(t){const l={};this.get=(t,l,a="checkbox",r="default")=>{const i=e("<div></div>").html("<input type='checkbox' />").data("uid",Math.random().toString(36).substr(2,12)).attr(e.attr.type,a).attr(e.attr.style,r).addClass(e.cl.checkbox.box);return l&&(i.children("input[type='checkbox']").attr(l),l[e.attr.name]&&i.attr(e.attr.name,l[e.attr.name])),this.isChecked(i)&&i.addClass(e.cl.active),this.initEvents(i,t),i},this.initEvents=(t,l)=>{t.on("mousedown",(t=>{t.preventDefault(),t.stopPropagation(),e(t.currentTarget).addClass(e.cl.checkbox.focus)})).on("click",(t=>{t.preventDefault(),t.stopPropagation(),r(e(t.currentTarget),l)})),l.on("click",(()=>{t.removeClass(e.cl.checkbox.focus)}))},this.isChecked=e=>e.find("input[type='checkbox']")[0].checked;const a=(l,a)=>{const r=l.children("input[type='checkbox']");r.trigger("change"),t.helper.utility&&t.helper.utility.triggerEvent("checkboxChanged",{container:l,checkbox:r,checked:l.hasClass(e.cl.active)},a.document()[0])},r=(t,i)=>{t.addClass(e.cl.checkbox.clicked),t.removeClass(e.cl.checkbox.focus),t.toggleClass(e.cl.active);const o=t.hasClass(e.cl.active),n=t.children("input[type='checkbox']");if("radio"===t.attr(e.attr.type)&&t.attr(e.attr.name))if(i){const l=t.attr(e.attr.name);t.addClass(e.cl.active),o&&(n.attr("checked",!0),a(t,i)),i.find("div."+e.cl.checkbox.box+"["+e.attr.type+"='radio']["+e.attr.name+"='"+l+"']").forEach((l=>{const a=e(l);l!==t[0]&&this.isChecked(a)&&r(a)}))}else n.attr("checked",!1);else n.attr("checked",o),a(t,i);const s=t.data("uid");l[s]&&clearTimeout(l[s]),l[s]=setTimeout((()=>{t.removeClass(e.cl.checkbox.clicked)}),300)}},e.ContextmenuHelper=function(t){let l=null,a=0,r=null;const i={};this.create=(r,i)=>{const p=t.helper.model.getData(["b/sidebarPosition","a/styles"]);if(l=p.sidebarPosition,p.styles&&p.styles.sidebarWidth&&(a=parseInt(p.styles.sidebarWidth)),t.helper.toggle.addSidebarHoverClass(),t.helper.tooltip.close(),o(r,i))"menu"!==r&&"sort"!==r||this.close();else{this.close(),i.addClass(e.cl.active);const l=e("<div></div>").addClass(e.cl.contextmenu.wrapper).html("<ul class='"+e.cl.contextmenu.list+"'></ul><ul class='"+e.cl.contextmenu.icons+"'></ul>").attr(e.attr.type,r).data("elm",i).appendTo(t.elm.sidebar);let a=r;const o=i.attr(e.attr.id);switch(o&&l.attr(e.attr.id,o),r){case"list":{c(l,i);const e=t.helper.entry.getDataById(o);a=e&&e.isDir?"directory":"bookmark";break}case"separator":d(l,i);break;case"menu":s(l,i);break;case"sort":n(l,i)}u(l),h(l,i,r),e.delay().then((()=>{l.addClass(e.cl.visible)}))}},this.close=()=>{const l=t.elm.iframeBody.find("div."+e.cl.contextmenu.wrapper);l.forEach((t=>{e(t).removeClass(e.cl.visible),e(t).data("elm").removeClass(e.cl.active)})),e.delay(500).then((()=>{l.remove(),t.helper.toggle.removeSidebarHoverClass()}))};const o=(l,a)=>{const r=a.attr(e.attr.id),i=a.attr(e.attr.value);let o="div."+e.cl.contextmenu.wrapper+"["+e.attr.type+"='"+l+"']";return r?o+="["+e.attr.id+"='"+r+"']":i&&(o+="["+e.attr.value+"='"+i+"']"),t.elm.sidebar.find(o).length()>0},n=l=>{const a=t.helper.utility.getSortList(),r=t.helper.list.getSort(),i=l.children("ul."+e.cl.contextmenu.list);l.children("ul."+e.cl.contextmenu.icons).remove(),Object.keys(a).forEach((a=>{const o=a.replace(/([A-Z])/g,"_$1").toLowerCase();e("<li></li>").append(t.helper.checkbox.get(t.elm.iframeBody,{[e.attr.name]:"sort",[e.attr.value]:a},"radio")).append("<a "+e.attr.name+"='sort'>"+t.helper.i18n.get("sort_label_"+o)+"</a>").appendTo(i),a===r.name&&l.find("input["+e.attr.name+"='sort']["+e.attr.value+"='"+a+"']").parent("div."+e.cl.checkbox.box).trigger("click")}))},s=l=>{const a=l.children("ul."+e.cl.contextmenu.list),r=l.children("ul."+e.cl.contextmenu.icons);e("<li></li>").append(t.helper.checkbox.get(t.elm.iframeBody,{[e.attr.name]:"toggleHidden"})).append("<a "+e.attr.name+"='toggleHidden'>"+t.helper.i18n.get("contextmenu_toggle_hidden")+"</a>").appendTo(a),t.helper.model.getData("u/showHidden")&&l.find("input["+e.attr.name+"='toggleHidden']").parent("div."+e.cl.checkbox.box).trigger("click"),e("<li></li>").append("<a "+e.attr.name+"='select'>"+t.helper.i18n.get("contextmenu_select_entries")+"</a>").appendTo(a),e("<li></li>").append("<a "+e.attr.name+"='reload'>"+t.helper.i18n.get("contextmenu_reload_sidebar")+"</a>").appendTo(a);const i=t.elm.bookmarkBox.all.children("ul"),o=i.hasClass(e.cl.sidebar.hideRoot);let n=!1;i.find("a."+e.cl.sidebar.dirOpened).forEach((t=>{if(!1===o||e(t).parents("li").length()>1)return n=!0,!1})),n&&e("<li></li>").append("<a "+e.attr.name+"='closeAll'>"+t.helper.i18n.get("contextmenu_close_all_directories")+"</a>").appendTo(a),r.append("<li><a "+e.attr.name+"='settings' title='"+t.helper.i18n.get("settings_title",null,!0)+"'></a></li>").append("<li><a "+e.attr.name+"='bookmarkManager' title='"+t.helper.i18n.get("contextmenu_bookmark_manager",null,!0)+"'></a></li>").append("<li class='"+e.cl.contextmenu.right+"'><a "+e.attr.name+"='keyboardShortcuts' title='"+t.helper.i18n.get("contextmenu_keyboard_shortcuts",null,!0)+"'></a></li>")},d=(l,a)=>{const r=a.attr(e.attr.id),i=t.helper.entry.getDataById(r);if(i&&i.parents&&i.parents.length>0){const a=l.children("ul."+e.cl.contextmenu.list);a.append("<li><a "+e.attr.name+"='edit'>"+t.helper.i18n.get("contextmenu_edit_separator")+"</a></li>"),a.append("<li><a "+e.attr.name+"='delete'>"+t.helper.i18n.get("contextmenu_delete_separator")+"</a></li>")}l.children("ul."+e.cl.contextmenu.icons).remove()},c=(l,a)=>{const r=a.attr(e.attr.id),i=t.helper.entry.getDataById(r);if(!i)return;const o=i.isDir?"_dir":"_bookmark",n=l.children("ul."+e.cl.contextmenu.list),s=l.children("ul."+e.cl.contextmenu.icons),d=a.parents("div."+e.cl.sidebar.entryPinned).length()>0;if(t.helper.search.isResultsVisible()&&n.append("<li><a "+e.attr.name+"='showInDir'>"+t.helper.i18n.get("contextmenu_show_in_dir")+"</a></li>"),i.isDir){const l=i.children.filter((e=>e.url&&"about:blank"!==e.url));n.append("<li><a "+e.attr.name+"='add' "+e.attr.type+"='bookmark'>"+t.helper.i18n.get("contextmenu_add_bookmark")+"</a></li>"),l.length>0&&n.append("<li><a "+e.attr.name+"='openChildren'>"+t.helper.i18n.get("contextmenu_open_children")+" <span>("+l.length+")</span></a></li>"),i.children.length>0&&n.append("<li><a "+e.attr.name+"='checkBookmarks'>"+t.helper.i18n.get("contextmenu_check_bookmarks")+"</a></li>")}else"newtab"===t.helper.model.getData("b/linkAction")?n.append("<li><a "+e.attr.name+"='currentTab'>"+t.helper.i18n.get("contextmenu_current_tab")+"</a></li>"):n.append("<li><a "+e.attr.name+"='newTab'>"+t.helper.i18n.get("contextmenu_new_tab")+"</a></li>"),n.append("<li><a "+e.attr.name+"='newWindow'>"+t.helper.i18n.get("contextmenu_new_window")+"</a></li>"),!1===e.api.extension.inIncognitoContext&&n.append("<li><a "+e.attr.name+"='newIncognito'>"+t.helper.i18n.get("contextmenu_new_tab_incognito")+"</a></li>");if(d||(a.hasClass(e.cl.selected)?n.append("<li><a "+e.attr.name+"='deselect'>"+t.helper.i18n.get("contextmenu_deselect_"+(i.isDir?"dir":"bookmark"))+"</a></li>"):n.append("<li><a "+e.attr.name+"='select'>"+t.helper.i18n.get("contextmenu_select_"+(i.isDir?"dir":"bookmark"))+"</a></li>")),s.append("<li><a "+e.attr.name+"='infos' title='"+t.helper.i18n.get("contextmenu_infos",null,!0)+"'></a></li>"),i.parents.length>0&&s.append("<li><a "+e.attr.name+"='edit' title='"+t.helper.i18n.get("contextmenu_edit"+o,null,!0)+"'></a></li>").append("<li><a "+e.attr.name+"='delete' title='"+t.helper.i18n.get("contextmenu_delete"+o,null,!0)+"'></a></li>"),i.isDir){const l=e("<li></li>").html("<a "+e.attr.name+"='add' title='"+t.helper.i18n.get("contextmenu_add",null,!0)+"'></a>").appendTo(s);e("<ul></ul>").attr(e.attr.name,"add").append("<li><a "+e.attr.type+"='bookmark' title='"+t.helper.i18n.get("overlay_label_bookmark",null,!0)+"'></a></li>").append("<li><a "+e.attr.type+"='dir' title='"+t.helper.i18n.get("overlay_label_dir",null,!0)+"'></a></li>").append("<li><a "+e.attr.type+"='separator' title='"+t.helper.i18n.get("overlay_label_separator",null,!0)+"'></a></li>").appendTo(l)}else s.append("<li><a "+e.attr.name+"='copyToClipboard' title='"+t.helper.i18n.get("contextmenu_copy",null,!0)+"'></a></li>"),i.pinned?s.append("<li class='"+e.cl.contextmenu.right+"'><a "+e.attr.name+"='unpin' title='"+t.helper.i18n.get("contextmenu_unpin",null,!0)+"'></a></li>"):s.append("<li class='"+e.cl.contextmenu.right+"'><a "+e.attr.name+"='pin' title='"+t.helper.i18n.get("contextmenu_pin",null,!0)+"'></a></li>");t.helper.entry.isVisible(r)?s.append("<li class='"+e.cl.contextmenu.right+"'><a "+e.attr.name+"='hide' title='"+t.helper.i18n.get("contextmenu_hide_from_sidebar",null,!0)+"'></a></li>"):!1===t.helper.search.isResultsVisible()&&a.parents("li."+e.cl.hidden).length()<=1&&s.append("<li class='"+e.cl.contextmenu.right+"'><a "+e.attr.name+"='showHidden' title='"+t.helper.i18n.get("contextmenu_show_in_sidebar",null,!0)+"'></a></li>")},h=(r,i,o)=>{const n=r.realWidth(),s=r.realHeight(),d=i[0].getBoundingClientRect(),c=d.top+d.height;if(c+s>=window.innerHeight?r.css("top",c-s).addClass(e.cl.contextmenu.top):r.css("top",c+"px"),"sort"!==o&&"menu"!==o){const e={left:i.parent("li")[0].offsetLeft,right:"auto"};t.helper.i18n.isRtl()?(e.left=d.width-n,"left"===l&&e.left<0&&(e.left=0)):"right"===l&&e.left+n>a&&(e.left="auto",e.right=0),["left","right"].forEach((t=>{"number"==typeof e[t]&&(e[t]+="px"),r.css(t,e[t])}))}};i.settings=()=>{t.helper.model.call("openLink",{href:e.api.extension.getURL("html/settings.html"),newTab:!0})},i.checkbox=t=>{t.eventObj.stopPropagation(),e(t.elm).prev("div."+e.cl.checkbox.box).trigger("click")},i.bookmarkManager=()=>{t.helper.model.call("openLink",{href:"chrome://bookmarks",newTab:!0,active:!0})},i.newIncognito=e=>{e.data&&t.helper.utility.openUrl(e.data,"incognito")},i.newWindow=e=>{e.data&&(t.helper.utility.openUrl(e.data,"newWindow"),t.helper.toggle.closeSidebar())},i.currentTab=e=>{e.data&&(e.data.reopenSidebar=t.helper.model.getData("b/reopenSidebar"),t.helper.utility.openUrl(e.data))},i.newTab=e=>{if(e.data){const l="foreground"===t.helper.model.getData("b/newTab");e.data.reopenSidebar=t.helper.model.getData("b/reopenSidebar"),t.helper.utility.openUrl(e.data,"newTab",l),l&&t.helper.toggle.closeSidebar()}},i.delete=e=>{t.helper.bookmark.removeEntry(e.data.id)},i.showHidden=e=>{t.startLoading();const l=t.helper.model.getData("u/hiddenEntries");delete l[e.id],t.helper.model.setData({"u/hiddenEntries":l}).then((()=>Promise.all([t.helper.model.call("removeCache",{name:"htmlList"}),t.helper.model.call("removeCache",{name:"htmlPinnedEntries"})]))).then((()=>{t.helper.model.call("reload",{type:"Hide"})}))},i.openChildren=e=>{if(e.data){const l=e.data.children.filter((e=>e.url&&"about:blank"!==e.url));l.length>t.helper.model.getData("b/openChildrenWarnLimit")?t.helper.overlay.create(e.name,t.helper.i18n.get("contextmenu_open_children"),e.data):t.helper.utility.openAllBookmarks(l)}},i.pin=e=>{t.helper.bookmark.pinEntry(e.data).then((()=>{t.helper.model.call("reload",{type:"Pin"})}))},i.unpin=e=>{t.helper.bookmark.unpinEntry(e.data).then((()=>{t.helper.model.call("reload",{type:"Unpin"})}))},i.copyToClipboard=l=>{const a=t.helper.entry.getDataById(l.id);if(a&&a.url&&t.helper.utility.copyToClipboard(a.url)){const l=t.helper.list.getActiveBookmarkBox().find("a["+e.attr.id+"='"+a.id+"']");e(l).children("span."+e.cl.sidebar.copied).remove();const r=e("<span></span>").addClass(e.cl.sidebar.copied).text(t.helper.i18n.get("sidebar_copied_to_clipboard")).appendTo(l);e.delay(100).then((()=>(e(l).addClass(e.cl.sidebar.copied),e.delay(1500)))).then((()=>(e(l).removeClass(e.cl.sidebar.copied),e.delay(500)))).then((()=>{r.remove()}))}},i.showInDir=l=>{const a=t.helper.entry.getDataById(l.id);if(a&&a.parents){const r=i=>{if(a.parents[i]){const l=t.elm.bookmarkBox.all.find("ul > li > a."+e.cl.sidebar.bookmarkDir+"["+e.attr.id+"='"+a.parents[i]+"']");l.hasClass(e.cl.sidebar.dirOpened)?r(i+1):t.helper.list.toggleBookmarkDir(l,!0,!1).then((()=>{r(i+1)}))}else Promise.all([t.helper.list.cacheList(),t.helper.search.clearSearch()]).then((()=>{const a=t.elm.bookmarkBox.all.find("ul > li > a["+e.attr.id+"='"+l.id+"']");t.helper.scroll.setScrollPos(t.elm.bookmarkBox.all,a[0].offsetTop-50),a.addClass(e.cl.sidebar.mark)}))};r(0)}},i.select=e=>{e.id?t.helper.selection.select(e.id):t.helper.selection.start()},i.deselect=e=>{t.helper.selection.deselect(e.id)},i.reload=()=>{t.helper.model.setData({"u/openStates":{}}).then((()=>{t.helper.model.call("reload",{type:"Force"})}))},i.closeAll=()=>{const l=t.elm.bookmarkBox.all.children("ul"),a=l.hasClass(e.cl.sidebar.hideRoot),r=[];l.find("a."+e.cl.sidebar.dirOpened).forEach((l=>{(!1===a||e(l).parents("li").length()>1)&&r.push(t.helper.list.toggleBookmarkDir(e(l),!1,!1))})),Promise.all(r).then((()=>{t.helper.list.cacheList()}))};const p=t=>{r&&clearTimeout(r),t.find("ul["+e.attr.name+"='add']").addClass(e.cl.visible)},m=t=>{r&&clearTimeout(r),r=setTimeout((()=>{t.find("ul["+e.attr.name+"='add']").removeClass(e.cl.visible)}),300)},u=l=>{l.find("input["+e.attr.name+"='sort']").on("change",(l=>{if(l.currentTarget.checked){const a=e(l.currentTarget).attr(e.attr.value);t.helper.list.updateSort(a),this.close()}})),l.find("input["+e.attr.name+"='toggleHidden']").on("change",(l=>{t.startLoading(),Promise.all([t.helper.model.call("removeCache",{name:"htmlList"}),t.helper.model.call("removeCache",{name:"htmlPinnedEntries"}),t.helper.model.setData({"u/showHidden":t.helper.checkbox.isChecked(e(l.currentTarget).parent("div"))})]).then((()=>{t.helper.model.call("reload",{type:"ToggleHidden"})})),this.close()})),l.on("mouseleave",(t=>{e(t.currentTarget).find("a").removeClass(e.cl.hover)})),l.find("ul["+e.attr.name+"='add']").on("mouseenter",(()=>{p(l)})).on("mouseleave",(()=>{m(l)})),l.find("> ul > li > a").on("mouseenter",(t=>{const a=e(t.currentTarget);l.find("a").removeClass(e.cl.hover),a.addClass(e.cl.hover),a.parents("ul."+e.cl.contextmenu.icons).length()>0&&"add"===a.attr(e.attr.name)&&p(l)})).on("mouseleave",(t=>{e(t.currentTarget).removeClass(e.cl.hover),m(l)})),l.find("a").on("click",(a=>{a.preventDefault();let r=a.currentTarget;const o=e(r).parents("ul").eq(0).prev("a");o.length()>0&&(r=o);const n={elm:r,eventObj:a,name:e(r).attr(e.attr.name),id:l.attr(e.attr.id)};n.data=n.id?t.helper.entry.getDataById(n.id):{},n.data.overlayType=e(a.currentTarget).attr(e.attr.type),"sort"!==n.name&&"toggleHidden"!==n.name||(n.name="checkbox"),"function"==typeof i[n.name]?i[n.name](n):t.helper.overlay.create(n.name,e(n.elm).attr("title")||e(n.elm).text(),n.data)}))}},e.DragDropHelper=function(t){let l=null,a=!1,r=null,i=0,o=null;const n={running:!1,posY:null,previousDelta:0,fpsLimit:30};this.init=async()=>{l=t.helper.model.getData("b/sidebarPosition"),a=t.helper.model.getData("b/dndCreationDialog"),g(),d()},this.cancel=()=>{const l=t.elm.iframeBody.children("a."+e.cl.drag.helper),a=t.elm.bookmarkBox.all.find("li."+e.cl.drag.dragInitial),r=l.data("elm");r&&r.insertAfter(a).removeClass(e.cl.drag.isDragged),a.remove(),l.remove(),t.elm.iframeBody.removeClass([e.cl.drag.isDragged,e.cl.drag.cancel]),e.delay(500).then((()=>{t.helper.toggle.removeSidebarHoverClass()}))};const s=e=>{let a=0;if("object"==typeof e){a=e[0].getBoundingClientRect().left}else a=+e;return"right"===l&&(a=window.innerWidth-a),"object"==typeof e?.6*e.realWidth()+a>t.elm.sidebar.realWidth():a>t.elm.sidebar.realWidth()},d=async()=>{t.elm.iframeBody.on("dragenter",(()=>{const l=e("body");l.attr("id")===e.opts.ids.page.newtab&&l.hasClass(e.cl.newtab.edit)||(t.helper.contextmenu.close(),t.helper.tooltip.close(),t.elm.iframeBody.addClass(e.cl.drag.isDragged),t.helper.toggle.addSidebarHoverClass(),n.running||window.requestAnimationFrame(h))})).on("drop dragend",(l=>{if(l.preventDefault(),l.stopPropagation(),n.posY=null,t.elm.iframeBody.hasClass(e.cl.drag.isDragged)){if(!s(l.pageX)&&!1===t.helper.search.isResultsVisible()){const r=t.elm.bookmarkBox.all.find("li."+e.cl.drag.isDragged).eq(0);if(r&&r.length()>0){const i=l.dataTransfer.getData("URL");let o=l.dataTransfer.getData("text/plain");if(location.href===i)o=document.title||"";else if(o===i){const t=l.dataTransfer.getData("text/html");o=t&&t.length>0?e("<div></div>").html(t).text():""}const n={index:r.prevAll("li").length(),parentId:r.parent("ul").prev("a").attr(e.attr.id),title:o.trim(),url:i},s=()=>{t.helper.overlay.create("add",t.helper.i18n.get("contextmenu_add"),{values:n})};!1===a&&n.title&&n.url?t.helper.model.call("createBookmark",n).then((e=>{e.error&&s()})):s()}}t.elm.iframeBody.removeClass([e.cl.drag.isDragged,e.cl.drag.cancel]),t.helper.toggle.removeSidebarHoverClass()}}))},c=t=>{let l="bookmark";return"selection"===t?l=t:t.data("type")?l=t.data("type"):(t.hasClass(e.cl.sidebar.bookmarkDir)?l="directory":t.parents("div."+e.cl.sidebar.entryPinned).length()>0&&(l="pinned"),t.data("type",l)),l},h=e=>{window.requestAnimationFrame(h);const l=e-n.previousDelta;if(!(n.fpsLimit&&l<1e3/n.fpsLimit)){if(null!==n.posY){const e=t.elm.bookmarkBox.all[0].offsetTop,l=t.elm.bookmarkBox.all[0].offsetHeight,a=t.helper.scroll.getScrollPos(t.elm.bookmarkBox.all);let r=null;n.posY-e<60?r=a-Math.pow((50-n.posY+e)/10,2):n.posY+60>l&&(r=a+Math.pow((n.posY+50-l)/10,2)),r&&t.helper.scroll.setScrollPos(t.elm.bookmarkBox.all,r)}n.previousDelta=e}},p=async()=>{m();const l=t.elm.iframeBody.children("a."+e.cl.drag.helper),a=t.elm.bookmarkBox.all.find("li."+e.cl.drag.dragInitial),r=l.data("elm"),i=r.children("a"),o=c(i);if(s(l))this.cancel();else{l.addClass(e.cl.drag.snap);const i=r.parent("ul").prev("a").attr(e.attr.id);let n=0;r.prevAll("li").forEach((e=>{e!==a&&n++})),"pinned"===o?t.helper.bookmark.reorderPinnedEntries({id:r.children("a").attr(e.attr.id),prevId:r.prev("li").children("a").attr(e.attr.id)}):(await t.helper.model.call("moveBookmark",{id:r.children("a").attr(e.attr.id),parentId:i,index:n}),t.helper.selection.isEnabled()&&t.helper.selection.moveSelection(i,n,r)),t.elm.iframeBody.removeClass(e.cl.drag.isDragged),e.delay().then((()=>{const t=r[0].getBoundingClientRect();return l.css({top:t.top+"px",left:t.left+"px"}),e.delay(200)})).then((()=>(r.removeClass(e.cl.drag.isDragged),a.remove(),l.remove(),e.delay(300)))).then((()=>{t.helper.toggle.removeSidebarHoverClass()}))}},m=(t=null)=>{null===o||null!==t&&o.id===t.attr(e.attr.id)||(o.elm.removeClass(e.cl.drag.dragHover),clearTimeout(o.instance),o=null)},u=(l,a,d)=>{let h=null,p=null,u=0,g=0;if("dragover"===l){if(u=d-20,g=a,u===i)return!1;i=u,t.elm.bookmarkBox.all.find("li."+e.cl.drag.isDragged).remove(),p=e("<li></li>").html("<a>&nbsp;</a>").addClass(e.cl.drag.isDragged)}else{h=t.elm.iframeBody.children("a."+e.cl.drag.helper);const l=h.data("startPos");u=d-l.top,g=a-l.left,h.css({top:u+"px",left:g+"px"}),p=h.data("elm")}if(s(h||g))return m(),t.elm.iframeBody.addClass(e.cl.drag.cancel),!1;t.elm.iframeBody.removeClass(e.cl.drag.cancel);const f=c(p.children("a"));let b,v={elm:null};if("pinned"===f?b=[t.elm.pinnedBox.find("> ul > li")]:(n.posY=d,b=[t.elm.bookmarkBox.all.find("a."+e.cl.sidebar.dirOpened+" + ul > li"),t.elm.bookmarkBox.all.find("> ul > li > a."+e.cl.sidebar.dirOpened).parent("li")]),b.some((t=>{t&&t.forEach((t=>{const l=e(t);if(l[0]!==p[0]&&!l.hasClass(e.cl.drag.dragInitial)){const e=l[0].getBoundingClientRect(),t=u-e.top;if(e.top>u)return!1;(null===v.elm||v.diff>t)&&(v={elm:l,height:l[0].offsetHeight,diff:t})}}))})),v.elm&&v.elm!==r){r=v.elm;const l=v.elm.children("a").eq(0),a=l.hasClass(e.cl.sidebar.bookmarkDir),i=v.diff/v.height*100;if(m(l),0===v.elm.nextAll("li:not(."+e.cl.drag.isDragged+")").length()&&i>80){const e=v.elm.parents("li").eq(0);if(h&&e.parents("ul")[0]!==t.elm.bookmarkBox.all.find("> ul")[0]){const t=p.insertAfter(e);h.data("elm",t)}}else if(a&&i<60){if(l.hasClass(e.cl.sidebar.dirOpened)){const e=p.prependTo(l.next("ul"));h&&h.data("elm",e)}else if(l.hasClass(e.cl.sidebar.dirAnimated))0===l.next("ul").length()&&(l.addClass(e.cl.sidebar.dirOpened),e("<ul></ul>").insertAfter(l));else if(null===o){o={id:l.attr(e.attr.id),elm:l.addClass(e.cl.drag.dragHover)};const a=t.helper.model.getData("b/dndOpenDirDelay");o.instance=setTimeout((()=>{t.helper.list.toggleBookmarkDir(l)}),1e3*+a)}}else{m();const e=p.insertAfter(v.elm);h&&h.data("elm",e)}}else if("pinned"===f){const e=p.prependTo(t.elm.pinnedBox.children("ul"));h&&h.data("elm",e)}},g=async()=>{t.elm.bookmarkBox.all.on("mousedown","span."+e.cl.drag.trigger,(l=>{t.helper.toggle.addSidebarHoverClass(),((l,a,r)=>{t.helper.contextmenu.close(),t.helper.tooltip.close();const i=e(l).parent("a").removeClass(e.cl.sidebar.dirOpened),o=i.attr(e.attr.id),s=t.helper.entry.getDataById(o);if(null===s)return!1;t.helper.selection.isEnabled()&&t.helper.selection.select(o);const d=i.parent("li"),c=d.parent("ul").prev("a");t.elm.iframeBody.addClass(e.cl.drag.isDragged),d.clone().addClass(e.cl.drag.dragInitial).insertAfter(d);const p=i.clone().appendTo(t.elm.iframeBody);t.helper.selection.isEnabled()&&e("<span></span>").addClass(e.cl.selected).text(t.helper.selection.getSelectedAmount()).appendTo(p);const m=i[0].getBoundingClientRect();let u=0;d.prevAll("li").forEach((t=>{e(t).hasClass(e.cl.drag.dragInitial)||u++})),p.removeAttr("title").css({top:m.top+"px",left:m.left+"px",width:i.realWidth()+"px"}).data({elm:d,isDir:!!s.isDir,parentId:c.length()>0?c.attr(e.attr.id):null,index:u,startPos:{top:r-m.top,left:a-m.left}}).addClass(e.cl.drag.helper),d.addClass(e.cl.drag.isDragged),n.running||window.requestAnimationFrame(h)})(l.currentTarget,l.pageX,l.pageY),u(l.type,l.pageX,l.pageY)})),t.elm.iframeBody.on("mouseup",(l=>{n.posY=null,t.elm.iframeBody.hasClass(e.cl.drag.isDragged)&&(l.preventDefault(),l.stopPropagation(),1===l.which?p():e.delay(0).then((()=>{this.cancel()})))})),t.elm.iframeBody.on("wheel",(l=>{if(t.elm.iframeBody.hasClass(e.cl.drag.isDragged)){l.preventDefault(),l.stopPropagation();const e=t.elm.bookmarkBox.all[0].scrollTop;t.helper.scroll.setScrollPos(t.elm.bookmarkBox.all,e-l.wheelDelta,300)}})),t.elm.iframeBody.on("mousemove dragover",(l=>{t.elm.iframeBody.hasClass(e.cl.drag.isDragged)&&1===l.which&&(l.preventDefault(),l.stopPropagation(),u(l.type,l.pageX,l.pageY))})),t.elm.iframeBody.on("contextmenu","a."+e.cl.drag.helper,(e=>{e.preventDefault(),e.stopPropagation()}))}},e.EntryHelper=function(e){let t=!1,l={},a={},r={},i={bookmarks:{},directories:{},pinned:{}};this.init=e=>(t=!0,new Promise((t=>{this.update(e).then(t)}))),this.initOnce=()=>new Promise((e=>{t?e():this.init().then(e)})),this.getAmount=t=>{if(o(),0===Object.keys(l).length&&(l=e.helper.model.getData("u/entryAmounts")),l&&l[t]){let e=l[t].visible;return a.showHidden&&(e+=l[t].hidden),e}return null},this.getAllDataByType=e=>Object.values(i[e]||{}),this.getDataById=e=>{let t=null;return"object"==typeof i.bookmarks[e]?(t=i.bookmarks[e],"object"==typeof i.pinned[e]&&(t.pinnedIndex=i.pinned[e].index)):"object"==typeof i.directories[e]&&(t=i.directories[e]),t},this.getParentsById=e=>{const t=[];try{let l=this.getDataById(e).parentId;for(;l;){const e=this.getDataById(l);e&&t.push(e),l=e&&e.parentId?e.parentId:null}}catch(e){}return t},this.addData=(e,t,l)=>{"object"==typeof i.bookmarks[e]?("pinnedIndex"===t&&"object"==typeof i.pinned[e]&&(i.pinned[e].index=l),i.bookmarks[e][t]=l):"object"==typeof i.directories[e]&&(i.directories[e][t]=l)},this.isSeparator=e=>{let t=!1;return"object"==typeof i.bookmarks[e]&&(t="about:blank"===i.bookmarks[e].url&&/^[-_]{3,}/.test(i.bookmarks[e].title)&&/[-_]{3,}$/.test(i.bookmarks[e].title)),t},this.isVisible=e=>{let t=!1;return"object"==typeof i.bookmarks[e]?t=!1===i.bookmarks[e].hidden:"object"==typeof i.directories[e]&&(t=!1===i.directories[e].hidden),t},this.update=(t=null)=>new Promise((a=>{o();const s=[e.helper.model.call("viewAmounts")];null===t&&s.push(e.helper.model.call("bookmarks",{id:0})),Promise.all(s).then((o=>{r=o[0],null===t&&o[1]&&o[1].bookmarks&&o[1].bookmarks[0]&&o[1].bookmarks[0].children&&(t=o[1].bookmarks[0].children),i={bookmarks:{},directories:{},pinned:{}},l={bookmarks:{visible:0,hidden:0},directories:{visible:0,hidden:0},pinned:{visible:0,hidden:0}},n(t),e.helper.model.setData({"u/entryAmounts":l}),a()}))}));const o=()=>{a=e.helper.model.getData(["u/hiddenEntries","u/additionalInfo","u/pinnedEntries","u/showHidden"])},n=(e,t=[],l=!1)=>{e.forEach((e=>{const i=[...t];"0"!==e.parentId&&i.push(e.parentId),e.additionalInfo=a.additionalInfo[e.id]||{},e.hidden=l||!0===a.hiddenEntries[e.id],e.parents=i,e.views={startDate:+new Date(Math.max(e.dateAdded,r.counterStartDate)),total:0},e.url?d(e):e.children&&s(e)}))},s=e=>{e.childrenAmount={bookmarks:0,directories:0,total:0},e.parents.forEach((e=>{i.directories[e].childrenAmount.directories++})),i.directories[e.id]=e,n(e.children,e.parents,e.hidden),e.isDir=!0,e.childrenAmount.total=e.childrenAmount.bookmarks+e.childrenAmount.directories,e.views.perMonth=Math.round(e.views.total/c(e.views.startDate)*100)/100,l.directories[e.hidden?"hidden":"visible"]++},d=e=>{let t=0,o=0;if(r.viewAmounts[e.id]&&(t=r.viewAmounts[e.id].c,o=r.viewAmounts[e.id].d||0),e.views.total=t,e.views.lastView=o,e.views.perMonth=Math.round(t/c(e.views.startDate)*100)/100,e.parents.forEach((e=>{i.directories[e]&&(i.directories[e].childrenAmount.bookmarks++,i.directories[e].views.total+=t,i.directories[e].views.lastView=Math.max(i.directories[e].views.lastView||0,o))})),e.pinned=!1,i.bookmarks[e.id]=e,!1===this.isSeparator(e.id)&&l.bookmarks[e.hidden?"hidden":"visible"]++,a.pinnedEntries[e.id]){e.pinned=!0;const t=Object.assign({},e);t.index=a.pinnedEntries[e.id].index,delete t.parents,delete t.parentId,i.pinned[e.id]=t,l.pinned[e.hidden?"hidden":"visible"]++}},c=e=>Math.max(1,Math.round((+new Date-e)/2627999942.4))},e.FontHelper=function(t){const l={custom:{fontWeights:{Thin:100,ExtraLight:200,Light:300,Normal:400,Medium:500,SemiBold:600,Bold:700,ExtraBold:800,Black:900}},general:{name:"Roboto",href:"https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,100i,200i,300i,400i,500i",fontWeights:{Thin:100,ExtraLight:100,Light:100,Normal:300,Medium:400,SemiBold:400,Bold:500,ExtraBold:500,Black:500}},fa:{fontWeights:{Thin:100,ExtraLight:100,Light:100,Normal:300,Medium:400,SemiBold:500,Bold:600,ExtraBold:600,Black:600}},ar:{fontWeights:{Thin:100,ExtraLight:100,Light:100,Normal:300,Medium:400,SemiBold:500,Bold:600,ExtraBold:600,Black:600}},he:{fontWeights:{Thin:100,ExtraLight:100,Light:100,Normal:300,Medium:400,SemiBold:500,Bold:600,ExtraBold:600,Black:600}},ja:{name:"Noto Sans Japanese",href:"https://fonts.googleapis.com/earlyaccess/notosansjapanese.css",fontWeights:{Thin:100,ExtraLight:100,Light:100,Normal:200,Medium:300,SemiBold:400,Bold:500,ExtraBold:500,Black:500}},zh_CN:{name:"Noto Sans SC",href:"https://fonts.googleapis.com/earlyaccess/notosanssc.css",fontWeights:{Thin:100,ExtraLight:100,Light:100,Normal:300,Medium:400,SemiBold:400,Bold:400,ExtraBold:500,Black:500}},zh_TW:{name:"Noto Sans TC",href:"https://fonts.googleapis.com/earlyaccess/notosanstc.css",fontWeights:{Thin:100,ExtraLight:100,Light:100,Normal:300,Medium:400,SemiBold:400,Bold:400,ExtraBold:500,Black:500}}},a={default:{},config:{}};this.init=()=>{const e=t.helper.model.getData("a/styles");a.default=this.getDefaultFontInfo(),a.default.fontWeights=this.getFontWeights(a.default.name),e.fontFamily=(e.fontFamily||"default").replace(/(^'*)|('*$)/g,""),"default"!==e.fontFamily&&e.fontFamily!==a.default.name?a.config={name:e.fontFamily,fontWeights:this.getFontWeights(e.fontFamily)}:a.config=a.default},this.isLoaded=()=>!!a.default.name,this.getFontInfo=(e="config")=>a[e],this.getFontWeights=e=>{e=e.replace(/(^'*)|('*$)/g,"");const a=t.helper.i18n.getLanguage(),r={};return l[a]&&void 0===l[a].name&&(l[a].name=l.general.name),Object.entries(l.custom.fontWeights).forEach((([t,i])=>{l[a]&&l[a].fontWeights&&l[a].fontWeights[t]&&l[a].name===e?i=l[a].fontWeights[t]:l.general.fontWeights[t]&&l.general.name===e&&(i=l.general.fontWeights[t]),r["fontWeight"+t]=i})),r},this.addStylesheet=(t,l="config")=>{a[l]&&a[l].href&&e("<link />").attr({rel:"stylesheet",type:"text/css",href:a[l].href}).appendTo(t.find("head"))},this.getDefaultFontInfo=()=>{const e=t.helper.i18n.getLanguage();return l[e]&&l[e].name&&l[e].href?Object.assign({},l[e]):Object.assign({},l.general)}},e.I18nHelper=function(t){let l=null,a={},r=null;this.init=()=>new Promise((e=>{t.helper.model.call("langvars").then((t=>{l=t.language,a=t.vars,r=t.dir,e()}))})),this.getLanguage=()=>l,this.isRtl=()=>"rtl"===r,this.getUILanguage=()=>e.api.i18n.getUILanguage(),this.getDefaultLanguage=()=>e.opts.manifest.default_locale,this.getLocaleSortCollator=()=>new Intl.Collator([this.getUILanguage(),this.getDefaultLanguage()]),this.getLocaleDate=e=>("number"==typeof e&&(e=new Date(e)),e.toLocaleDateString([this.getUILanguage(),this.getDefaultLanguage()],{year:"numeric",month:"2-digit",day:"2-digit"})),this.parseHtml=t=>{e(t).find("["+e.attr.i18n+"]").forEach((t=>{let l=null;const a=e(t).attr(e.attr.i18n);if(a){let r=[];const i=e(t).attr(e.attr.i18nReplaces);i&&(r=i.split(",")),l=this.get(a,r)}l?(e(t).removeAttr(e.attr.i18n),e(t).html(l)):e(t).remove()}))},this.get=(t,l=[],r=!1)=>{let i="";const o=a[t];return o&&o.message&&(i=o.message,i=i.replace(/\{browserName\}/gi,e.browserName),l&&l.length>0&&l.forEach(((e,t)=>{i=i.replace(new RegExp("\\{"+(t+1)+"\\}"),e)})),i=i.replace(/\[b\](.*)\[\/b\]/,"<strong>$1</strong>"),i=i.replace(/\[a\](.*)\[\/a\]/,"<a href='#'>$1</a>"),i=i.replace(/\[em\](.*)\[\/em\]/,"<em>$1</em>")),r&&(i=i.replace(/'/g,"&#x27;")),i}},e.KeyboardHelper=function(t){let l=!1;this.init=async()=>{r()},this.initOverlayEvents=l=>{e(l[0].contentDocument).on("keydown",(e=>{if("Escape"===e.key||"Esc"===e.key)e.preventDefault(),t.helper.overlay.closeOverlay();else if("Enter"===e.key){const t=l[0].contentDocument.activeElement;null!==t&&"TEXTAREA"===t.tagName||(e.preventDefault(),i(l))}else"Tab"===e.key&&(e.preventDefault(),s(l))}))};const a=()=>{let l=!1;return t.elm.iframe.hasClass(e.cl.page.visible)&&document&&document.activeElement&&(l=document.activeElement===t.elm.iframe[0]),l},r=()=>{e([document,t.elm.iframe[0].contentDocument]).on("keydown.bs",(l=>{if(a()){const a=["PageDown","PageUp","Home","End","Space"],r=t.elm.header.find("div."+e.cl.sidebar.searchBox+" > input[type='text']"),i=t.elm.sidebar.find("div."+e.cl.contextmenu.wrapper).length()>0,s=t.elm.iframeBody.hasClass(e.cl.drag.isDragged);if(a.indexOf(l.key)>-1||a.indexOf(l.code)>-1)t.helper.scroll.focus(),e.delay(300).then((()=>{c()}));else if("ArrowDown"===l.key||"Tab"===l.key&&!l.shiftKey)if(l.preventDefault(),i)d("next");else{h("next");const l=t.elm.header.find("div."+e.cl.sidebar.searchBox+" > input[type='text']");l[0]&&l[0].blur()}else"ArrowUp"===l.key||"Tab"===l.key&&l.shiftKey?(l.preventDefault(),i?d("prev"):h("prev")):"Enter"===l.key?(l.preventDefault(),i?o():n(l.shiftKey,l.ctrlKey||l.metaKey)):"Escape"===l.key||"Esc"===l.key?(l.preventDefault(),s?t.helper.dragndrop.cancel():i?t.helper.contextmenu.close():t.helper.toggle.closeSidebar()):"Delete"===l.key&&t.helper.selection.isEnabled()?(l.preventDefault(),p(),t.helper.selection.deleteSelected()):"Delete"===l.key&&r.length()>0&&r[0]!==t.elm.iframe[0].contentDocument.activeElement?(l.preventDefault(),p()):"f"!==l.key||!l.ctrlKey&&!l.metaKey||l.ctrlKey===l.metaKey||l.shiftKey?"c"===l.key&&(l.ctrlKey||l.metaKey)?(l.preventDefault(),m()):"Shift"!==l.key&&"Control"!==l.key&&"Command"!==l.key&&r.length()>0&&r[0]!==t.elm.iframe[0].contentDocument.activeElement&&r[0].focus():(l.preventDefault(),t.helper.search.showSearchField())}})).on("keyup.bs",(()=>{if(a()){const l=t.elm.header.find("div."+e.cl.sidebar.searchBox+" > input[type='text']");if(l&&l.length()>0){l[0].value.length>0&&!t.elm.header.hasClass(e.cl.sidebar.searchVisible)&&(t.helper.contextmenu.close(),t.helper.tooltip.close(),t.elm.header.addClass(e.cl.sidebar.searchVisible))}}}))},i=l=>{const a=l.find("menu["+e.attr.name+"='select'] > a."+e.cl.hover);a.length()>0?a.trigger("click"):t.helper.overlay.performAction()},o=()=>{const l=t.elm.sidebar.find("div."+e.cl.contextmenu.wrapper).find("a."+e.cl.hover);l.length()>0&&l.trigger("click")},n=(l,a)=>{const r=t.helper.list.getActiveBookmarkBox().find("ul > li > a."+e.cl.hover+", ul > li > a."+e.cl.sidebar.mark);if(r.length()>0)if(l){let l="list";r.hasClass(e.cl.sidebar.separator)&&(l="separator"),t.helper.contextmenu.create(l,r)}else t.helper.sidebarEvents.handleEntryClick(r,{ctrlKey:a})},s=t=>{const l=t.find("menu["+e.attr.name+"='select'] > a."+e.cl.hover),a=t[0].contentDocument;if(l.length()>0){let a=null;a=l.next("a").length()>0?l.next("a"):t.find("menu["+e.attr.name+"='select'] > a").eq(0),t.find("menu["+e.attr.name+"='select'] > a."+e.cl.hover).removeClass(e.cl.hover),a.addClass(e.cl.hover)}else if("INPUT"===a.activeElement.tagName){const l=e(a.activeElement).parent("li");let r=null;r=l.length()>0&&l.next("li").length()>0?l.next("li").find("input,text,area,select").eq(0):t.find("input,text,area,select").eq(0),r&&r.length()>0&&r[0].focus()}else t.find("input").length()>0?t.find("input")[0].focus():t.find("menu["+e.attr.name+"='select']").length()>0&&t.find("menu["+e.attr.name+"='select'] > a").eq(0).addClass(e.cl.hover)},d=l=>{const a=t.elm.sidebar.find("div."+e.cl.contextmenu.wrapper);let r=null;a.find("a."+e.cl.hover).length()>0&&(r=a.find("a."+e.cl.hover).eq(0));let i=a.find("a").eq(0);null!==r&&("next"===l?r.parent("li").next("li").length()>0?i=r.parent("li").next("li").children("a"):r.parents("ul").eq(0).next("ul").length()>0&&(i=r.parents("ul").eq(0).next("ul").find("> li > a").eq(0)):"prev"===l&&(r.parent("li").prev("li").length()>0?i=r.parent("li").prev("li").children("a"):r.parents("ul").eq(0).prev("ul").length()>0&&(i=r.parents("ul").eq(0).prev("ul").find("> li > a").eq(-1)))),a.find("a."+e.cl.hover).removeClass(e.cl.hover),i.addClass(e.cl.hover)},c=()=>{const l=t.helper.list.getActiveBookmarkBox(),a=t.helper.scroll.getScrollPos(l);l.find("ul > li").forEach((t=>{if(t.offsetTop>a+50)return l.find("ul > li > a."+e.cl.hover).removeClass(e.cl.hover),l.find("ul > li > a."+e.cl.sidebar.mark).removeClass(e.cl.sidebar.mark),e(t).children("a").addClass([e.cl.hover,e.cl.sidebar.lastHover]),!1}))},h=l=>{const a=t.helper.list.getActiveBookmarkBox(),r=t.helper.scroll.getScrollPos(a);let i=null;if(a.find("ul > li > a."+e.cl.sidebar.mark).length()>0?i=a.find("ul > li > a."+e.cl.sidebar.mark).eq(0).parent("li"):a.find("ul > li > a."+e.cl.hover).length()>0?i=a.find("ul > li > a."+e.cl.hover).eq(0).parent("li"):a.find("ul > li > a."+e.cl.sidebar.lastHover).length()>0?i=a.find("ul > li > a."+e.cl.sidebar.lastHover).eq(0).parent("li"):a.find("ul > li").forEach((t=>{if(t.offsetTop>=r)return i=e(t),!1})),i){const o=i.children("a");let n=null;if(o.hasClass(e.cl.hover)||o.hasClass(e.cl.sidebar.mark)?"prev"===l?n=(t=>{let l=null;if(t.prev("li").length()>0){let a=t.prev("li").children("a");for(;a.hasClass(e.cl.sidebar.dirOpened)&&a.next("ul").length()>0&&a.next("ul").children("li").length()>0;)a=a.next("ul").find("> li:last-child > a");l=a}else{const e=t.parents("li").eq(0);e.length()>0&&(l=e.children("a"))}return l})(i):"next"===l&&(n=(t=>{const l=t.children("a");let a=null;if(l.hasClass(e.cl.sidebar.dirOpened)&&l.next("ul").length()>0&&l.next("ul").children("li").length()>0)a=l.next("ul").find("> li:first-child > a");else if(t.next("li").length()>0)a=t.next("li").children("a");else{let e=!1,l=0;for(;!1===e;){const r=t.parents("li").eq(l);r.length()>0?r.next("li").length()>0?(a=r.next("li").children("a"),e=!0):l++:e=!0}}return a})(i)):n=o,n&&n[0]){a.find("ul > li > a."+e.cl.hover).removeClass(e.cl.hover),a.find("ul > li > a."+e.cl.sidebar.mark).removeClass(e.cl.sidebar.mark),n.addClass([e.cl.hover,e.cl.sidebar.lastHover]);const l=n[0].offsetTop-r,i=window.innerHeight-l,o=150+t.elm.pinnedBox[0].offsetHeight;l<0?t.helper.scroll.setScrollPos(a,n[0].offsetTop):i<o&&t.helper.scroll.setScrollPos(a,r+(o-i))}}},p=()=>{if(!l){l=!0;const a=t.helper.list.getActiveBookmarkBox().find("> ul a."+e.cl.hover).eq(0);a.length()>0&&0===a.children("span."+e.cl.sidebar.removeMask).length()&&t.helper.bookmark.removeEntry(a.attr(e.attr.id)).then((()=>{l=!1}))}},m=()=>{const l=t.helper.list.getActiveBookmarkBox().find("> ul a."+e.cl.hover).eq(0);if(l.length()>0){const a=t.helper.entry.getDataById(l.attr(e.attr.id));if(a&&a.url&&t.helper.utility.copyToClipboard(a.url)){e(l).children("span."+e.cl.sidebar.copied).remove();const a=e("<span></span>").addClass(e.cl.sidebar.copied).text(t.helper.i18n.get("sidebar_copied_to_clipboard")).appendTo(l);e.delay(100).then((()=>(e(l).addClass(e.cl.sidebar.copied),e.delay(1500)))).then((()=>(e(l).removeClass(e.cl.sidebar.copied),e.delay(500)))).then((()=>{a.remove()}))}}}},e.Linkchecker=function(t){const l={};let a=!1;this.run=(e,a)=>{l.modal=e,l.body=e.parents("body"),"default"!==t.helper.model.getUserType()?i(a):r()};const r=()=>{const a=e("<p></p>").addClass(e.cl.premium).html("<span>"+t.helper.i18n.get("premium_restricted_text")+"</span>").appendTo(l.modal);e("<a></a>").text(t.helper.i18n.get("more_link")).appendTo(a).on("click",(l=>{l.preventDefault(),t.helper.model.call("openLink",{href:e.api.extension.getURL("html/settings.html#premium"),newTab:!0})})),t.helper.overlay.setCloseButtonLabel("close")},i=a=>{l.buttonWrapper=l.modal.find("menu."+e.cl.overlay.buttonWrapper),l.loader=t.helper.template.loading().appendTo(l.modal),l.desc=e("<p></p>").text(t.helper.i18n.get("overlay_check_bookmarks_loading")).appendTo(l.modal);const r=v(a);l.progressBar=e("<div></div>").addClass(e.cl.overlay.progressBar).html("<div></div>").appendTo(l.modal),l.progressLabel=e("<span></span>").addClass(e.cl.overlay.checkUrlProgressLabel).html("<span>0</span>/<span>"+r.bookmarks.length.toLocaleString()+"</span>").appendTo(l.modal),e.delay(200).then((()=>{l.modal.addClass(e.cl.overlay.urlCheckLoading)})),c();const i={count:0,changed:[],broken:[],duplicate:[],empty:[]};f(r.directories,i).then((()=>b(r.bookmarks,i))).then((()=>{o(i)}))},o=a=>{const r=a.count>0;delete a.count,l.desc.remove(),l.progressBar.remove(),l.progressLabel.remove(),r&&l.modal.addClass(e.cl.overlay.urlCheckResults),e.delay(r?500:0).then((()=>{if(l.loader.remove(),l.modal.removeClass(e.cl.overlay.urlCheckLoading),t.helper.overlay.setCloseButtonLabel("close"),!1===r)g();else{l.menu=e("<menu></menu>").addClass(e.cl.overlay.urlCheckCategories).appendTo(l.modal),l.results={},l.actions={};let r=null;Object.entries(a).forEach((([a,i])=>{const o=e("<li></li>").html("<a>"+t.helper.i18n.get("overlay_check_bookmarks_menu_"+a)+"<span></span></a>").attr(e.attr.name,a).appendTo(l.menu);if(i.length>0&&null===r&&(r=o.children("a")),"duplicate"!==a){let r="overlay_check_bookmarks_update";"broken"!==a&&"empty"!==a||(r="overlay_check_bookmarks_remove"),l.actions[a]=e("<a></a>").addClass(e.cl.overlay.urlCheckAction).attr(e.attr.name,a).text(t.helper.i18n.get(r+"_selected")).appendTo(l.buttonWrapper)}l.results[a]=t.helper.scroll.add(e.opts.ids.overlay.urlCheckResult+"_"+a,e("<ul></ul>").appendTo(l.modal)),i.forEach((t=>{const r=e("<li></li>").data("entry",t).appendTo(l.results[a].children("ul"));switch(a){case"broken":case"changed":d(t,r);break;case"duplicate":s(t,r);break;case"empty":n(t,r)}}))})),u(),h(),r&&r.trigger("click")}}))},n=(a,r)=>{const i=t.helper.entry.getParentsById(a.id);if(i.length>0){t.helper.checkbox.get(l.body,{checked:"checked"}).appendTo(r);const o=e("<ul></ul>").addClass(e.cl.sidebar.breadcrumb).appendTo(r);i.forEach((t=>{e("<li></li>").text(t.title).prependTo(o)})),e("<li></li>").text(a.title).appendTo(o)}else r.remove();e("<a></a>").addClass(e.cl.overlay.urlCheckAction).appendTo(r)},s=(l,a)=>{const r=e("<a></a>").addClass(e.cl.info).attr({href:l.url,title:l.label,target:"_blank"}).html(l.label).appendTo(a),i=e("<ul></ul>").attr(e.attr.type,"duplicates").appendTo(a);l.duplicates.forEach((l=>{l.duplicate=!0;const a=e("<li></li>").data("entry",l).appendTo(i);e("<strong></strong>").html(l.title).appendTo(a);const r=t.helper.entry.getParentsById(l.id);if(r.length>0){const t=e("<ul></ul>").addClass(e.cl.sidebar.breadcrumb).appendTo(a);r.forEach((l=>{e("<li></li>").text(l.title).prependTo(t)}))}e("<a></a>").addClass(e.cl.overlay.urlCheckAction).appendTo(a)})),t.helper.model.call("favicon",{url:l.url}).then((t=>{t.img&&e("<img src='"+t.img+"' />").insertBefore(r)}))},d=(a,r)=>{t.helper.checkbox.get(l.body,{checked:"checked"}).appendTo(r),e("<strong></strong>").text(a.title).appendTo(r);const i=e("<ul></ul>").attr(e.attr.type,"urls").appendTo(r);["url","newUrl"].forEach((t=>{if(a[t]){const l=e("<li></li>").appendTo(i);e("<a></a>").attr({href:a[t],title:a[t],target:"_blank"}).html(a[t]).appendTo(l)}})),e("<a></a>").addClass(e.cl.overlay.urlCheckAction).appendTo(r),t.helper.model.call("favicon",{url:a.url}).then((t=>{t.img&&e("<img src='"+t.img+"' />").insertAfter(r.children("div."+e.cl.checkbox.box))}))},c=()=>{e(document).on(e.opts.events.overlayClosed,(()=>{a&&(a=!1,t.helper.model.call("reload",{type:"Update"}))}))},h=()=>{l.menu.find("a").on("click",(t=>{t.preventDefault();const a=e(t.currentTarget).parent("li"),r=a.attr(e.attr.name);l.results&&l.results[r]&&(l.menu.children("li").removeClass(e.cl.active),a.addClass(e.cl.active),["results","actions"].forEach((t=>{l[t]&&Object.entries(l[t]).forEach((([t,l])=>{r===t?l.addClass(e.cl.visible):l.removeClass(e.cl.visible)}))})))})),Object.entries(l.results).forEach((([t,l])=>{l.find("a."+e.cl.overlay.urlCheckAction).on("click",(t=>{t.preventDefault();const l=e(t.currentTarget).parent("li"),a=e(t.currentTarget).parent("li").data("entry");l.css("height",l[0].offsetHeight+"px"),e.delay().then((()=>(l.addClass(e.cl.hidden),m(a),e.delay(500)))).then((()=>{l.remove(),u()}))}))})),l.buttonWrapper.find("a."+e.cl.overlay.urlCheckAction).on("click",(t=>{t.preventDefault();const a=e(t.currentTarget).attr(e.attr.name);if(l.results&&l.results[a]){const t=[];l.results[a].find("> ul > li").forEach((l=>{e(l).find("input[type='checkbox']")[0].checked&&(t.push(e(l).data("entry")),e(l).remove())})),p(t).then((()=>{u()}))}}))},p=async e=>{for(const t of e)await m(t)},m=e=>new Promise((l=>{if(a=!0,e.broken||e.duplicate||e.children&&0===e.children.length)t.helper.bookmark.performDeletion(e.id,!0).then(l);else if(e.url!==e.newUrl){const a=e.additionalInfo&&e.additionalInfo.desc?e.additionalInfo.desc:null;t.helper.bookmark.editEntry({id:e.id,title:e.title,url:e.newUrl,additionalInfo:a}).then(l)}else l()})),u=()=>{let a=!0;Object.entries(l.results).forEach((([r,i])=>{let o=i.find("> ul > li").length();"duplicate"===r&&i.find("> ul > li").forEach((t=>{const l=e(t).find("> ul > li").length();0===l?(e(t).remove(),o--):1===l&&o--})),l.menu.find("li["+e.attr.name+"='"+r+"'] > a > span").text("("+o+")"),0===o?(i.children("ul,p").remove(),e("<p></p>").html("<span>"+t.helper.i18n.get("overlay_check_bookmarks_no_results_"+r)+"</span>").appendTo(i),l.actions&&l.actions[r]&&l.actions[r].remove()):a=!1})),a&&g()},g=()=>{l.modal.addClass(e.cl.overlay.urlCheckLoading),e.delay().then((()=>(l.modal.removeClass(e.cl.overlay.urlCheckResults),l.modal.find("menu."+e.cl.overlay.urlCheckCategories).remove(),["results","actions"].forEach((e=>{l[e]&&Object.values(l[e]).forEach((e=>{e.remove()}))})),e("<p></p>").addClass(e.cl.success).text(t.helper.i18n.get("overlay_check_bookmarks_no_results")).appendTo(l.modal),e.delay(500)))).then((()=>{l.modal.removeClass(e.cl.overlay.urlCheckLoading)}))},f=async(e,t)=>{e.forEach((e=>{0===e.children.length&&(t.empty.push(e),t.count++)}))},b=(a,r)=>new Promise((i=>{let o=0;const n=[],s=a.length,d=e=>new Promise((a=>{let i=0;for(const d of e){let c=!1;const h=()=>{c||(c=!0,o++,i++,l.progressBar.children("div").css("width",o/s*100+"%"),l.progressLabel.children("span").eq(0).text(o.toLocaleString()),i>=e.length&&a())},p=setTimeout(h,1e4);t.helper.model.call("checkUrl",{url:d.url}).then((e=>{clearTimeout(p),e.duplicateInfo.duplicates.length>0&&-1===n.indexOf(e.duplicateInfo.label)&&(r.duplicate.push({label:e.duplicateInfo.label,url:d.url,duplicates:e.duplicateInfo.duplicates}),n.push(e.duplicateInfo.label),r.count++),!1===e.httpInfo.success?(r.broken.push({id:d.id,title:d.title,url:d.url,broken:!0}),r.count++):e.httpInfo.url!==d.url&&(r.changed.push({id:d.id,title:d.title,url:d.url,newUrl:e.httpInfo.url,additionalInfo:d.additionalInfo}),r.count++)})).finally(h)}}));(async()=>{let t=0,l=[];for(const e of a)t++,l.push(e),(Object.keys(l).length>=5||t===a.length)&&(await d(l),l=[]);e.delay(500).then((()=>{i(r)}))})()})),v=e=>{const l={bookmarks:[],directories:[]},a=e=>{e.forEach((e=>{e.url&&!1===t.helper.utility.isUrlOnBlacklist(e.url)?l.bookmarks.push(e):e.children&&(l.directories.push(e),a(e.children))}))};return a(e),l}},e.ListHelper=function(t){let l=0,a={},r=0;this.init=async()=>{t.elm.bookmarkBox.all.addClass(e.cl.active),Object.values(t.elm.bookmarkBox).forEach((l=>{l.on(e.opts.events.scrollBoxLastPart,(()=>{const a=l.children("ul"),r=a.data("remainingEntries");r&&r.length>0&&(this.addBookmarkDir(r,a,!1,!1),(t.refreshRun||!1===t.elm.iframe.hasClass(e.cl.page.visible))&&t.helper.scroll.restoreScrollPos(l))}))}));const l=t.helper.model.getData("b/dirOpenDuration");r=1e3*+l,this.updateBookmarkBox()},this.getSort=()=>a,this.updateSort=(e,l)=>{const r=t.helper.utility.getSortList();r[e]&&(void 0===l&&(l=r[e].dir),a={name:e,dir:"ASC"===l?"ASC":"DESC"},t.startLoading(),Promise.all([t.helper.model.call("removeCache",{name:"htmlList"}),t.helper.model.call("removeCache",{name:"htmlPinnedEntries"}),t.helper.model.setData({"u/sort":a})]).then((()=>{t.helper.model.call("reload",{scrollTop:!0,type:"Sort"})})))},this.updateDirection=e=>{this.updateSort(a.name,e)},this.updateBookmarkBox=()=>new Promise((l=>{t.startLoading(),a=t.helper.model.getData("u/sort"),t.elm.sidebar.attr(e.attr.sort,a.name),t.elm.bookmarkBox.all.children("a["+e.attr.name+"='add']").remove();const r=t.elm.bookmarkBox.all.children("ul");let i;t.updateBookmarkBoxStart=+new Date,i=t.helper.model.getData("u/viewAsTree")||"custom"===a.name?Promise.all([t.helper.model.call("getCache",{name:"htmlList"}),t.helper.model.call("getCache",{name:"htmlPinnedEntries"})]):new Promise((e=>{e()})),t.helper.scroll.focus(),i.then((l=>l&&l[0]&&l[0].val?(l[1]&&l[1].val?(t.elm.pinnedBox.html(l[1].val),t.helper.model.getData("u/lockPinned")&&(t.elm.lockPinned.addClass(e.cl.sidebar.fixed),t.elm.pinnedBox.addClass(e.cl.sidebar.fixed)),o(t.elm.pinnedBox),s(t.elm.pinnedBox)):t.elm.pinnedBox.addClass(e.cl.hidden),p(r,l[0].val)):m(r))).then((()=>{l()}))})),this.toggleBookmarkDir=(l,a,i=!0)=>new Promise((o=>{l.addClass(e.cl.sidebar.dirAnimated);const n=l.attr(e.attr.id);let s=l.next("ul");const d=s.length()>0,h=!0===t.refreshRun||!1===t.elm.iframe.hasClass(e.cl.page.visible),p=l.hasClass(e.cl.sidebar.dirOpened)&&d,m=t.helper.model.getData("b/rememberState");void 0===a&&(a=h||!1===t.helper.model.getData("b/animations"));const u=()=>{!1===h&&!1===p&&!0===t.helper.model.getData("b/rememberOpenStatesSubDirectories")&&this.restoreOpenStates(s);let a=i&&!h&&!t.helper.search.isResultsVisible();("nothing"===m||"openStatesRoot"===m&&1!==l.parents("ul:not(."+e.cl.sidebar.hideRoot+")").length())&&(a=!1),a?this.cacheList().then(o):o()};if(p)c(l,s,!1,a).then(u);else{if(t.helper.model.getData("b/dirAccordion")&&!0===i){const i=t.helper.search.isResultsVisible()?"search":"all";e([t.elm.bookmarkBox[i].find("a."+e.cl.sidebar.dirOpened),t.elm.bookmarkBox[i].find("a."+e.cl.sidebar.dirAnimated+":not("+e.cl.sidebar.dirOpened+")")]).forEach((t=>{if(t!==l[0]&&0===e(t).next("ul").find("a["+e.attr.id+"='"+n+"']").length()){let l=0;e(t).hasClass(e.cl.sidebar.dirAnimated)&&(l=r),e.delay(a?0:l).then((()=>{e(t).addClass(e.cl.sidebar.dirOpened),this.toggleBookmarkDir(e(t),a,!1).then(u)}))}}))}d?c(l,s,!0,a).then(u):t.helper.model.call("bookmarks",{id:n}).then((t=>{t.bookmarks&&t.bookmarks[0]&&t.bookmarks[0].children&&(s=e("<ul></ul>").insertAfter(l),this.addBookmarkDir(t.bookmarks[0].children,s),c(l,s,!0,a).then(u))}))}})),this.cacheList=()=>(t.log("Cache sidebar html"),Promise.all([t.helper.model.call("setCache",{name:"htmlList",val:t.elm.bookmarkBox.all.children("ul").html()}),t.helper.model.call("setCache",{name:"htmlPinnedEntries",val:t.elm.pinnedBox.html()})])),this.getActiveBookmarkBox=()=>{let l=null;return Object.values(t.elm.bookmarkBox).some((t=>{if(t.hasClass(e.cl.active))return l=t,!0})),l},this.handleSidebarWidthChange=()=>{const l=t.elm.header.children("a"),a=t.elm.header.children("h1");a.removeClass(e.cl.hidden),a.children("span").removeClass(e.cl.hidden),["label","amount"].forEach((t=>{let r=null;l.forEach((l=>{if(null===r)r=l.offsetTop;else if(l.offsetTop>2*r||0===a[0].offsetTop)return"label"===t?a.children("span").addClass(e.cl.hidden):"amount"===t&&a.addClass(e.cl.hidden),!1}))})),t.helper.selection.isEnabled()&&t.helper.selection.handleSidebarWidthChange()},this.updateSidebarHeader=()=>{if(t.helper.selection.isEnabled())return void t.helper.selection.updateSidebarHeader();let l="";const a=t.elm.header.find("div."+e.cl.sidebar.searchBox+" > input[type='text']");a.length()>0&&a[0]&&a[0].value&&(l=a[0].value),t.elm.header.text("");const r=t.helper.entry.getAmount("bookmarks");e("<h1></h1>").html("<strong>"+r+"</strong> <span>"+t.helper.i18n.get("header_bookmarks"+(1===r?"_single":""))+"</span>").attr("title",r+" "+t.helper.i18n.get("header_bookmarks"+(1===r?"_single":""),null,!0)).appendTo(t.elm.header),e("<a></a>").addClass(e.cl.sidebar.search).appendTo(t.elm.header),e("<a></a>").addClass(e.cl.sidebar.sort).appendTo(t.elm.header),e("<a></a>").addClass(e.cl.sidebar.menu).appendTo(t.elm.header),this.handleSidebarWidthChange(),e("<div></div>").addClass(e.cl.sidebar.searchBox).append("<input type='text' value='"+l.replace(/'/g,"&#x27;")+"' placeholder='"+t.helper.i18n.get("sidebar_search_placeholder",null,!0)+"' />").append("<a class='"+e.cl.sidebar.searchClose+"'></a>").appendTo(t.elm.header)},this.restoreOpenStates=(a,r=!1)=>{let i=!1;const o=t.helper.model.getData(["b/rememberState","u/openStates"]),n=()=>{!i&&r&&0===l&&e.delay(100).then((()=>{u()}))};"all"!==o.rememberState&&"openStatesAndPos"!==o.rememberState&&"openStates"!==o.rememberState&&"openStatesRoot"!==o.rememberState||Object.entries(o.openStates).forEach((([t,s])=>{if(!0===s){const s=a.find("> li > a."+e.cl.sidebar.bookmarkDir+"["+e.attr.id+"='"+t+"']:not(."+e.cl.sidebar.dirOpened+")");s.length()>0&&("openStatesRoot"===o.rememberState&&1!==s.parents("ul").length()&&!1!==r||(i=!0,l++,this.toggleBookmarkDir(s).then((()=>{l--,i=!1,n()}))))}})),n()},this.updateSortFilter=()=>{t.elm.filterBox.removeClass(e.cl.hidden).text("");let l=0;if("custom"===a.name)t.elm.filterBox.addClass(e.cl.hidden);else{const r=t.helper.model.getData(["u/viewAsTree","u/mostViewedPerMonth"]),i=a.name.replace(/([A-Z])/g,"_$1").toLowerCase();e("<a></a>").attr(e.attr.direction,a.dir).text(t.helper.i18n.get("sort_label_"+i)).appendTo(t.elm.filterBox);const o=e("<ul></ul>").appendTo(t.elm.filterBox);!1===t.helper.search.isResultsVisible()&&e("<li></li>").append(t.helper.checkbox.get(t.elm.iframeBody,{[e.attr.name]:"viewAsTree",checked:r.viewAsTree?"checked":""})).append("<a>"+t.helper.i18n.get("sort_view_as_tree")+"</a>").appendTo(o),"mostUsed"===a.name&&e("<li></li>").append(t.helper.checkbox.get(t.elm.iframeBody,{[e.attr.name]:"mostViewedPerMonth",checked:r.mostViewedPerMonth?"checked":""})).append("<a>"+t.helper.i18n.get("sort_most_used_per_month")+"</a>").appendTo(o),0===o.children("li").length()&&o.remove(),l=t.elm.filterBox.realHeight()}Object.values(t.elm.bookmarkBox).forEach((e=>{e.css("padding-top",l)})),t.elm.pinnedBox.css("top",t.helper.model.getData("u/lockPinned")?-l:0)},this.addBookmarkDir=(l,o,s=!0,d=!0)=>{let c=!1;const h=s&&"custom"===a.name&&o.prev("a").length()>0,p=t.helper.model.getData(["a/directoryArrows","a/showBookmarkIcons","a/showDirectoryIcons","u/showHidden"]);0===o.parents("li").length()?!1===t.helper.search.isResultsVisible()&&i(p):o.css("transition","height "+r+"ms");let m=0;return o.removeData("remainingEntries"),d&&t.helper.utility.sortEntries(l,a),l.some(((a,r)=>{if((p.showHidden||t.helper.entry.isVisible(a.id))&&(a.children||a.url)&&(e.opts.demoMode&&(a.children?a.title="Directory "+(r+1):(a.title="Bookmark "+(r+1),a.url="https://example.com/")),(!1===t.helper.entry.isSeparator(a.id)||h)&&n(a,o,{config:p,asTree:s}),a.url&&m++,c=!0,!1===s&&m>=100)){const e=l.slice(r+1);return e.length>0&&o.data("remainingEntries",e),!0}})),c};const i=l=>{t.elm.lockPinned.removeClass(e.cl.sidebar.fixed),t.elm.pinnedBox.removeClass([e.cl.hidden,e.cl.sidebar.fixed]),t.elm.pinnedBox.children("ul").remove();const r=t.helper.entry.getAllDataByType("pinned");if(0===r.length)t.elm.pinnedBox.addClass(e.cl.hidden);else{t.helper.utility.sortEntries(r,a);const i=e("<ul></ul>").appendTo(t.elm.pinnedBox);t.helper.model.getData("u/lockPinned")&&(t.elm.lockPinned.addClass(e.cl.sidebar.fixed),t.elm.pinnedBox.addClass(e.cl.sidebar.fixed)),r.forEach((e=>{(l.showHidden||t.helper.entry.isVisible(e.id))&&n(e,i,{config:l,asTree:!1,pinnedBox:!0})}))}},o=t=>{t.find("div."+e.cl.checkbox.box).removeClass(e.cl.active),t.find("a."+e.cl.sidebar.mark).removeClass(e.cl.sidebar.mark),t.find("a."+e.cl.hover).removeClass(e.cl.hover),t.find("a."+e.cl.selected).removeClass(e.cl.selected),t.find("a."+e.cl.drag.dragHover).removeClass(e.cl.drag.dragHover),t.find("a."+e.cl.sidebar.lastHover).removeClass(e.cl.sidebar.lastHover),t.find("li."+e.cl.drag.dragInitial).removeClass(e.cl.drag.dragInitial),t.find("li."+e.cl.drag.isDragged).remove()},n=(l,a,r)=>{const i=e("<li></li>").appendTo(a),o=l.title&&l.title.trim().length?l.title:"",n=e("<a></a>").appendTo(i),s=e("<span></span>").addClass(e.cl.sidebar.bookmarkLabel).text(o.trim()).appendTo(n);if(e("<span></span>").addClass(e.cl.drag.trigger).appendTo(n),l.id&&n.attr(e.attr.id,l.id),!1===t.helper.entry.isVisible(l.id)&&i.addClass(e.cl.hidden),t.helper.entry.isSeparator(l.id)){n.addClass(e.cl.sidebar.separator);const t=l.title.replace(/(^[-_]+|[-_]+$)/g,"").trim();t.length>0&&s.attr(e.attr.name,t),s.text("")}else l.children?(n.addClass(e.cl.sidebar.bookmarkDir),r.config.showDirectoryIcons&&n.prepend("<span class='"+e.cl.sidebar.dirIcon+"'></span>"),r.config.directoryArrows&&n.addClass(e.cl.sidebar.dirArrow)):l.url&&(n.addClass(e.cl.sidebar.bookmarkLink),r.config.showBookmarkIcons&&(e.opts.demoMode?n.prepend("<span class='"+e.cl.sidebar.dirIcon+"' data-color='"+(Math.floor(10*Math.random())+1)+"'></span>"):d(n,l.url)));return r.pinnedBox||t.helper.checkbox.get(t.elm.iframeBody,{[e.attr.name]:"select"}).prependTo(n),i},s=(l,a=!1)=>new Promise((r=>{const i=[];l.find("a."+e.cl.sidebar.bookmarkLink+" > img["+e.attr.value+"]").forEach((t=>{const l=e(t).parent("a"),a=e(t).attr(e.attr.value);i.push(d(l,a))})),i.length>0?(t.log("Detected: Missing bookmark favicons"),Promise.all(i).then((()=>{a?this.cacheList().then(r):r()}))):r()})),d=(l,a)=>{l.children("img").remove();const r=e("<img />").prependTo(l);return r.attr(e.attr.value,a),new Promise((l=>{t.helper.model.call("favicon",{url:a}).then((a=>{if(a.img){const l=t.elm.iframe.hasClass(e.cl.page.visible);r.attr(l?"src":e.attr.src,a.img)}r.removeAttr(e.attr.value),l()}))}))},c=(l,a,i,o)=>new Promise((n=>{if(a.css("height",a[0].scrollHeight+"px"),!1===i&&e.delay(50).then((()=>{a.css("height",0)})),!0===t.refreshRun)this.restoreOpenStates(a,!0);else{const a=t.helper.model.getData("u/openStates");a[l.attr(e.attr.id)]=i,!1===i&&!1===t.helper.model.getData("b/rememberOpenStatesSubDirectories")?h(l,a):!1===t.helper.search.isResultsVisible()&&t.helper.model.setData({"u/openStates":a})}e.delay(o?20:r).then((()=>{if(!1===i)l.removeClass(e.cl.sidebar.dirOpened);else if(l.addClass(e.cl.sidebar.dirOpened),t.helper.model.getData("b/dirAccordion")&&!1===t.refreshRun){const e=t.helper.search.isResultsVisible()?"search":"all";t.helper.scroll.getScrollPos(t.elm.bookmarkBox[e])>l[0].offsetTop&&t.helper.scroll.setScrollPos(t.elm.bookmarkBox[e],l[0].offsetTop,300)}a.css("height",""),l.removeClass(e.cl.sidebar.dirAnimated),n()}))})),h=(l,a)=>{l.next("ul").find("a."+e.cl.sidebar.bookmarkDir).forEach((t=>{a[e(t).attr(e.attr.id)]=!1,e.delay(500).then((()=>{e(t).removeClass(e.cl.sidebar.dirOpened)}))})),!1===t.helper.search.isResultsVisible()&&t.helper.model.setData({"u/openStates":a})},p=(l,a)=>new Promise((r=>{t.log("Load html from cache"),l.html(a),o(l),l.find("div."+e.cl.checkbox.box).forEach((l=>{t.helper.checkbox.initEvents(e(l),t.elm.iframeBody)})),s(l,!0),t.elm.bookmarkBox.all.addClass(e.cl.sidebar.cached),this.updateSidebarHeader(),this.updateSortFilter(),1===l.children("li").length()&&(l.addClass(e.cl.sidebar.hideRoot),e("<a></a>").attr(e.attr.name,"add").insertAfter(l)),e.delay(100).then((()=>{u(),r()}))})),m=l=>new Promise((r=>{t.log("Load html from object");let i=[];const o=t.helper.model.getData("u/viewAsTree");t.elm.bookmarkBox.all.removeClass(e.cl.sidebar.cached),t.helper.model.call("bookmarks",{id:0}).then((a=>(t.refreshRun=!0,l.removeClass(e.cl.sidebar.hideRoot).text(""),a.bookmarks&&a.bookmarks[0]&&a.bookmarks[0].children&&(i=a.bookmarks[0].children),t.helper.entry.init(i)))).then((()=>{this.updateSidebarHeader(),o||"custom"===a.name?(this.addBookmarkDir(i,l,!0),1===l.children("li").length()?(l.addClass(e.cl.sidebar.hideRoot),e("<a></a>").attr(e.attr.name,"add").insertAfter(l),this.toggleBookmarkDir(l.find("> li > a."+e.cl.sidebar.bookmarkDir).eq(0))):this.restoreOpenStates(l,!0)):(this.addBookmarkDir(t.helper.entry.getAllDataByType("bookmarks"),l,!1),u()),this.updateSortFilter(),r()}))})),u=()=>{t.helper.scroll.restoreScrollPos(t.elm.bookmarkBox.all).then((()=>{t.initImages(),t.endLoading(200),t.refreshRun=!1,!t.helper.model.getData("u/viewAsTree")&&"custom"!==a.name||t.elm.bookmarkBox.all.hasClass(e.cl.sidebar.cached)||this.cacheList(),t.loaded()}))}},e.ModelHelper=function(t){const l={default:{textColor:{light:"#646464",dark:"#c8c8c8"},sidebarMaskColor:{light:"rgba(255, 255, 255, 0.8)",dark:"rgba(0, 0, 0, 0.6)"},hoverColor:{light:"#f5f5f5",dark:"#555555"},colorScheme:{light:"#1b82f1",dark:"#1f4d80"},foregroundColor:{light:"#ffffff",dark:"#333333"},icon:{forLight:"#555555",forDark:"#ffffff"}},glass:{sidebarMaskColor:{light:"rgba(0, 0, 0, 0)",dark:"rgba(0, 0, 0, 0)"},overlayMaskColor:{light:"rgba(255, 255, 255, 0.5)",dark:"rgba(0, 0, 0, 0.3)"},textColor:{light:"#444444",dark:"#dfdfdf"},hoverColor:{light:"rgba(0, 0, 0, 0.05)",dark:"rgba(255, 255, 255, 0.1)"}}},a={u:{openStates:{},hiddenEntries:{},additionalInfo:{},scrollPos:0,separators:{},customCss:"",pinnedEntries:{},lockPinned:!0,translationHelp:!0,translationThanked:!1,performReopening:!1,entryAmounts:{},lastOpened:null,sort:{name:"custom",dir:"ASC"},mostViewedPerMonth:!1,viewAsTree:!0},b:{animations:!0,preventPageScroll:!1,toggleArea:{width:2,widthWindowed:20,height:100,top:0},blacklist:[],whitelist:[],sidebarPosition:"left",openAction:"mousedown",newTab:"foreground",newTabPosition:"afterCurrent",visibility:"always",linkAction:"current",dirAccordion:!1,reopenSidebar:!1,preventWindowed:!1,preventWebapp:!0,rememberState:"openStatesAndPos",rememberOpenStatesSubDirectories:!0,newEntryPosition:"append",tooltipDelay:.5,tooltipContent:"all",tooltipAdditionalInfo:!0,dndCreationDialog:!1,closeOnTabChange:!0,openChildrenWarnLimit:10,dirOpenDuration:.4,scrollBarHide:1.5,openDelay:0,closeTimeout:1,dndOpenDirDelay:.5},a:{theme:"default",showIndicator:!0,showIndicatorIcon:!0,darkMode:!1,highContrast:!1,directoryArrows:!1,showBookmarkIcons:!0,showDirectoryIcons:!0,devModeIconBadge:!0,styles:{colorScheme:l.default.colorScheme.light,foregroundColor:l.default.foregroundColor.light,textColor:l.default.textColor.light,hoverColor:l.default.hoverColor.light,indicatorWidth:"24px",indicatorIconSize:"24px",indicatorIconColor:"#ffffff",indicatorColor:"rgba(0,0,0,0.5)",iconShape:"bookmark",iconColor:"auto",sidebarWidth:"350px",sidebarHeaderHeight:"50px",sidebarMaskColor:l.default.sidebarMaskColor.light,bookmarksFontSize:"14px",directoriesIconSize:"16px",bookmarksIconSize:"16px",bookmarksLineHeight:"38px",bookmarksDirIcon:"dir-1",bookmarksDirColor:l.default.textColor.light,bookmarksDirIndentation:"25px",bookmarksHorizontalPadding:"16px",scrollBarWidth:"11px",tooltipFontSize:"9px",overlayMaskColor:"rgba(0,0,0,0.5)",overlayHeaderHeight:"50px",fontFamily:"default",backgroundTransparency:.8,backgroundBlur:"7px"}},n:{override:!1,faviconShape:"new-1",faviconColor:"#646464",faviconBackground:"transparent",faviconPadding:10,autoOpen:!0,focusOmnibox:!1,searchField:"show",searchEngine:"google",searchEngineCustom:{title:"",homepage:"",queryUrl:""},gridType:"topPages",gridMaxCols:4,gridMaxRows:2,customGridLinks:[],topLinks:[],topLinksPosition:"right",website:""}};let r={},i=null,o=null;const n={};this.init=()=>new Promise((e=>{i=null,Promise.all([s(),d()]).then(e)}));const s=()=>new Promise((t=>{o&&o.disconnect(),o=e.api.runtime.connect(null,{name:"background"}),o.onMessage.addListener((e=>{n[e.uid]&&(n[e.uid](e.result),delete n[e.uid])})),t()})),d=()=>new Promise((t=>{const l=["utility","behaviour","appearance","newtab"],a={},o=l.length;let n=0;l.forEach((l=>{e.api.storage["utility"===l?"local":"sync"].get([l],(e=>{a[l]=e[l]||{},++n===o&&(r=a,null===i?this.call("userType").then((e=>{e&&e.userType&&(i=e.userType),t()})):t())}))}))})),c=e=>{switch(e){case"u":return"utility";case"b":return"behaviour";case"a":return"appearance";case"n":return"newtab"}return null};this.getUserType=()=>i,this.getAllData=()=>r,this.getDefaultData=()=>{const e={};return Object.entries(a).forEach((([t,l])=>{const a=c(t);a&&(e[a]=l)})),e},this.getDefaultColors=(e="default")=>Object.assign({},l.default,l[e]),this.getData=(e,l=!1)=>{let i=e;"string"==typeof i&&(i=[i]);let o={};if(i.forEach((e=>{const i=e.split("/")[0],n=e.split("/")[1];let s=null;const d=c(i);d&&r[d]&&(!0===l||void 0===r[d][n]?void 0!==a[i]&&void 0!==a[i][n]&&(s=a[i][n]):s=r[d][n]);const h=location.href.search(/chrome-extension:\/\//)>-1&&location.pathname.search(/settings\.html$/)>-1;if("b/toggleArea"===e&&matchMedia("(min-resolution: 1.25dppx)").matches&&!1===h&&(s=Object.assign({},s),Object.keys(s).forEach((e=>{e.startsWith("width")&&s[e]++}))),"a/styles"===e&&(s=Object.assign({},a.a.styles,s),t.helper.font&&t.helper.font.isLoaded())){const e=t.helper.font.getFontInfo(l?"default":"config");s.fontFamily=e.name,Object.assign(s,e.fontWeights)}o[n]=s})),"string"==typeof e){const t=e.split("/")[1];o=o[t]}return o},this.setData=t=>new Promise((l=>{d().then((()=>{Object.keys(t).forEach((e=>{const l=e.split("/")[0],a=e.split("/")[1],i=t[e];switch(l){case"u":r.utility[a]=i;break;case"b":r.behaviour[a]=i;break;case"a":r.appearance[a]=i;break;case"n":r.newtab[a]=i}}));let a=0;const i=(e=1)=>{a+=e,a>=4&&l()};try{e.api.storage.local.set({utility:r.utility},(()=>{e.api.runtime.lastError,i()})),e.api.storage.sync.set({behaviour:r.behaviour,appearance:r.appearance,newtab:r.newtab},(()=>{e.api.runtime.lastError,i(3)}))}catch(e){l()}}))})),this.call=(e,t={})=>new Promise((l=>{t.type=e,t.uid=e+"_"+JSON.stringify(t)+"_"+ +new Date+Math.random().toString(36).substr(2,12),n[t.uid]=e=>{l(e)},o.postMessage(t)}))},e.OverlayHelper=function(t){let l={};const a={tab:"&#8633;",shift:"&#8679;",cmd:"&#8984;",enter:"&#9166;"};this.create=(e,a,r)=>{switch(t.helper.tooltip.close(),l=t.helper.template.overlay(e,a),l.overlay.data("info",r||{}),this.setCloseButtonLabel("infos"===e?"close":"cancel"),e){case"delete":s(r);break;case"deleteSelected":n(r);break;case"edit":t.helper.entry.isSeparator(r.id)?d(r):c(r);break;case"infos":g(r);break;case"add":u(r);break;case"hide":m(r);break;case"openChildren":h(r);break;case"openSelected":p(r);break;case"checkBookmarks":t.helper.linkchecker.run(l.modal,r.children);break;case"keyboardShortcuts":o(r)}l.modal.find("input").length()>0&&l.modal.find("input")[0].focus(),t.helper.keyboard.initOverlayEvents(l.overlay),_()},this.performAction=()=>{const a=l.overlay.data("info");switch(l.modal.attr(e.attr.type)){case"delete":y(a);break;case"deleteSelected":k(a);break;case"hide":v(a);break;case"openChildren":f(a);break;case"openSelected":b(a);break;case"edit":t.helper.entry.isSeparator(a.id)?C(a):w(a);break;case"add":T(a)}},this.closeOverlay=()=>{t.helper.utility.triggerEvent("overlayClosed"),t.elm.bookmarkBox.all.find("li."+e.cl.drag.isDragged).remove(),l.overlay.removeClass(e.cl.page.visible),t.helper.scroll.focus(),e.delay(400).then((()=>{l.overlay.remove()}))},this.setCloseButtonLabel=(a="close")=>{l.buttonWrapper.children("a."+e.cl.close).text(t.helper.i18n.get("overlay_"+a))},this.isOpened=()=>e("iframe#"+e.opts.ids.page.overlay).length()>0;const r=a=>{if(a.additionalInfo&&a.additionalInfo.desc){const r=e("<div></div>").addClass(e.cl.info).appendTo(l.modal);e("<h3></h3>").text(t.helper.i18n.get("overlay_bookmark_additional_info")).appendTo(r),e("<p></p>").text(a.additionalInfo.desc).appendTo(r)}},i=(a,r)=>{const i=e("<"+(a.isDir?"span":"a")+"></"+(a.isDir?"span":"a")+">").attr("title",a.title).addClass(e.cl.overlay.preview).text(a.title).appendTo(l.modal);a.isDir?i.prepend("<span class='"+e.cl.sidebar.dirIcon+"'></span>"):e.opts.demoMode?i.prepend("<span class='"+e.cl.sidebar.dirIcon+"' data-color='"+(Math.floor(10*Math.random())+1)+"'></span>"):t.helper.model.call("favicon",{url:a.url}).then((e=>{e.img&&i.prepend("<img src='"+e.img+"' />")})),r&&!0===r&&!0!==a.isDir&&e("<a></a>").addClass(e.cl.overlay.previewUrl).attr("title",a.url).text(a.url).insertAfter(i)},o=()=>{const r=e("<div></div>").addClass(e.cl.scrollBox.wrapper).appendTo(l.modal),i=e("<div></div>").append("<h3>"+t.helper.i18n.get("settings_open_action")+"</h3>").appendTo(r);e("<a></a>").text(t.helper.i18n.get("settings_keyboard_shortcut_button")).appendTo(i).on("click",(e=>{e.preventDefault(),t.helper.model.call("openLink",{href:"chrome://extensions/shortcuts",newTab:!0,active:!0})}));const o=e("<ul></ul>").appendTo(i),n={tab:[["&#8593;"],["&#8595;"],["tab"]],enter:[["enter"]],shift_enter:[["shift","enter"]],ctrl_c:[[navigator.platform.indexOf("Mac")>-1?"cmd":"ctrl","c"]],del:[["del"]],esc:[["esc"]]};Object.entries(n).forEach((([l,r])=>{const i=[];r.forEach((e=>{e=e.map((e=>{let l="<i>";return l+=t.helper.i18n.get("keyboard_shortcuts_key_"+e)||e,a[e]&&(l+=" "+a[e]),l+="</i>",l})),i.push("<strong>"+e.join("+")+"</strong>")})),e("<li></li>").html(i.join(", ")).append("<span>"+t.helper.i18n.get("keyboard_shortcuts_"+l+"_desc")+"</span>").appendTo(o)})),this.setCloseButtonLabel("close")},n=a=>{e("<p></p>").text(t.helper.i18n.get("overlay_delete_selected_confirm")).appendTo(l.modal),e("<p></p>").addClass(e.cl.selected).html("<strong>"+a.length+"</strong> <span>"+t.helper.i18n.get("header_selected_entries")+"</span>").appendTo(l.modal),e("<a></a>").addClass(e.cl.overlay.action).text(t.helper.i18n.get("overlay_delete")).appendTo(l.buttonWrapper)},s=a=>{e("<p></p>").text(t.helper.i18n.get("overlay_delete_"+(a.isDir?"dir":"bookmark")+"_confirm")).appendTo(l.modal),i(a),r(a),e("<a></a>").addClass(e.cl.overlay.action).text(t.helper.i18n.get("overlay_delete")).appendTo(l.buttonWrapper)},d=a=>{const r=e("<ul></ul>").appendTo(l.modal),i=a.title.replace(/'/g,"&#x27;").replace(/(^[-_]+|[-_]+$)/g,"").trim();e("<li></li>").html("<span>"+t.helper.i18n.get("overlay_separator_title_desc")+"</span>").appendTo(r),e("<li></li>").append("<label>"+t.helper.i18n.get("overlay_bookmark_title")+"</label>").append("<input type='text' name='title' value='"+i+"' />").appendTo(r),e("<a></a>").addClass(e.cl.overlay.action).text(t.helper.i18n.get("overlay_save")).appendTo(l.buttonWrapper)},c=a=>{i(a);const r=e("<ul></ul>").appendTo(l.modal);e("<li></li>").append("<label>"+t.helper.i18n.get("overlay_bookmark_title")+"</label>").append("<input type='text' name='title' value='"+a.title.replace(/'/g,"&#x27;")+"' />").appendTo(r),a.isDir||e("<li></li>").append("<label>"+t.helper.i18n.get("overlay_bookmark_url")+"</label>").append("<input type='text' name='url' value='"+a.url.replace(/'/g,"&#x27;")+"' />").appendTo(r);const o=e("<li></li>").addClass(e.cl.info).append("<label>"+t.helper.i18n.get("overlay_bookmark_additional_info")+"</label>").appendTo(r),n=e("<textarea name='info'></textarea>").appendTo(o);n[0].value=a.additionalInfo&&a.additionalInfo.desc||"",o.append("<span>"+t.helper.i18n.get("settings_not_synced")+"</span>"),n.on("focus",(()=>{o.addClass(e.cl.active)})).on("blur",(()=>{o.removeClass(e.cl.active)})),e("<a></a>").addClass(e.cl.overlay.action).text(t.helper.i18n.get("overlay_save")).appendTo(l.buttonWrapper)},h=a=>{const r=a.children.filter((e=>e.url&&"about:blank"!==e.url)),o=t.helper.i18n.get("overlay_confirm_open_children",[r.length]);e("<p></p>").text(o).appendTo(l.modal),i(a),e("<a></a>").addClass(e.cl.overlay.action).text(t.helper.i18n.get("overlay_open_children")).appendTo(l.buttonWrapper)},p=a=>{const r=t.helper.i18n.get("overlay_confirm_open_selected",[a.length]);e("<p></p>").text(r).appendTo(l.modal),e("<a></a>").addClass(e.cl.overlay.action).text(t.helper.i18n.get("overlay_open_children")).appendTo(l.buttonWrapper)},m=a=>{e("<p></p>").text(t.helper.i18n.get("overlay_hide_"+(a.isDir?"dir":"bookmark")+"_confirm")).appendTo(l.modal),i(a),r(a),e("<a></a>").addClass(e.cl.overlay.action).text(t.helper.i18n.get("overlay_hide_from_sidebar")).appendTo(l.buttonWrapper)},u=a=>{const r=e("<a></a>").addClass(e.cl.overlay.action).text(t.helper.i18n.get("overlay_save")).appendTo(l.buttonWrapper),i=e("<menu></menu>").attr(e.attr.name,"select").appendTo(l.modal),o={bookmark:e("<a></a>").attr(e.attr.type,"bookmark").attr("title",t.helper.i18n.get("overlay_label_bookmark")).appendTo(i),dir:e("<a></a>").attr(e.attr.type,"dir").attr("title",t.helper.i18n.get("overlay_label_dir")).appendTo(i),separator:e("<a></a>").attr(e.attr.type,"separator").attr("title",t.helper.i18n.get("overlay_label_separator")).appendTo(i)};i.on("mouseleave",(t=>{e(t.currentTarget).children("a").removeClass(e.cl.hover)})),i.children("a").on("mouseenter",(t=>{i.children("a").removeClass(e.cl.hover),e(t.currentTarget).addClass(e.cl.hover)})).on("mouseleave",(t=>{e(t.currentTarget).removeClass(e.cl.hover)})).on("click",(o=>{o.preventDefault();const n=e(o.currentTarget).attr(e.attr.type),s=e("<ul></ul>").attr(e.attr.type,n).appendTo(l.modal);let d="",c="";"bookmark"===n&&(d=document.title||"",c=location.href),a&&a.values&&(d=(a.values.title||"").trim(),c=(a.values.url||"").trim()),s.append("<li><h2>"+e(o.currentTarget).attr("title")+"</h2></li>"),"separator"===n&&s.append("<li><span>"+t.helper.i18n.get("overlay_separator_title_desc")+"</span></li>"),s.append("<li><label>"+t.helper.i18n.get("overlay_bookmark_title")+"</label><input type='text' name='title' value='"+d.replace(/'/g,"&#x27;")+"' /></li>"),"bookmark"===n&&s.append("<li><label>"+t.helper.i18n.get("overlay_bookmark_url")+"</label><input type='text' name='url' value='"+c.replace(/'/g,"&#x27;")+"'  /></li>");if("custom"===t.helper.model.getData("u/sort").name&&(!a.values||void 0===a.values.index)){s.append("<li><label>"+t.helper.i18n.get("overlay_add_position")+"</label><select name='position'> <option value='append'>"+t.helper.i18n.get("overlay_add_position_append")+"</option> <option value='prepend'>"+t.helper.i18n.get("overlay_add_position_prepend")+"</option></select></li>");const e=t.helper.model.getData("b/newEntryPosition");s.find("select[name='position'] > option[value='"+e+"']").length()>0&&(s.find("select[name='position']")[0].value=e)}i.addClass(e.cl.hidden),i.children("a").removeClass(e.cl.hover),e.delay(a&&a.values?0:100).then((()=>{s.addClass(e.cl.visible),s.find("input")[0].focus(),r.addClass(e.cl.visible)}))})),a.overlayType&&o[a.overlayType]?o[a.overlayType].trigger("click"):a&&a.values&&o.bookmark.trigger("click")},g=a=>{i(a,!0);const o=t.helper.entry.getParentsById(a.id);if(o.length>0){const t=e("<ul></ul>").addClass(e.cl.sidebar.breadcrumb).appendTo(l.modal);o.forEach((l=>{e("<li></li>").text(l.title).prependTo(t)}))}r(a);const n=e("<ul></ul>").appendTo(l.modal),s=new Date(a.dateAdded);if(e("<li></li>").html(t.helper.i18n.get("overlay_bookmark_created_date")+" "+t.helper.i18n.getLocaleDate(s)).appendTo(n),a.isDir){const l=e("<li></li>").addClass(e.cl.tooltip.wrapper).append("<span>"+a.childrenAmount.total+"</span>").append(" "+t.helper.i18n.get("overlay_dir_children"),!1).appendTo(n);e("<ul></ul>").append("<li>"+a.childrenAmount.bookmarks+" "+t.helper.i18n.get("overlay_dir_children_bookmarks")+"</li>").append("<li>"+a.childrenAmount.directories+" "+t.helper.i18n.get("overlay_dir_children_dirs")+"</li>").appendTo(l)}const d=e("<li></li>").addClass(e.cl.tooltip.wrapper).append("<span>"+a.views.total+"</span>").append(" "+t.helper.i18n.get("overlay_bookmark_views"+(1===a.views.total?"_single":"")),!1).appendTo(n),c=new Date(a.views.startDate);e("<ul></ul>").append("<li>"+t.helper.i18n.get("overlay_bookmark_views_since")+" "+t.helper.i18n.getLocaleDate(c)+"</li>").append("<li>"+a.views.perMonth+" "+t.helper.i18n.get("overlay_bookmark_views"+(1===a.views.perMonth?"_single":""))+" "+t.helper.i18n.get("overlay_bookmark_views_per_month")+"</li>").appendTo(d)},f=e=>{this.closeOverlay();const l=e.children.filter((e=>e.url&&"about:blank"!==e.url));t.helper.utility.openAllBookmarks(l)},b=e=>{this.closeOverlay(),t.helper.utility.openAllBookmarks(e)},v=e=>{t.startLoading(),this.closeOverlay();const l=t.helper.model.getData("u/hiddenEntries");l[e.id]=!0,t.helper.model.setData({"u/hiddenEntries":l}).then((()=>Promise.all([t.helper.model.call("removeCache",{name:"htmlList"}),t.helper.model.call("removeCache",{name:"htmlPinnedEntries"})]))).then((()=>{t.helper.model.call("reload",{type:"Hide"})}))},k=async l=>{t.startLoading();for(const a of l)t.elm.bookmarkBox.all.find("a["+e.attr.id+"='"+a.id+"']").parent("li").remove(),await t.helper.bookmark.performDeletion(a.id,!0);t.helper.model.call("reload",{type:"Hide"}),this.closeOverlay()},y=l=>{this.closeOverlay(),t.elm.bookmarkBox.all.find("a["+e.attr.id+"='"+l.id+"']").parent("li").remove(),t.helper.bookmark.performDeletion(l.id)},x=a=>{const r=l.modal.find("input[name='title']").removeClass(e.cl.error),i=l.modal.find("input[name='url']").removeClass(e.cl.error),o=l.modal.find("select[name='position']"),n=l.modal.find("textarea[name='info']"),s={errors:!1,values:{title:r[0].value.trim(),url:a?null:i[0].value.trim(),position:o.length()>0?o[0].value:t.helper.model.getData("b/newEntryPosition"),additionalInfo:n.length()>0&&n[0].value||null}};return 0===s.values.title.length&&(r.addClass(e.cl.error),s.errors=!0),a||0!==s.values.url.length||(i.addClass(e.cl.error),s.errors=!0),null!==s.values.url&&0!==s.values.url.search(/^[\w-]+\:/)&&(s.values.url="http://"+s.values.url),s},C=e=>{const a=l.modal.find("input[name='title']")[0].value.trim();t.helper.bookmark.editEntry({id:e.id,title:a.length>0?"---- "+a+" ----":"----------",url:"about:blank"}).then((()=>{t.helper.model.call("reload",{type:"Edit"}),this.closeOverlay()}))},w=a=>{const r=x(a.isDir);!1===r.errors&&t.helper.bookmark.editEntry({id:a.id,title:r.values.title,url:r.values.url,additionalInfo:r.values.additionalInfo}).then((([a])=>{a.error?l.modal.find("input[name='url']").addClass(e.cl.error):(t.helper.model.call("reload",{type:"Edit"}),this.closeOverlay())}))},D=(l,a)=>{if("prepend"===a)return 0;return t.elm.bookmarkBox.all.find("ul > li > a["+e.attr.id+"='"+l+"'] + ul").children("li").length()},B=e=>{const a=l.modal.find("input[name='title']")[0].value.trim(),r=l.modal.find("select[name='position'")[0].value,i=e.id||null;t.helper.model.call("createBookmark",{title:a.length>0?"---- "+a+" ----":"----------",url:"about:blank",parentId:e.id||null,index:D(i,r)}).then((()=>{this.closeOverlay()}))},T=a=>{if("separator"===l.modal.children("ul").attr(e.attr.type))B(a);else{const r=x(0===l.modal.find("input[name='url']").length());if(!1===r.errors){const i={title:r.values.title,url:r.values.url,parentId:a.id||null,index:0};a&&a.values?(a.values.index&&(i.index=a.values.index),a.values.parentId&&(i.parentId=a.values.parentId)):i.index=D(i.parentId,r.values.position),t.helper.model.call("createBookmark",i).then((t=>{t.error?l.modal.find("input[name='url']").addClass(e.cl.error):this.closeOverlay()}))}}},_=()=>{let a=null;l.overlay.find("body").on("mousedown",(e=>{a=e.target})).on("click",(e=>{"BODY"===e.target.tagName&&"BODY"===a.tagName&&this.closeOverlay()})),l.modal.find("a."+e.cl.close).on("click",(e=>{e.preventDefault(),this.closeOverlay()})),l.modal.on("click","a."+e.cl.overlay.action,(e=>{e.preventDefault(),this.performAction()})),l.modal.on("focus","input",(t=>{e(t.currentTarget).removeClass(e.cl.error)})),l.modal.find("a."+e.cl.overlay.preview+", a."+e.cl.overlay.previewUrl).on("click",(e=>{e.preventDefault(),t.helper.utility.openUrl(l.overlay.data("info"),"newTab")}))}},e.ScrollHelper=function(t){let l=+new Date;const a={},r=[];let i=0;this.init=()=>{const e=t.helper.model.getData("b/scrollBarHide");i=1e3*+e},this.add=(t,l)=>{const a=e("<div id='"+t+"' class='"+e.cl.scrollBox.wrapper+"' tabindex='0'></div>").insertBefore(l);return l=l.appendTo(a),a.data({list:l}),r.push(a),d(a),a},this.focus=()=>{t.elm.iframe.hasClass(e.cl.page.visible)&&null!==t.elm.iframe[0].contentDocument&&t.helper.toggle.sidebarHoveredOnce()&&t.elm.header.find("div."+e.cl.sidebar.searchBox+" > input[type='text']")[0]!==t.elm.iframe[0].contentDocument.activeElement&&r.forEach((t=>{t.hasClass(e.cl.active)&&t[0].focus()}))},this.restoreScrollPos=l=>new Promise((a=>{const r=t.helper.model.getData(["b/rememberState","u/scrollPos"]);"all"===r.rememberState||"openStatesAndPos"===r.rememberState?(this.setScrollPos(l,r.scrollPos),e.delay(100).then(a)):a()})),this.setScrollPos=(e,t,l=0)=>{if(0===l)e[0].scrollTop=t,this.update(e);else{const a=e[0].scrollTop;let r=0;const i=()=>{r+=1/60;const o=r/(l/1e3),n=Math.sin(o*(Math.PI/2));o<1?(window.requestAnimationFrame(i),e[0].scrollTop=a+(t-a)*n):(e[0].scrollTop=t,this.update(e))};i()}},this.getScrollPos=e=>e[0].scrollTop,this.update=l=>{t.helper.contextmenu.close(),t.helper.tooltip.close();const r=s(l),d=o(l),c=l[0].scrollTop;l.attr("id")===e.opts.ids.sidebar.bookmarkBox.all&&n(c),c>10?l.addClass(e.cl.scrollBox.scrolled):l.removeClass(e.cl.scrollBox.scrolled);const h=l.data("lastPos")||0;c>h?l.attr(e.attr.direction,"down"):c<h?l.attr(e.attr.direction,"up"):l.removeAttr(e.attr.direction),l.data("lastPos",c),(d-c<2*r||d===c&&0===r)&&l.trigger(e.opts.events.scrollBoxLastPart),i>0&&(t.elm.iframe.hasClass(e.cl.page.visible)?(l.removeClass(e.cl.scrollBox.hideScrollbar),clearTimeout(a[l.attr("id")]),a[l.attr("id")]=setTimeout((()=>{l.addClass(e.cl.scrollBox.hideScrollbar)}),i)):l.addClass(e.cl.scrollBox.hideScrollbar)),this.focus()};const o=t=>{let l=0;return t.children().forEach((t=>{l+=e(t).realHeight(!0)})),l},n=e=>{!1===t.refreshRun&&(clearTimeout(a._scrollPos),+new Date-l>500?(l=+new Date,t.helper.model.setData({"u/scrollPos":e})):a._scrollPos=setTimeout((()=>{n(e)}),500))},s=e=>e.realHeight()-parseInt(e.css("padding-top")),d=e=>{e.on("scroll",(()=>{this.update(e)}))}},e.SearchHelper=function(t){let l=null;this.searchVal="",this.init=()=>{o()},this.isResultsVisible=()=>t.elm.bookmarkBox.search.hasClass(e.cl.active),this.clearSearch=()=>new Promise((l=>{t.helper.contextmenu.close(),t.helper.tooltip.close(),t.elm.header.removeClass(e.cl.sidebar.searchVisible),this.update("").then(l)})),this.showSearchField=()=>{t.helper.contextmenu.close(),t.helper.tooltip.close(),t.elm.header.addClass(e.cl.sidebar.searchVisible),t.elm.header.find("div."+e.cl.sidebar.searchBox+" > input[type='text']")[0].focus()},this.update=(l=null)=>new Promise((r=>{const o=t.elm.header.find("div."+e.cl.sidebar.searchBox+" > input[type='text']");o&&o.length()>0?(null===l?l=o[0].value:o[0].value=l,l&&l.length>0?a(o,l).then(r):i(o).then(r)):r()}));const a=(l,a)=>new Promise((i=>{t.elm.bookmarkBox.all.removeClass(e.cl.active).removeClass(e.cl.scrollBox.scrolled),t.elm.bookmarkBox.search.addClass(e.cl.active),t.helper.scroll.focus(),t.helper.list.updateSortFilter(),this.searchVal=a,a!==l.data("lastVal")&&(t.startLoading(),l.data("lastVal",a),t.helper.entry.initOnce().then((()=>(t.helper.scroll.setScrollPos(t.elm.bookmarkBox.search,0),r(a)))).then((l=>{t.elm.bookmarkBox.search.children("p").remove();let a=!1;const r=t.elm.bookmarkBox.search.children("ul");r.text(""),l.length>0&&(a=t.helper.list.addBookmarkDir(l,r,!1)),!1===a&&e("<p></p>").text(t.helper.i18n.get("sidebar_search_no_results")).appendTo(t.elm.bookmarkBox.search),t.endLoading(100),i()})))})),r=e=>new Promise((l=>{const a=e.toLowerCase(),r=[];t.helper.model.call("searchBookmarks",{searchVal:e}).then((e=>{const i=e.bookmarks||[];i.forEach((e=>{r.push(e.id)}));t.helper.entry.getAllDataByType("directories").forEach(((e,t)=>{e.title.toLowerCase().indexOf(a)>-1&&(e.index=-1e3+t,i.push(e),r.push(e.id))}));const o=t.helper.model.getData("u/additionalInfo");Object.entries(o).forEach((([e,l])=>{if(l&&l.desc&&l.desc.toLocaleLowerCase().indexOf(a)>-1&&-1===r.indexOf(e)){const l=t.helper.entry.getDataById(e);l.isDir&&(l.index=-1e3+l.index),i.push(l)}})),l(i)}))})),i=l=>new Promise((a=>{l.removeData("lastVal"),this.searchVal="",this.isResultsVisible()&&(t.startLoading(),t.elm.bookmarkBox.all.addClass(e.cl.active),t.elm.bookmarkBox.search.removeClass([e.cl.active,e.cl.scrollBox.scrolled]),t.elm.bookmarkBox.search.removeAttr(e.attr.direction),t.helper.scroll.restoreScrollPos(t.elm.bookmarkBox.all),t.helper.scroll.focus(),t.endLoading()),t.helper.list.updateSortFilter(),a()})),o=()=>{t.elm.header.on("click","a."+e.cl.sidebar.search,(e=>{e.preventDefault(),e.stopPropagation(),this.showSearchField()})),t.elm.header.on("click","a."+e.cl.sidebar.searchClose,(e=>{e.preventDefault(),e.stopPropagation(),this.clearSearch()})),t.elm.header.on("keyup","div."+e.cl.sidebar.searchBox+" > input[type='text']",(e=>{e.preventDefault(),l&&(clearTimeout(l),l=null),l=setTimeout((()=>{this.update()}),300)})).on("keydown","div."+e.cl.sidebar.searchBox+" > input[type='text']",(e=>{if(e.key&&"ENTER"===e.key.toUpperCase()){const l=t.elm.bookmarkBox.search.find("> ul > li");1===l.length()&&t.helper.sidebarEvents.handleEntryClick(l.eq(0).children("a"),{ctrlKey:e.ctrlKey||e.metaKey})}}))}},e.SelectionHelper=function(t){let l={};this.start=()=>{t.elm.sidebar.addClass(e.cl.sidebar.selectionMode),t.elm.header.addClass(e.cl.sidebar.selectionMode),this.updateSidebarHeader(),r()},this.leave=()=>{t.elm.sidebar.removeClass(e.cl.sidebar.selectionMode),t.elm.header.removeClass(e.cl.sidebar.selectionMode),l=[],r(),t.helper.list.updateSidebarHeader(),t.helper.search.searchVal&&t.helper.search.update(t.helper.search.searchVal)},this.isEnabled=()=>t.elm.sidebar.hasClass(e.cl.sidebar.selectionMode),this.getSelectedAmount=()=>Object.keys(l).length,this.reset=()=>{l=[],this.isEnabled()&&(this.updateSidebarHeader(),r())},this.select=e=>{this.start(),l[e]=t.helper.entry.getDataById(e),this.updateSidebarHeader(),r()},this.deselect=e=>{l[e]&&(delete l[e],this.updateSidebarHeader(),r())},this.moveSelection=async(l,r,i)=>{const o=a(),n=o.reverse(),s=i.children("a").attr(e.attr.id);for(const e of n)e.id!==s&&e.elm.parent("li").insertAfter(i);for(const e of o)e.id!==s&&(await t.helper.model.call("moveBookmark",{id:e.id,parentId:l,index:r+1}),r++)},this.openSelected=async()=>{const e=a(),r=[];let i=!1;for(const t of e){const e=l[t.id];if(e.children){i=!0;for(const t of e.children)t.url&&"about:blank"!==t.url&&r.push(t)}else r.push(e)}i&&r.length>t.helper.model.getData("b/openChildrenWarnLimit")?t.helper.overlay.create("openSelected",t.helper.i18n.get("contextmenu_open_children"),r):t.helper.utility.openAllBookmarks(r)},this.deleteSelected=async()=>{const e=a();if(0!==e.length)if(!0===e[e.length-1].dir)t.helper.overlay.create("deleteSelected",t.helper.i18n.get("overlay_delete_selected"),e);else{for(const l of e)await t.helper.bookmark.removeEntry(l.id);this.reset()}},this.handleSidebarWidthChange=()=>{const l=t.elm.header.children("a."+e.cl.cancel),a=t.elm.header.children("a."+e.cl.sidebar.removeSelected);l[0]&&a[0]&&l[0].offsetTop>2*a[0].offsetTop&&l.attr(e.attr.type,"compact")},this.updateSidebarHeader=()=>{t.elm.header.text("");const a=Object.keys(l).length;e("<h1></h1>").html("<strong>"+a+"</strong> <span>"+t.helper.i18n.get("header_selected_entries")+"</span>").attr("title",a+" "+t.helper.i18n.get("header_selected_entries",null,!0)).appendTo(t.elm.header),e("<a></a>").addClass(e.cl.sidebar.openSelected).appendTo(t.elm.header),e("<a></a>").addClass(e.cl.sidebar.removeSelected).appendTo(t.elm.header),e("<a></a>").addClass(e.cl.cancel).text(t.helper.i18n.get("overlay_cancel")).appendTo(t.elm.header),t.helper.list.handleSidebarWidthChange(),this.handleSidebarWidthChange()};const a=()=>{const a=[],r=t.helper.list.getActiveBookmarkBox();return Object.entries(l).forEach((([t,l])=>{const i=r.find("> ul a["+e.attr.id+"='"+t+"']");a.push({elm:i,id:t,dir:!!l.isDir,offsetTop:i[0].offsetTop})})),a.sort(((e,t)=>e.dir!==t.dir?e.dir?1:-1:e.offsetTop-t.offsetTop)),a},r=()=>{const a=t.helper.list.getActiveBookmarkBox();a.find("> ul a["+e.attr.id+"]."+e.cl.selected).forEach((a=>{const r=e(a),i=e(r).attr(e.attr.id);t.helper.checkbox.isChecked(r)&&!l[i]&&r.find("div."+e.cl.checkbox.box).trigger("click"),r.removeClass(e.cl.selected)})),Object.keys(l).forEach((l=>{const r=t.helper.entry.getDataById(l),i=a.find("> ul a["+e.attr.id+"='"+r.id+"']");t.helper.checkbox.isChecked(e(i))||e(i).find("div."+e.cl.checkbox.box).trigger("click"),i.addClass(e.cl.selected)}))}},e.SidebarEventsHelper=function(t){let l=null,a=null,r=!1,i=null;const o=150,n=1800;this.init=async()=>{i=t.helper.model.getData("b/sidebarPosition"),c(),d(),h(),p(),"premium"===t.helper.model.getUserType()&&m()},this.handleEntryClick=(l,a)=>{const r=t.helper.entry.getDataById(l.attr(e.attr.id));if(!r)return!1;const i=t.helper.model.getData(["b/newTab","b/linkAction"]),o=2===a.which||a.ctrlKey||a.metaKey;if(r.isDir&&!l.hasClass(e.cl.sidebar.dirAnimated))if(o){const e=r.children.filter((e=>e.url&&"about:blank"!==e.url));e.length>t.helper.model.getData("b/openChildrenWarnLimit")?t.helper.overlay.create("openChildren",t.helper.i18n.get("contextmenu_open_children"),r):t.helper.utility.openAllBookmarks(e)}else t.helper.list.toggleBookmarkDir(l);else if(!r.isDir)if(r.reopenSidebar=t.helper.model.getData("b/reopenSidebar"),o){const e=a.shiftKey||"background"===i.newTab&&"newtab"===i.linkAction;t.helper.utility.openUrl(r,"newTab",e)}else"newtab"===i.linkAction?t.helper.utility.openUrl(r,"newTab","foreground"===i.newTab):t.helper.selection.isEnabled()&&0===l.parents("div."+e.cl.sidebar.entryPinned).length()?s(l):t.helper.utility.openUrl(r,"default",!0)};const s=l=>{const a=l.attr(e.attr.id);l.hasClass(e.cl.selected)?t.helper.selection.deselect(a):t.helper.selection.select(a)},d=async()=>{t.elm.filterBox.on("click","a["+e.attr.direction+"]",(l=>{l.preventDefault();const a="ASC"===e(l.target).attr(e.attr.direction)?"DESC":"ASC";t.helper.list.updateDirection(a)})).on("click","div."+e.cl.checkbox.box+" + a",(t=>{t.preventDefault(),e(t.target).prev("div["+e.attr.name+"]").trigger("click")}))},c=async()=>{Object.values(t.elm.bookmarkBox).forEach(((a,i)=>{const o=[a];0===i&&o.push(t.elm.pinnedBox),e(o).on("click mousedown","> ul a",(l=>{l.preventDefault();const a=e(l.target);a.hasClass(e.cl.drag.trigger)||a.hasClass(e.cl.sidebar.separator)||a.parent().hasClass(e.cl.sidebar.removeMask)||!(1===l.which&&"click"===l.type||2===l.which&&"mousedown"===l.type||t.refreshRun)||this.handleEntryClick(e(l.currentTarget),l)})).on("dblclick","> ul a",(l=>{const a=e(l.currentTarget);if(a.hasClass(e.cl.sidebar.bookmarkDir)&&!a.hasClass(e.cl.sidebar.dirOpened)){const l=a=>{e.delay().then((()=>{a.next("ul").find("> li > a."+e.cl.sidebar.bookmarkDir+":not(."+e.cl.sidebar.dirOpened+")").forEach((a=>{t.helper.list.toggleBookmarkDir(e(a),!1,!1).then((()=>{l(e(a))}))}))}))};l(a)}})).on("mouseover","> ul a",(r=>{if(!1===t.helper.overlay.isOpened()){const i=e(r.currentTarget),o=i.attr(e.attr.id);a.find("a."+e.cl.hover).removeClass(e.cl.hover),a.find("a."+e.cl.sidebar.lastHover).removeClass(e.cl.sidebar.lastHover),i.hasClass(e.cl.sidebar.mark)||i.addClass([e.cl.hover,e.cl.sidebar.lastHover]),l&&clearTimeout(l),l=setTimeout((()=>{a.find("a["+e.attr.id+"='"+o+"']").removeClass(e.cl.sidebar.mark)}),500),t.helper.tooltip.create(i)}})).on("contextmenu","> ul a",(l=>{l.preventDefault();let a="list";e(l.target).hasClass(e.cl.sidebar.separator)&&(a="separator"),e(l.currentTarget).removeClass(e.cl.sidebar.mark),t.helper.contextmenu.create(a,e(l.currentTarget))})).on("mouseleave",(l=>{t.helper.tooltip.close(),e(l.currentTarget).find("a."+e.cl.hover).removeClass(e.cl.hover)})).on("click","span."+e.cl.sidebar.removeMask+" > span",(l=>{l.preventDefault();const a=e(l.target).parents("a").eq(0);!1===r&&(r=!0,t.helper.bookmark.restoreEntry(a).then((()=>{r=!1})))})).on("mouseover","> a["+e.attr.name+"='add']",(l=>{l.preventDefault(),a.find("a."+e.cl.hover).removeClass(e.cl.hover),t.helper.tooltip.close()})).on("click","> a["+e.attr.name+"='add']",(l=>{l.preventDefault();const a=t.elm.bookmarkBox.all.children("ul > li > a").eq(0).attr(e.attr.id);t.helper.overlay.create("add",t.helper.i18n.get("contextmenu_add"),t.helper.entry.getDataById(a))}))}))},h=async()=>{const l=()=>{a&&clearTimeout(a)},r=()=>{l(),a=setTimeout((()=>{t.elm.lockPinned.removeClass(e.cl.active),t.helper.toggle.removeSidebarHoverClass()}),500)};t.elm.pinnedBox.on("mouseenter",(()=>{l(),t.elm.lockPinned.addClass(e.cl.active)})).on("mouseleave",(()=>{r()})),t.elm.lockPinned.on("mouseenter",(()=>{l()})).on("mouseleave",(()=>{r()})).on("click",(l=>{l.preventDefault(),l.stopPropagation(),t.elm.lockPinned.toggleClass(e.cl.sidebar.fixed),t.elm.pinnedBox.toggleClass(e.cl.sidebar.fixed);const a=t.elm.pinnedBox.hasClass(e.cl.sidebar.fixed);t.helper.model.setData({"u/lockPinned":a}).then((()=>{!1===a&&(t.helper.scroll.setScrollPos(t.elm.bookmarkBox.all,0,200),t.elm.lockPinned.removeClass(e.cl.active)),t.helper.toggle.removeSidebarHoverClass(),t.helper.list.updateSortFilter()}))}))},p=async()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(()=>{t.helper.model.call("reloadIcon")})),t.elm.iframe.find("body").on("click",(()=>{t.helper.contextmenu.close(),t.helper.tooltip.close()})),e(document).on(e.opts.events.premiumPurchased,(l=>{l.detail&&l.detail.licenseKey&&(e(document).off(e.opts.events.premiumPurchased),t.helper.model.call("activatePremium",{licenseKey:l.detail.licenseKey}))})).on(e.opts.events.showFeedbackForm,(()=>{e("div[data-name='redeviation-extension']").removeAttr("data-name"),t.helper.model.call("openLink",{href:e.api.extension.getURL("html/settings.html#support"),newTab:!1})})),e(t.elm.iframe[0].contentDocument).on(e.opts.events.checkboxChanged,(l=>{const a=l.detail.checkbox.attr(e.attr.name);"viewAsTree"===a||"mostViewedPerMonth"===a?t.helper.model.setData({["u/"+a]:l.detail.checked}).then((()=>{t.startLoading(),t.helper.model.call("reload",{scrollTop:!0,type:"Sort"})})):"select"===a&&s(e(l.detail.container).parent())})),e.api.extension.onMessage.removeListener(u),e.api.extension.onMessage.addListener(u),["menu","sort"].forEach((l=>{t.elm.header.on("click contextmenu","a."+e.cl.sidebar[l],(a=>{a.preventDefault(),a.stopPropagation(),t.helper.contextmenu.create(l,e(a.currentTarget))}))})),t.elm.header.on("click contextmenu","a."+e.cl.sidebar.removeSelected,(e=>{e.preventDefault(),e.stopPropagation(),t.helper.selection.deleteSelected()})),t.elm.header.on("click contextmenu","a."+e.cl.sidebar.openSelected,(e=>{e.preventDefault(),e.stopPropagation(),t.helper.selection.openSelected()})),t.elm.header.on("click contextmenu","a."+e.cl.cancel,(e=>{e.preventDefault(),e.stopPropagation(),t.helper.selection.leave()})),t.elm.iframeBody.on("click","#"+e.opts.ids.sidebar.reloadInfo+" a",(e=>{e.preventDefault(),location.reload(!0)})),t.elm.iframeBody.on("click","#"+e.opts.ids.sidebar.infoBox+" a",(l=>{l.preventDefault();const a=t.elm.iframeBody.find("#"+e.opts.ids.sidebar.infoBox),r=t.elm.iframeBody.find("#"+e.opts.ids.sidebar.infoBox).attr(e.attr.type);if(a.removeClass(e.cl.visible),"shareInfo"===r&&t.helper.model.call("updateShareInfo",{config:!1,activity:!1}),e(l.currentTarget).hasClass(e.cl.info)){let l=null;switch(r){case"premium":l="html/settings.html#premium";break;case"translation":l="html/settings.html#language_translate";break;case"shareInfo":l="html/settings.html#infos_permissions"}l&&t.helper.model.call("openLink",{href:e.api.extension.getURL(l),newTab:!0})}}))},m=async()=>{t.elm.widthDrag.on("mousemove",(()=>{t.elm.widthDrag.addClass(e.cl.hover)})).on("mouseleave",(()=>{t.elm.widthDrag.removeClass(e.cl.hover)})).on("mousedown",(()=>{t.helper.contextmenu.close(),t.helper.tooltip.close(),t.helper.toggle.addSidebarHoverClass(),t.elm.widthDrag.addClass(e.cl.drag.isDragged)})),t.elm.iframeBody.on("mousemove",(l=>{if(t.elm.widthDrag.hasClass(e.cl.drag.isDragged)&&1===l.which){l.preventDefault(),l.stopPropagation();let e=t.elm.widthDrag.data("dragInfo");e||(e={start:l.clientX,width:t.elm.sidebar.realWidth()},t.elm.widthDrag.data("dragInfo",e));let a=l.clientX-e.start;"right"===i&&(a*=-1),t.helper.toggle.addSidebarHoverClass();let r=e.width+a;r=Math.min(r,n),r=Math.max(r,o),t.elm.sidebar.css("width",r+"px"),t.helper.list.handleSidebarWidthChange()}})).on("mouseup",(()=>{if(t.elm.widthDrag.data("dragInfo")){t.elm.widthDrag.removeData("dragInfo");const l=t.helper.model.getData("a/styles");e.delay().then((()=>{const a=Math.round(t.elm.sidebar.realWidth());isNaN(a)||(l.sidebarWidth=a+"px",t.helper.model.setData({"a/styles":l}),t.elm.iframe.hasClass(e.cl.page.hideMask)&&t.elm.iframe.data("width",a+50)),t.helper.toggle.removeSidebarHoverClass(),t.elm.widthDrag.removeClass(e.cl.drag.isDragged)}))}}))},u=l=>{if(l&&l.action&&(null===l.reinitialized||t.initialized>l.reinitialized))if("reload"===l.action){let a=!0;if("Removed"===l.type||"Created"===l.type&&!0===r){const l=t.helper.list.getActiveBookmarkBox();(l.find("a."+e.cl.sidebar.restored).length()>0||l.find("span."+e.cl.sidebar.removeMask).length()>0)&&(a=!1)}if(a){let a=0;l.scrollTop&&(t.helper.scroll.setScrollPos(t.elm.bookmarkBox.all,0),a=100),t.needsReload=!0,e.delay(a).then(t.reload)}}else"toggleSidebar"===l.action&&(t.helper.model.call("clearNotWorkingTimeout"),t.elm.iframe.hasClass(e.cl.page.visible)?t.helper.toggle.closeSidebar():(t.helper.toggle.setSidebarHoveredOnce(!0),t.helper.toggle.openSidebar()))}},e.StylesheetHelper=function(t){const l=["overlay","sidebar","content"];let a={},r="",i="",o=!1;this.init=e=>{e&&e.defaultVal&&!0===e.defaultVal&&(o=!0),a=t.helper.model.getData("a/styles",o),i=t.helper.model.getData("a/theme"),r=t.helper.model.getData("u/customCss")},this.getStylesheetFilesWithThemes=e=>{const t=e;return i&&"default"!==i&&e.forEach((e=>{l.includes(e)&&t.push("themes/"+i+"/"+e)})),t},this.addStylesheets=(l,i=null)=>new Promise((n=>{null===i?i=e(document):(t.helper.font.addStylesheet(i,o?"default":"config"),e.cl&&e.cl.page&&!1===t.helper.model.getData("b/animations")&&e.cl.page.noAnimations&&i.find("body").addClass(e.cl.page.noAnimations));let s=null;s=0===i.find("head").length()?i.find("body"):i.find("head");let d=0;this.getStylesheetFilesWithThemes(l).forEach((t=>{e.xhr(e.api.extension.getURL("css/"+t+".css")).then((i=>{if(i.response){let l=i.response;l+=r,Object.keys(a).forEach((e=>{l=l.replace(new RegExp('"?%'+e+'"?',"g"),a[e])})),e.cl&&e.cl.page&&e.cl.page.style&&e.attr&&e.attr.name?(s.find("style."+e.cl.page.style+"["+e.attr.name+"='"+t+"']").remove(),s.append("<style class='"+e.cl.page.style+"' "+e.attr.name+"='"+t+"'>"+l+"</style>")):s.append("<style>"+l+"</style>")}d++,d>=l.length&&n()}))}))}))},e.TemplateHelper=function(t){this.loading=()=>e('<svg class="loading" width="36px" height="36px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><circle fill="none" stroke-width="3" stroke-linecap="round" cx="18" cy="18" r="16"></circle></svg>'),this.overlay=(l,a)=>{const r={},i=t.helper.model.getData(["a/theme","b/animations","a/darkMode","a/highContrast"]);r.overlay=e("<iframe></iframe>").attr("id",e.opts.ids.page.overlay).addClass("notranslate").attr("aria-hidden","true").attr(e.attr.theme,i.theme).appendTo("body"),t.helper.stylesheet.addStylesheets(["overlay"],r.overlay);const o=r.overlay.find("body");o.attr(e.attr.theme,i.theme).attr("aria-hidden","true"),o.parent("html").attr("dir",t.helper.i18n.isRtl()?"rtl":"ltr"),r.modal=e("<div></div>").attr(e.attr.type,l).addClass(e.cl.overlay.modal).appendTo(o),!1===i.animations&&r.overlay.addClass(e.cl.page.noAnimations),i.darkMode?o.addClass(e.cl.page.darkMode):i.highContrast&&o.addClass(e.cl.page.highContrast);const n=e("<header></header>").appendTo(r.modal);return e("<h1></h1>").text(a).appendTo(n),e("<a></a>").addClass(e.cl.close).appendTo(n),r.buttonWrapper=e("<menu></menu>").addClass(e.cl.overlay.buttonWrapper).appendTo(r.modal),e("<a></a>").addClass(e.cl.close).appendTo(r.buttonWrapper),r.overlay[0].focus(),e.delay(100).then((()=>{r.modal.addClass(e.cl.visible),r.overlay.addClass(e.cl.page.visible)})),r}},e.ToggleHelper=function(t){const l={},a={};let r=0,i=!1,o=!1,n=null,s=null,d=null,c=null,h=null,p=null,m=null,u=null,g=null;this.init=async()=>{const a=t.helper.model.getData(["a/theme","b/toggleArea","b/preventPageScroll","a/showIndicator","a/showIndicatorIcon","a/styles","b/sidebarPosition","b/openDelay","b/openAction","b/preventWindowed","b/preventWebapp","n/autoOpen","u/performReopening"]);t.elm.indicator=e("<div></div>").attr("id",e.opts.ids.page.indicator).attr(e.attr.theme,a.theme).appendTo("body"),!1===t.helper.model.getData("b/animations")&&t.elm.indicator.addClass(e.cl.page.noAnimations),document.activeElement&&(g=document.activeElement),Object.entries(a.toggleArea).forEach((([e,t])=>{l[e]=+t})),r=1e3*+a.openDelay,n=a.sidebarPosition,s=a.preventPageScroll,d=a.preventWindowed,c=a.preventWebapp,t.elm.indicator.css({height:l.height+"%",top:l.top+"%"}),100===l.height&&t.elm.indicator.addClass(e.cl.page.fullHeight),t.elm.iframe.attr(e.attr.position,n),t.elm.sidebar.attr(e.attr.position,n),a.styles&&(a.styles.indicatorWidth&&(h=parseInt(a.styles.indicatorWidth)),a.styles.sidebarWidth&&(p=parseInt(a.styles.sidebarWidth))),a.showIndicator&&"icon"!==a.openAction&&"mousemove"!==a.openAction&&(t.elm.indicator.html("<div></div>").attr(e.attr.position,n),a.showIndicatorIcon&&e("<span></span>").appendTo(t.elm.indicator.children("div")),e.delay(50).then((()=>{t.elm.indicator.addClass(e.cl.page.visible)}))),x(),f();const i=v();(("newtab_website"===i||"newtab_replacement"===i||"newtab_fallback"===i)&&a.autoOpen||a.performReopening)&&(this.openSidebar(),t.helper.model.setData({"u/performReopening":!1})),!1===b()&&t.elm.iframe.addClass(e.cl.page.hideMask)},this.closeSidebar=()=>{t.elm.sidebar.hasClass(e.cl.sidebar.permanent)||(y("close"),y("open"),t.helper.contextmenu.close(),t.helper.tooltip.close(),t.helper.dragndrop.cancel(),t.elm.iframe.removeClass(e.cl.page.visible),e("body").removeClass(e.cl.page.noscroll),e(document).trigger("mousemove.bs"),g&&"function"==typeof g.focus&&g.focus({preventScroll:!0}))},this.openSidebar=()=>{!1===t.helper.utility.isBackgroundConnected()?(t.elm.iframe.addClass(e.cl.page.visible),t.addReloadMask()):(t.helper.model.call("infoToDisplay").then((e=>{e&&e.info&&("shareInfo"!==e.info&&"premium"!==e.info&&"translation"!==e.info||t.addInfoBox(e.info))})),t.elm.sidebar.hasClass(e.cl.sidebar.openedOnce)||(t.elm.sidebar.addClass(e.cl.sidebar.openedOnce),t.helper.list.handleSidebarWidthChange(),this.markLastUsed()),t.elm.iframe.hasClass(e.cl.page.visible)||t.helper.model.call("track",{name:"action",value:{name:"sidebar",value:v()}}),t.elm.iframe.addClass(e.cl.page.visible),t.initImages(),s&&e("body").addClass(e.cl.page.noscroll),e.delay(t.helper.model.getData("b/animations")?300:0).then((()=>t.helper.entry.initOnce())).then((()=>{t.helper.scroll.focus()})),e(document).trigger("mousemove.bs"),t.helper.utility.triggerEvent("sidebarOpened"))},this.markLastUsed=()=>{const l=t.helper.model.getData(["u/lastOpened","b/rememberState"]);if("all"===l.rememberState&&l.lastOpened){const a=t.elm.bookmarkBox.all.find("ul > li > a["+e.attr.id+"='"+l.lastOpened+"']");a&&a.length()>0&&(a.addClass(e.cl.sidebar.mark),t.helper.model.setData({"u/lastOpened":null}))}},this.sidebarHoveredOnce=()=>o,this.setSidebarHoveredOnce=()=>{o=!0},this.addSidebarHoverClass=()=>{t.elm.iframe.addClass(e.cl.page.hover),t.elm.iframe.css("width",""),o=!0},this.removeSidebarHoverClass=()=>{const l=t.elm.iframeBody.find("div."+e.cl.contextmenu.wrapper),a=t.elm.iframeBody.find("div."+e.cl.tooltip.wrapper);if(!(0!==l.length()||0!==a.length()||t.elm.iframeBody.hasClass(e.cl.drag.isDragged)||t.elm.widthDrag.hasClass(e.cl.drag.isDragged)||t.elm.widthDrag.hasClass(e.cl.hover)||t.elm.lockPinned.hasClass(e.cl.active))){t.elm.iframe.removeClass(e.cl.page.hover);const l=t.elm.iframe.data("width");l&&t.elm.iframe.css("width",l+"px")}};const f=async()=>{e(document).on("focus","input,textarea",(e=>{g=e.target}),{capture:!0}),t.elm.iframe.find("body").on("click",(l=>{if(l.clientX){let a=l.clientX;const r=t.elm.sidebar.realWidth();"right"===n&&(a=b()?window.innerWidth-a+(p||r)-1:t.elm.iframe.realWidth()-a),a>r&&t.elm.iframe.hasClass(e.cl.page.visible)&&!1===t.elm.widthDrag.hasClass(e.cl.drag.isDragged)&&this.closeSidebar()}})),e(document).on(e.opts.events.openSidebar+".bs",(()=>{this.openSidebar()})),e(document).on("mousedown.bs click.bs",(l=>{l.isTrusted&&t.elm.iframe.hasClass(e.cl.page.visible)&&this.closeSidebar()})),e(window).on("keydown.bs",(()=>{u=+new Date})).on("keyup.bs",(()=>{u=null})),t.elm.sidebar.on("mouseleave",(l=>{if((l.toElement||l.relatedTarget)&&(e.delay(100).then((()=>{this.removeSidebarHoverClass()})),!1===t.helper.overlay.isOpened()&&!1===t.elm.iframeBody.hasClass(e.cl.drag.isDragged)&&!1===t.elm.widthDrag.hasClass(e.cl.drag.isDragged))){const l=t.helper.model.getData("b/closeTimeout");-1!=+l&&(a.close=setTimeout((()=>{!1===t.elm.iframeBody.hasClass(e.cl.drag.isDragged)&&!1===t.elm.widthDrag.hasClass(e.cl.drag.isDragged)&&this.closeSidebar()}),1e3*+l))}})).on("mouseenter",(()=>{this.addSidebarHoverClass(),y("close")})),e(document).on("visibilitychange.bs",(()=>{if(document.hidden&&!1===t.helper.overlay.isOpened()){t.elm.indicator.removeClass(e.cl.page.hover);t.helper.model.getData("b/closeOnTabChange")&&t.elm.iframe.hasClass(e.cl.page.visible)&&this.closeSidebar()}})).on("mouseleave.bs",(()=>{y("open"),y("indicator"),t.elm.indicator.removeClass(e.cl.page.hover)})).on("mousemove.bs",(l=>{if(l.isTrusted&&k(l.clientX,l.clientY)){const l=+new Date-(m||0);a.indicator||(a.indicator=setTimeout((()=>{t.elm.indicator.addClass(e.cl.page.hover)}),Math.max(r-l,0)))}else y("indicator"),t.elm.indicator.removeClass(e.cl.page.hover)}),{passive:!0});const l=t.helper.model.getData("b/openAction");"icon"!==l&&e(document).on(l+".bs dragover.bs",(e=>{let t=!1;if("dragover"===e.type){const l=e.dataTransfer;t=l&&l.types&&(l.types.indexOf?-1!==l.types.indexOf("text/plain"):l.types.contains("text/plain"))}else t="mousedown"!==e.type||0===e.button;e.isTrusted&&t&&k(e.clientX,e.clientY)?(e.stopPropagation(),e.preventDefault(),"mousemove"===l?a.open||(a.open=setTimeout((()=>{this.openSidebar()}),r)):(0===r||null===m||+new Date-m>r)&&this.openSidebar()):y("open")}))},b=()=>{const e=v(),l=t.helper.model.getData("a/styles"),a=t.helper.model.getData("n/autoOpen"),r=l.sidebarMaskColor||null;return!(("newtab_website"===e||"newtab_replacement"===e||"newtab_fallback"===e)&&a||"onboarding"===e||"transparent"===r)},v=()=>{const t=location.href;let l="other",a=!1;return Object.entries({newtab_default:["https?://www\\.google\\..+/_/chrome/newtab"],newtab_fallback:[e.api.extension.getURL("html/newtab.html")+".*[?&]type=\\w+"],newtab_replacement:[e.api.extension.getURL("html/newtab.html")],newtab_website:[".*[?&]bs_nt=1(&|#|$)"],website:["https?://"],onboarding:["chrome\\-extension://.*/intro.html","extension://.*/intro.html"],chrome:["chrome://","edge://"],extension:["chrome\\-extension://","extension://"],local:["file://"]}).some((([e,r])=>{if(r.some((r=>{if(0===t.search(new RegExp(r,"gi")))return l=e,a=!0,!0})),a)return!0})),l},k=(a,r)=>{let o=!1;if(c&&t.helper.utility.isWebapp());else if(d&&t.helper.utility.isWindowed());else if(document.fullscreen||document.webkitIsFullScreen);else if(null!==u&&+new Date-u<500);else if(null!=a&&(a>0||r>0||i)){i=!0,"right"===n&&(a=window.innerWidth-a-1);let s=l.width;t.helper.utility.isWindowed()&&(s=l.widthWindowed);const d={w:s,h:r/window.innerHeight*100};t.elm.indicator.hasClass(e.cl.page.hover)&&h>d.w&&(d.w=h),o=a<d.w&&d.h>=l.top&&d.h<=l.top+l.height}return!1===o?m=null:null===m&&(m=+new Date),o},y=e=>{a[e]&&(clearTimeout(a[e]),a[e]=null)},x=async()=>{e(e.opts.leftsideBackSelector).length()>0?t.elm.indicator.addClass(e.cl.page.hasLeftsideBack):e(document).on(e.opts.events.lsbLoaded+".bs",(l=>{l.detail.showIndicator&&t.elm.indicator.addClass(e.cl.page.hasLeftsideBack)}))}},e.TooltipHelper=function(t){let l={},a={};this.init=async()=>{a=t.helper.model.getData(["b/tooltipContent","b/tooltipAdditionalInfo","b/tooltipDelay","b/sidebarPosition"]);const e=t.helper.model.getData("a/styles");a.scrollBarWidth=+e.scrollBarWidth.toString().replace("px","")},this.create=n=>{const s=n.attr(e.attr.id);if(s&&!1===t.helper.entry.isSeparator(s)){t.helper.toggle.addSidebarHoverClass(),o(s);const d=t.elm.iframeBody.find("div."+e.cl.tooltip.wrapper+"["+e.attr.id+"='"+s+"']");if(d.length()>0)0!==d[0].getBoundingClientRect().top&&d.addClass(e.cl.visible);else if(-1!=+a.tooltipDelay){const o=t.helper.entry.getDataById(s);if(o){const d=e("<div></div>").addClass(e.cl.tooltip.wrapper).attr(e.attr.id,s).appendTo(t.elm.iframeBody);r(d,o),l[s]&&(clearTimeout(l[s]),l[s]=null),l[s]=setTimeout((()=>{d.addClass(e.cl.visible),d.css("top",n[0].getBoundingClientRect().top+n.realHeight()/2-d.realHeight()/2+"px"),i(d,n)}),1e3*+a.tooltipDelay)}}}else o()},this.close=()=>{o()};const r=(l,r)=>{if("all"!==a.tooltipContent&&"title"!==a.tooltipContent||e("<h3></h3>").text(r.title).appendTo(l),r.isDir?e("<span></span>").text(r.children.length+" "+t.helper.i18n.get("sidebar_dir_children")).appendTo(l):"all"!==a.tooltipContent&&"url"!==a.tooltipContent||e("<span></span>").text(r.url).appendTo(l),t.helper.search.isResultsVisible()){const a=t.helper.entry.getParentsById(r.id);if(a.length>0){const t=e("<ul></ul>").addClass(e.cl.sidebar.breadcrumb).appendTo(l);a.forEach((l=>{e("<li></li>").text(l.title).prependTo(t)}))}}if(a.tooltipAdditionalInfo&&r.additionalInfo&&r.additionalInfo.desc){const t=r.additionalInfo.desc.replace(/\n/g,"<br />");e("<p></p>").html(t).appendTo(l)}},i=(e,l)=>{const r=t.helper.i18n.isRtl(),i={l:t.elm.sidebar.realWidth()-a.scrollBarWidth,r:l.realWidth()+10};"right"===a.sidebarPosition?e.css("right",i[r?"l":"r"]+"px"):e.css("left",i[r?"r":"l"]+"px")},o=(a=null)=>{Object.values(l).forEach((e=>{e&&clearTimeout(l[e])})),l={};const r=t.elm.iframeBody.find("div."+e.cl.tooltip.wrapper+(a?":not(["+e.attr.id+"='"+a+"'])":""));let i=!1;r.forEach((t=>{if(e(t).hasClass(e.cl.visible))return i=!0,!1})),r.removeClass(e.cl.visible),e.delay(i?300:0).then((()=>{r.remove(),t.helper.toggle.removeSidebarHoverClass()}))}},e.UtilityHelper=function(t){this.openUrl=async(e,l="default",a=!0)=>{if("about:blank"!==e.url)if(t.helper.model.setData({"u/lastOpened":e.id,"u/performReopening":a&&e.reopenSidebar||!1}),"incognito"===l)await t.helper.model.call("openLink",{href:e.url,incognito:!0});else if("newWindow"===l)await t.helper.model.call("openLink",{href:e.url,newWindow:!0});else{const r="newTab"===l;e.url.startsWith("javascript:")&&!1===r?location.href=e.url:await t.helper.model.call("openLink",{parentId:e.parentId,id:e.id,href:e.url,newTab:"newTab"===l,position:t.helper.model.getData("b/newTabPosition"),active:a})}},this.openAllBookmarks=async e=>{const l=t.helper.model.getData("b/newTabPosition");"afterCurrent"!==l&&"beforeFirst"!==l||e.reverse();for(const t of e)await this.openUrl(t,"newTab",!1)},this.isBackgroundConnected=()=>{try{const t=e.api.runtime.connect();if(t)return t.disconnect(),!0}catch(e){}return!1},this.triggerEvent=(t,l={},a=null)=>{(a||document).dispatchEvent(new CustomEvent(e.opts.events[t],{detail:l,bubbles:!0,cancelable:!1}))},this.copyToClipboard=l=>{const a=e("<textarea></textarea>").text(l).appendTo(t.elm.iframeBody);a[0].select();let r=!1;try{r=t.elm.iframe[0].contentDocument.execCommand("copy")}catch(e){}return a.remove(),r},this.isUrlOnBlacklist=e=>{if(!e||0===e.trim().length)return!0;let t=!1;return["about:","https?://192.168.","192.168.","https?://localhost","localhost","https?://127.0.0.","127.0.0.","javascript:","file://","chrome://","edge://","extension://","chrome-extension://"].some((l=>{if(0===e.search(new RegExp(l,"gi")))return t=!0,!0})),t},this.getSortList=()=>({custom:{dir:"ASC"},alphabetical:{dir:"ASC"},mostUsed:{dir:"DESC"},recentlyUsed:{dir:"DESC"},recentlyAdded:{dir:"DESC"}}),this.sortEntries=(e,l)=>{if(e.length>1){const a=t.helper.i18n.getLocaleSortCollator(),r=(t,a)=>{e.sort(((e,r)=>{const i=!!e.children,o=!!r.children;return"custom"!==l.name&&i!==o?i?-1:1:(t===l.dir?1:-1)*a(e,r)}))};switch(l.name){case"custom":r("ASC",((e,t)=>e.index-t.index));break;case"alphabetical":r("ASC",((e,t)=>a.compare(e.title,t.title)));break;case"recentlyAdded":r("DESC",((e,t)=>t.dateAdded-e.dateAdded));break;case"mostUsed":{const e=t.helper.model.getData("u/mostViewedPerMonth");r("DESC",((l,r)=>{const i=t.helper.entry.getDataById(l.id),o=t.helper.entry.getDataById(r.id),n=i?i.views[e?"perMonth":"total"]:0,s=o?o.views[e?"perMonth":"total"]:0;return n===s?a.compare(l.title,r.title):s-n}));break}case"recentlyUsed":r("DESC",((e,l)=>{const r=t.helper.entry.getDataById(e.id),i=t.helper.entry.getDataById(l.id),o=r?r.views.lastView:0,n=i?i.views.lastView:0;return o===n?a.compare(e.title,l.title):n-o}))}}},this.isWindowed=()=>window.screenX>100||window.screenY>50||Math.abs(window.screen.availWidth-window.innerWidth)>50||window.navigator&&window.navigator&&window.navigator.userAgent&&window.navigator.userAgent&&window.navigator.userAgent.search(/[/\s-_]mobile[/\s-_]/i)>-1,this.isWebapp=()=>window.matchMedia("(display-mode: standalone)").matches};(new function(){const t=Math.floor(99999*Math.random())+1e4;let l={},a=null,r=!1;this.initialized=null,this.refreshRun=!0,this.elm={},this.needsReload=!1,this.state=null,this.run=()=>{e("html").attr(e.attr.uid,t);const l=d();o(),e(document).on("visibilitychange.bs",(()=>{!0!==document.hidden&&(null===this.initialized?i():this.needsReload&&this.reload())}),{capture:!1}),i(!1===l)};const i=(t=!1)=>{!1!==r||!t&&!0===document.hidden||(r=!0,this.helper.model.init().then((()=>{n()?this.helper.i18n.init().then((()=>(this.helper.font.init(),this.helper.stylesheet.init(),this.helper.stylesheet.addStylesheets(["content"])))).then((()=>c())).then((()=>this.helper.stylesheet.addStylesheets(["sidebar"],this.elm.iframe))).then((()=>{this.elm.iframe&&this.elm.iframe[0]&&(this.elm.iframeBody.parent("html").attr("dir",this.helper.i18n.isRtl()?"rtl":"ltr"),this.helper.toggle.init(),this.helper.list.init(),this.helper.scroll.init(),this.helper.tooltip.init(),this.helper.sidebarEvents.init(),this.helper.dragndrop.init(),this.helper.keyboard.init(),""===document.referrer&&this.helper.model.call("addViewAmount",{url:location.href}))})):(e.api.extension.onMessage.addListener((e=>{e&&e.action&&"toggleSidebar"===e.action&&this.helper.model.call("setNotWorkingReason",{reason:this.state})})),this.log("Don't load sidebar for url '"+location.href+"'"))})))};this.reload=()=>{!1===r&&!1===document.hidden&&(this.needsReload=!1,r=!0,this.helper.model.init().then((()=>Promise.all([this.helper.i18n.init(),this.helper.entry.init()]))).then((()=>this.helper.list.updateBookmarkBox())).then((()=>{this.helper.selection.reset(),this.helper.search.update()})))},this.log=t=>{if(e.isDev){const e=["padding: 0 0 5px 0","font-size:90%","color:#666"].join(";");console.log("%c[] %cBookmark Sidebar %c-> %c"+t,e,e+";color:#30bfa9;font-weight:bold",e+";color:#000;font-weight:bold",e)}},this.loaded=()=>{if(!this.elm.iframeBody.hasClass(e.cl.sidebar.extLoaded)){const t=this.helper.model.getData(["b/animations","b/toggleArea","a/showIndicator"]);this.elm.iframeBody.addClass(e.cl.sidebar.extLoaded),this.helper.list.updateSidebarHeader(),this.helper.search.init(),this.elm.iframe.hasClass(e.cl.page.visible)&&this.helper.toggle.markLastUsed(),!0===t.animations&&this.elm.iframe.removeClass(e.cl.page.noAnimations),s(),this.initialized=+new Date,this.state="loaded",this.log("Finished loading in "+(this.initialized-this.updateBookmarkBoxStart)+"ms"),this.log("User type: "+this.helper.model.getUserType()),this.helper.utility.triggerEvent("loaded",{config:{toggleArea:t.toggleArea,showIndicator:t.showIndicator},elm:{iframe:this.elm.iframe,sidebar:this.elm.sidebar},helper:this.helper})}r=!1},this.startLoading=()=>{this.elm.sidebar.addClass(e.cl.loading),l.timeout&&clearTimeout(l.timeout),void 0!==l.loader&&0!==l.loader.length()||(l.loader=this.helper.template.loading().appendTo(this.elm.sidebar))},this.endLoading=(t=500)=>{l.timeout=setTimeout((()=>{this.elm.sidebar.removeClass(e.cl.loading),l.loader&&l.loader.remove(),l={}}),t)},this.initImages=()=>{e.delay().then((()=>{this.elm.iframe.hasClass(e.cl.page.visible)&&this.elm.sidebar.find("img["+e.attr.src+"]").forEach((t=>{const l=e(t),a=l.attr(e.attr.src);l.removeAttr(e.attr.src),l.attr("src",a)}))}))},this.addReloadMask=()=>{this.elm.sidebar.text("");const t=e("<div></div>").attr("id",e.opts.ids.sidebar.reloadInfo).prependTo(this.elm.sidebar),l=e("<div></div>").prependTo(t);e("<p></p>").html(this.helper.i18n.get("status_background_disconnected_reload_desc")).appendTo(l),e("<a></a>").text(this.helper.i18n.get("status_background_disconnected_reload_action")).appendTo(l)},this.addInfoBox=t=>{this.elm.sidebar.find("#"+e.opts.ids.sidebar.infoBox).remove();const l=e("<div></div>").attr("id",e.opts.ids.sidebar.infoBox).attr(e.attr.type,t).prependTo(this.elm.sidebar);"premium"===t?e("<p></p>").text(this.helper.i18n.get("premium_popup_text")).appendTo(l):"translation"===t?e("<p></p>").text(this.helper.i18n.get("settings_translation_incomplete_info")).appendTo(l):"shareInfo"===t&&e("<p></p>").text(this.helper.i18n.get("contribute_notice")).appendTo(l),e("<a></a>").text(this.helper.i18n.get("more_link")).addClass(e.cl.info).appendTo(l),e("<a></a>").text(this.helper.i18n.get("overlay_close")).addClass(e.cl.close).appendTo(l),e.delay(500).then((()=>{l.addClass(e.cl.visible)}))};const o=()=>{this.helper={model:new e.ModelHelper(this),toggle:new e.ToggleHelper(this),entry:new e.EntryHelper(this),selection:new e.SelectionHelper(this),list:new e.ListHelper(this),scroll:new e.ScrollHelper(this),template:new e.TemplateHelper(this),i18n:new e.I18nHelper(this),font:new e.FontHelper(this),sidebarEvents:new e.SidebarEventsHelper(this),search:new e.SearchHelper(this),stylesheet:new e.StylesheetHelper(this),dragndrop:new e.DragDropHelper(this),checkbox:new e.CheckboxHelper(this),keyboard:new e.KeyboardHelper(this),bookmark:new e.BookmarkHelper(this),overlay:new e.OverlayHelper(this),utility:new e.UtilityHelper(this),contextmenu:new e.ContextmenuHelper(this),tooltip:new e.TooltipHelper(this),linkchecker:new e.Linkchecker(this)}},n=()=>{let t=!0;const l=this.helper.model.getData("b/visibility");if("always"===l||0===location.href.indexOf(e.api.extension.getURL("html/newtab.html")))t=!0;else if("blacklist"===l||"whitelist"===l){const e=this.helper.model.getData("b/"+l);let a=!1;e.some((e=>{e=(e=(e=e.replace(/^https?:\/\//i,"")).replace(/([.?&])/g,"\\$1")).replace(/\*/g,".*");const t=new RegExp(e);if(-1!==location.href.search(t))return a=!0,!0})),"blacklist"===l?(t=!1===a,!1===t&&(this.state="blacklisted")):"whitelist"===l&&(t=!0===a,!1===t&&(this.state="notWhitelisted"))}return t},s=()=>{null!==a&&clearTimeout(a),a=setTimeout((()=>{const l=e("html").attr(e.attr.uid);if(void 0===l||t===+l){const t=e("iframe#"+e.opts.ids.page.iframe);0!==t.length()&&t[0].contentDocument&&t[0].contentDocument.body&&0!==t[0].contentDocument.body.childElementCount?s():(this.log("Detected: Sidebar missing from DOM"),d(),i(!0))}}),2e3)},d=()=>{let t=!1;const l=[];["iframe#"+e.opts.ids.page.iframe,"iframe#"+e.opts.ids.page.overlay,"div#"+e.opts.ids.page.indicator].forEach((t=>{l.push(e(t))}));const a=e(l);return e(document).off("*.bs"),e(window).off("*.bs"),a.length()>0&&(a.remove(),t=!0,this.log("Destroyed old instance")),t},c=async()=>{const t=this.helper.model.getData(["a/theme","a/darkMode","a/highContrast"]);this.elm.iframe=e('<iframe id="'+e.opts.ids.page.iframe+'"></iframe>').addClass(["notranslate",e.cl.page.noAnimations]).attr("aria-hidden","true").attr(e.attr.theme,t.theme).appendTo("body"),this.elm.iframeBody=this.elm.iframe.find("body"),this.elm.iframeBody.attr(e.attr.theme,t.theme).attr("aria-hidden","true"),this.elm.sidebar=e('<section id="'+e.opts.ids.sidebar.sidebar+'"></section>').appendTo(this.elm.iframeBody),this.elm.bookmarkBox={},["all","search"].forEach((t=>{this.elm.bookmarkBox[t]=this.helper.scroll.add(e.opts.ids.sidebar.bookmarkBox[t],e("<ul></ul>").appendTo(this.elm.sidebar))})),this.elm.widthDrag=e("<span></span>").addClass(e.cl.drag.trigger),"premium"===this.helper.model.getUserType()&&(this.elm.widthDrag=this.elm.widthDrag.appendTo(this.elm.sidebar)),this.elm.filterBox=e("<div></div>").addClass([e.cl.sidebar.filterBox,e.cl.hidden]).appendTo(this.elm.sidebar),this.elm.pinnedBox=e("<div></div>").addClass(e.cl.sidebar.entryPinned).prependTo(this.elm.bookmarkBox.all),this.elm.lockPinned=e("<a></a>").addClass(e.cl.sidebar.lockPinned).html("<span></span>").appendTo(this.elm.sidebar),this.elm.header=e("<header></header>").prependTo(this.elm.sidebar),!0===t.darkMode?this.elm.iframeBody.addClass(e.cl.page.darkMode):!0===t.highContrast&&this.elm.iframeBody.addClass(e.cl.page.highContrast),this.helper.utility.triggerEvent("elementsCreated",{elm:{iframe:this.elm.iframe,sidebar:this.elm.sidebar},helper:this.helper})}}).run()})(jsu);