/*! (c) Philipp König under GPL-3.0 */
(e=>{"use strict";e.AnalyticsHelper=function(t){let a=!1,n=[];const i={config:["configuration"],activity:["bookmarks","action"]},s=["behaviour","appearance","newtab","language"];this.init=async()=>{setInterval((()=>{n.length>0&&h()}),6e4)},this.track=e=>new Promise((t=>{l(e.name,e.value,e.always),t()})),this.trackUserData=async()=>{const n=+t.helper.model.getData("lastTrackDate"),i=+(new Date).setHours(0,0,0,0);if(!1===a&&i>n){if(a=!0,await t.helper.model.setData("lastTrackDate",i),await t.helper.model.init(),n&&t.helper.model.getData("lastTrackDate")){const a=t.helper.model.getShareInfo();let n="not_set";!0===a.config&&!0===a.activity?n="all":!0===a.config&&!1===a.activity?n="config":!1===a.config&&!0===a.activity?n="activity":!1===a.config&&!1===a.activity&&(n="nothing"),l("version",e.opts.manifest.version_name),l("system",navigator.userAgent),l("language",t.helper.language.getLanguage()),l("shareInfo",n),l("runtimeId",e.api.runtime.id),l("userType",(await t.helper.model.getUserType()).userType);const i=t.helper.model.getData("installationDate");i&&l("installationYear",new Date(i).getFullYear()),!0===a.activity&&r(),!0===a.config&&o()}a=!1}};const r=()=>{t.helper.bookmarks.api.getSubTree(0).then((e=>{let t=0;const a=e=>{for(let n=0;n<e.length;n++){const i=e[n];i.url?t++:i.children&&a(i.children)}};e&&e[0]&&e[0].children&&e[0].children.length>0&&a(e[0].children),l("bookmarks",t)}))},o=()=>{const t=(e,a)=>{Object.entries(a).forEach((([a,n])=>{if("newtab_searchEngineCustom"!==e){if("newtab"===e&&"topLinks"===a)n=n.length;else if("newtab"===e&&"shortcuts"===a)n=n.length;else{if("newtab"===e&&"customGridLinks"===a)return;"utility"===e&&"pinnedEntries"===a&&"object"==typeof n?n=Object.keys(n).length:"behaviour"!==e||"blacklist"!==a&&"whitelist"!==a?"appearance_styles"===e&&"fontFamily"===a&&(n=n.replace(/(^'*)|('*$)/g,"")):n=n.length}"object"==typeof n?t(e+"_"+a,n):("string"!=typeof n&&(n=JSON.stringify(n)),("newtab"===e&&"website"===a||"utility"===e&&"customCss"===a||"utility"===e&&"newtabBackground"===a)&&(n=n&&n.length>0?"true":"false"),l("configuration",{name:e+"_"+a,value:n}))}}))};let a=!1;new Promise((n=>{e.api.storage.sync.get(s,(e=>{s.forEach((n=>{"newtab"===n&&("object"==typeof e[n]&&void 0!==e[n].override&&!0===e[n].override?a=!0:e[n]={override:!1}),"object"==typeof e[n]&&t(n,e[n])})),n()}))})).then((()=>new Promise((n=>{e.api.storage.local.get(["utility","newtabBackground_1"],(e=>{if(e.utility){const n={};["lockPinned","pinnedEntries","customCss"].forEach((t=>{void 0!==e.utility[t]&&(n[t]=e.utility[t])})),a&&(n.newtabBackground=e.newtabBackground_1||""),t("utility",n)}n()}))}))))},l=(a,s,r=!1)=>{let o=!0;if(!1===r){const e=t.helper.model.getShareInfo();Object.entries(i).some((([t,n])=>{if(n.indexOf(a)>-1)return o=!0===e[t],!0}))}if(!0===o&&!1===e.isDev){const e={type:a};"object"==typeof s?e.values=s:e.value=""+s,n.push(e)}},c=e=>{const t=(JSON.stringify(e)||"").replace(/[\s\n\r\t]/g,"");let a=0;if(0===t.length)return a;for(let e=0;e<t.length;e++){a=(a<<5)-a+t.charCodeAt(e),a|=0}return Math.abs(a)},h=(t={})=>{let a=[];return t&&t.stack&&t.count?a=t.stack:(a=[...n],n=[],t={stack:a,count:0}),new Promise((n=>{e.xhr(e.opts.website.api.evaluate,{method:"POST",responseType:"json",timeout:3e4,data:{stack:a,uid:c(a),tz:(new Date).getTimezoneOffset()}}).then((e=>{e.response&&e.response.success?n({success:e.response.success}):n({success:!1})}),(()=>{t.count<50?e.delay(3e4*(t.count+1)).then((()=>(t.count++,h(t)))).then(n):n({success:!1})}))}))}},e.Bookmarks=function(t){this.api={},this.init=()=>new Promise((e=>{["get","getSubTree","removeTree"].forEach((e=>{this.api[e]=t=>a(e,"object"==typeof t?[t]:[""+t])})),["update","move"].forEach((e=>{this.api[e]=(t,n)=>a(e,[""+t,n])})),["create","search"].forEach((e=>{this.api[e]=t=>a(e,[t])})),e()}));const a=(a,n)=>new Promise(((i,s)=>{e.api.bookmarks[a](...n,(n=>{const r=e.api.runtime.lastError;void 0===r?-1!==["update","move","create","removeTree"].indexOf(a)?Promise.all([t.helper.cache.remove({name:"htmlList"}),t.helper.cache.remove({name:"htmlPinnedEntries"})]).then((()=>{i(n)})):i(n):s(r.message)}))}));this.getById=e=>new Promise((t=>{this.api.getSubTree(e.id).then((e=>{t({bookmarks:e})}))})),this.getBySearchVal=e=>new Promise((t=>{this.api.search(e.searchVal).then((e=>{t({bookmarks:e})}))})),this.update=e=>new Promise((a=>{new Promise((a=>{const n={title:e.title};e.url&&(n.url=e.url),e.preventReload&&(t.preventReload=!0),this.api.update(e.id,n).then((()=>{a({updated:e.id})}),(e=>{a({error:e})}))})).then((n=>{e.preventReload&&(t.preventReload=!1),a(n)}))})),this.create=e=>new Promise((a=>{new Promise((a=>{const n={parentId:e.parentId,index:e.index||0,title:e.title,url:e.url?e.url:null};e.preventReload&&(t.preventReload=!0),this.api.create(n).then((e=>{a({created:e.id})}),(e=>{a({error:e})}))})).then((n=>{e.preventReload&&(t.preventReload=!1),a(n)}))})),this.remove=e=>new Promise((a=>{new Promise((a=>{e.preventReload&&(t.preventReload=!0),this.api.removeTree(e.id).then((()=>{a({deleted:e.id})}),(e=>{a({error:e})}))})).then((n=>{e.preventReload&&(t.preventReload=!1),a(n)}))})),this.move=e=>new Promise((t=>{const a={parentId:""+e.parentId,index:e.index};this.api.move(e.id,a).then((()=>{t({moved:e.id})}))}))},e.BrowserActionHelper=function(t){let a=null,n=null;this.init=()=>new Promise((e=>{s(),this.initContextmenus(),e()})),this.initContextmenus=async()=>new Promise((a=>{t.helper.language.getLangVars().then((n=>{e.api.contextMenus.removeAll((()=>{const i=Math.random().toString(36).substr(2,12);e.api.contextMenus.create({id:"bsChangelog_"+i,title:n.vars.settings_menu_infos_changelog.message,contexts:["browser_action"]}),e.api.contextMenus.create({id:"bsPrivacy_"+i,title:n.vars.settings_menu_infos_privacy.message,contexts:["browser_action"]}),e.api.contextMenus.onClicked.addListener((e=>{e.menuItemId==="bsChangelog_"+i?t.helper.utility.openLink({hrefName:"changelog",newTab:!0,params:{lang:t.helper.language.getUILanguage()}}):e.menuItemId==="bsPrivacy_"+i&&t.helper.utility.openLink({hrefName:"privacyPolicy",newTab:!0,params:{lang:t.helper.language.getUILanguage()}})})),a()}))}))})),this.setReason=e=>new Promise((t=>{e.reason&&(n=e.reason),t()})),this.clearTimeout=()=>new Promise((e=>{a&&(clearTimeout(a),a=null),e()}));const i=e=>{let a=null,n=!1;const i={new_tab:[t.helper.utility.getParsedUrl("chrome://newtab/")],system:["chrome://","edge://","about:blank"],extension_page:["chrome-extension://","extension://"],webstore:["https?://chrome.google.com/webstore/"]};return Object.keys(i).some((t=>{if(i[t].some((i=>{if(0===e.search(new RegExp(i,"gi")))return a=t,n=!0,!0})),n)return!0})),a},s=async()=>{e.api.browserAction.onClicked.removeListener(r),e.api.browserAction.onClicked.addListener(r)},r=()=>{e.api.tabs.query({active:!0,currentWindow:!0},(s=>{e.api.tabs.sendMessage(s[0].id,{action:"toggleSidebar",reinitialized:t.reinitialized});let r=700;if(s[0]&&s[0].url){i(s[0].url)&&(r=0)}a=setTimeout((()=>{(a=>{let s="fallback";if(n)s=n,n=null;else if(a&&a.url){const e=i(a.url);e&&(s=e)}t.helper.utility.openLink({href:e.api.extension.getURL("html/newtab.html"),newTab:!0,params:{type:s}})})(s[0])}),r)}))}},e.CacheHelper=function(t){this.set=t=>new Promise((a=>{try{e.api.storage.local.set({["cache_"+t.name]:t.val},(()=>{a()}))}catch(e){a()}})),this.get=t=>new Promise((a=>{e.api.storage.local.get(["cache_"+t.name],(e=>{a({val:e["cache_"+t.name]})}))})),this.remove=a=>new Promise((n=>{t.importRunning?n():e.api.storage.local.remove(["cache_"+a.name],(()=>{n()}))}))},e.IconHelper=function(t){const a={forLight:"#555555",forDark:"#ffffff"};let n={},i=null;this.init=()=>new Promise((e=>{Promise.all([r(),t.helper.language.getLangVars()]).then((([t,a])=>{n={},i=null,s(t,a),e()}))}));const s=(t,a)=>{this.setExtensionIcon({name:t.name,color:t.color}),e.api.browserAction.setTitle({title:a.vars.header_bookmarks.message}),e.isDev&&t.devModeIconBadge?(e.api.browserAction.setBadgeBackgroundColor({color:[48,191,169,255]}),e.api.browserAction.setBadgeText({text:" "})):e.api.browserAction.setBadgeText({text:""})},r=()=>new Promise((t=>{e.api.storage.sync.get(["appearance"],(e=>{let a="bookmark",n="auto",i=!0;e&&e.appearance&&e.appearance.styles&&(void 0!==e.appearance.devModeIconBadge&&(i=e.appearance.devModeIconBadge),e.appearance.styles&&(e.appearance.styles.iconShape&&(a=e.appearance.styles.iconShape),e.appearance.styles.iconColor&&(n=e.appearance.styles.iconColor))),t({name:a,color:n,devModeIconBadge:i})}))}));this.getImageData=t=>new Promise((i=>{const s=document.createElement("canvas"),r=128;s.width=r,s.height=r;const o=s.getContext("2d");var l,c;t.background&&(o.beginPath(),o.fillStyle=t.background,o.arc(64,64,64,0,2*Math.PI,!1),o.fill()),(l=t.name,c=t.color,new Promise((t=>{new Promise((t=>{n[l]?t(n[l]):e.xhr(e.api.extension.getURL("img/icon/action/icon-"+l+".svg")).then((e=>{const a=e.responseText;n[l]="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(a),t(n[l])}))})).then((e=>{"auto"===c&&(c=a[window.matchMedia("(prefers-color-scheme: dark)").matches?"forDark":"forLight"]),c=c.replace(/#/g,"%23"),e=e.replace(/(#|%23)000/g,c),t(e)}))}))).then((e=>{const a=new Image;a.onload=()=>{const e=t.padding||0;o.drawImage(a,e,e,r-2*e,r-2*e);let n=null;n=t.asDataURL?s.toDataURL("image/x-icon"):o.getImageData(0,0,r,r),i(n)},a.src=e}))})),this.setExtensionIcon=t=>new Promise((a=>{const n=t.onlyCurrentTab||!1;i&&!n&&i===t.name+"_"+t.color?a():this.getImageData(t).then((a=>{e.api.browserAction.setIcon({imageData:a,tabId:n&&t.tabInfo?t.tabInfo.id:null}),n||(i=t.name+"_"+t.color)}))}))},e.ImageHelper=function(t){let a={};this.init=()=>new Promise((t=>{e.api.storage.local.get(["imageCache"],(e=>{a=e.imageCache||{},t()}))})),this.getFavicon=e=>new Promise((t=>{const a=new Image;a.onload=function(){const e=document.createElement("canvas");e.width=this.width,e.height=this.height;e.getContext("2d").drawImage(this,0,0);const a=e.toDataURL("image/png");t({img:a})},a.crossOrigin="anonymous",a.src="chrome://favicon/size/16@2x/"+e.url}))},e.LanguageHelper=function(t){const a={ar:"Arabic",am:"Amharic",bg:"Bulgarian",bn:"Bengali",ca:"Catalan",cs:"Czech",da:"Danish",de:"German",el:"Greek",en:"English",en_US:"English (US)",es:"Spanish",et:"Estonian",fa:"Persian",fi:"Finnish",fil:"Filipino",fr:"French",gu:"Gujarati",he:"Hebrew",hi:"Hindi",hr:"Croatian",hu:"Hungarian",id:"Indonesian",it:"Italian",ja:"Japanese",kn:"Kannada",ko:"Korean",lt:"Lithuanian",lv:"Latvian",ml:"Malayalam",mr:"Marathi",ms:"Malay",nl:"Dutch",no:"Norwegian",pl:"Polish",pt_BR:"Portuguese (Brazil)",pt_PT:"Portuguese (Portugal)",ro:"Romanian",ru:"Russian",sk:"Slovak",sl:"Slovenian",sr:"Serbian",sv:"Swedish",sw:"Swahili",ta:"Tamil",te:"Telugu",th:"Thai",tr:"Turkish",uk:"Ukrainian",vi:"Vietnamese",zh_CN:"Chinese (Simplified)",zh_TW:"Chinese (Traditional)"},n=["ar","fa","he"],i={pt:"pt_PT"};let s=null,r={},o=!1;this.init=()=>new Promise((t=>{e.api.storage.sync.get(["language"],(a=>{const c=e.opts.manifest.default_locale;let h=a.language||"default",p=null;"default"===h&&(h=this.getUILanguage()),h=h.replace("-","_"),i[h]&&(h=i[h]),h.indexOf("_")>-1&&(p=h.replace(/_.*$/,"")),this.getAvailableLanguages().then((e=>{[h,p,c].some((a=>{if(null!==a&&e&&e.infos&&e.infos[a]&&e.infos[a].available)return s=a,o=n.indexOf(s)>-1,l(a,c).then((e=>{e&&e.langVars&&(r=e.langVars,t())})),!0}))}))}))})),this.getUILanguage=()=>{let t=e.api.i18n.getUILanguage();return t=t.replace("-","_"),t},this.getLanguage=()=>s,this.getRtlLanguages=async()=>n,this.getLangVars=()=>new Promise((e=>{e({language:s,dir:o?"rtl":"ltr",vars:r})})),this.getAvailableLanguages=()=>new Promise((t=>{e.api.storage.local.get(["languageInfos"],(n=>{if(n&&n.languageInfos&&(+new Date-n.languageInfos.updated)/36e5<8)t({infos:n.languageInfos.infos});else{const n=Object.keys(a).length;let i=0;const s={};Object.keys(a).forEach((r=>{s[r]={name:r,label:a[r],available:!1};const o=()=>{++i===n&&(e.api.storage.local.set({languageInfos:{infos:s,updated:+new Date}}),t({infos:s}))};e.xhr(e.api.extension.getURL("_locales/"+r+"/messages.json"),{method:"HEAD"}).then((()=>{s[r].available=!0,o()}),o)}))}}))})),this.getIncompleteLanguages=()=>new Promise((t=>{e.xhr(e.opts.website.translation.info).then((e=>{const a=JSON.parse(e.responseText),n=[];if(a&&a.languages&&a.categories){let e=0;Object.values(a.categories).forEach((t=>{e+=t.total})),a.languages.forEach((t=>{t.varsAmount<e&&n.push(t.name)}))}t(n)}))}));const l=(t,a=null)=>new Promise((n=>{if(t){const i=a=>{const i=a.langVars;e.xhr(e.api.extension.getURL("_locales/"+t+"/messages.json")).then((e=>{const t=JSON.parse(e.responseText);Object.assign(i,t),n({langVars:i})}))};a&&a!==t?l(a,null).then(i):i({langVars:{}})}}))},e.Linkchecker=function(t){const a={"youtube.com":["v"],"google.com":["q"],"google.de":["q"]};this.check=e=>new Promise((t=>{Promise.all([n(e.url),i(e.url)]).then((([e,a])=>{t({httpInfo:e,duplicateInfo:a})}),(()=>{t({error:!0})}))}));const n=(t,a="HEAD")=>new Promise((i=>{const s=()=>{"HEAD"===a?n(t,"GET").then(i):i({url:t,success:!1,status:null})};e.xhr(t,{method:a,timeout:7e3}).then((e=>{e.responseURL?e.responseURL.startsWith("http:")?n(e.responseURL.replace(/^http:/,"https:"),a).then((t=>{t.url&&t.success&&t.status<400?i(t):i({url:e.responseURL,success:!0,status:e.status})})):i({url:e.responseURL,success:!0,status:e.status}):s()})).catch((e=>{e&&e.status&&404!==e.status?i({url:t,success:!0,status:e.status}):s()}))})),i=async e=>{const n=e=>{let t=null;try{t=new URL(e)}catch(e){}const n=(e=(e=(e=(e=(e=e.split("?")[0]).split("#")[0]).replace(/^https?:\/\//,"")).replace(/^www\./,"")).replace(/\/$/,"")).split("/")[0];if(t&&a[n]){const i=[];a[n].forEach((e=>{const a=t.searchParams.get(e);a&&i.push(e+"="+a)})),e+="?"+i.join("&")}return e},i=n(e),s=await t.helper.bookmarks.api.search(i);if(s.length>1){const e=[];if(s.forEach((t=>{n(t.url)===i&&e.push(t)})),e.length>1)return{label:i,duplicates:e}}return{label:i,duplicates:[]}}},e.ModelHelper=function(t){let a={},n=null,i=[],s={config:null,activity:null};this.init=()=>new Promise((t=>{e.api.storage.sync.get(["model","shareInfo","translationInfo","licenseKey"],(e=>{a=e.model||{},"object"==typeof e.shareInfo&&(s=e.shareInfo),"string"==typeof e.licenseKey&&29===e.licenseKey.length&&(n=e.licenseKey),"object"==typeof e.translationInfo&&(i=e.translationInfo),void 0===a.installationDate&&(a.installationDate=+new Date),void 0===a.lastUpdateDate&&(a.lastUpdateDate=+new Date),void 0===a.premiumInfo&&(a.premiumInfo=null),void 0===a.translationReminder&&(a.translationReminder=null),r().then(t)}))})),this.getShareInfo=()=>s,this.getLicenseKey=()=>new Promise((e=>{e({licenseKey:n})})),this.getInfoToDisplay=()=>new Promise((e=>{if(a&&a.installationDate){const n=(+new Date-a.installationDate)/864e5,r=null===a.translationReminder?365:(+new Date-a.translationReminder)/864e5;null===s.config&&null===s.activity&&n>7?e({info:"shareInfo"}):i.length>0&&r>3?Promise.all([t.helper.language.getIncompleteLanguages(),this.setData("translationReminder",+new Date)]).then((([t])=>{i.some((a=>{-1!==t.indexOf(a)&&e({info:"translation"})})),e({info:null})})):this.getUserType().then((t=>{const i=null===a.premiumInfo?365:(+new Date-a.premiumInfo)/864e5;"premium"!==t.userType&&i>200&&n>14?this.setData("premiumInfo",+new Date).then((()=>{e({info:"premium"})})):e({info:null})}))}else e({info:null})})),this.getUserType=()=>new Promise((e=>{let t="default";"string"==typeof n&&29===n.length?t="premium":a&&a.installationDate&&a.installationDate<1538352e6&&(t="legacy"),e({userType:t})})),this.setShareInfo=t=>new Promise((a=>{s={config:t.config||!1,activity:t.activity||!1},e.api.storage.sync.set({shareInfo:s},(()=>{e.api.runtime.lastError,a()}))})),this.setLicenseKey=t=>new Promise((a=>{e.api.storage.sync.set({licenseKey:t},(()=>{e.api.runtime.lastError?a({success:!1,message:e.api.runtime.lastError.message}):(n=t,a({success:!0}))}))})),this.setData=(e,t)=>new Promise((n=>{a[e]=t,r().then(n)})),this.getData=e=>a[e]||null;const r=()=>new Promise((t=>{Object.getOwnPropertyNames(a).length>0&&e.api.storage.sync.set({model:a},(()=>{e.api.runtime.lastError,t()}))}))},e.NewtabHelper=function(t){let a={};this.init=()=>new Promise((e=>{this.updateConfig().then((()=>{n(),e()}))})),this.reload=()=>{e.api.permissions.contains({permissions:["tabs"]},(t=>{t&&e.api.tabs.query({url:"chrome-extension://*/html/newtab.html"},(t=>{t.forEach((t=>{e.api.tabs.reload(t.id)}))}))}))},this.updateConfig=()=>new Promise((t=>{e.api.storage.sync.get(["newtab"],(e=>{a=void 0===e.newtab?{}:e.newtab,t()}))}));const n=async()=>{e.api.tabs.onCreated.addListener((n=>{const s=n.url||n.pendingUrl;if(s&&(s===t.helper.utility.getParsedUrl("chrome://newtab/")||s===t.helper.utility.getParsedUrl("chrome://startpage/"))&&void 0!==a.override&&!0===a.override){let t=e.api.extension.getURL("html/newtab.html");a.website&&a.website.length>0&&(t=i(a.website,"bs_nt",1)),a.focusOmnibox||0===n.index?e.api.tabs.update(n.id,{url:t,active:!0}):(e.api.tabs.remove(n.id,(()=>{e.api.runtime.lastError})),e.api.tabs.create({url:t,active:!0}))}}))},i=(e,t,a)=>{const n=new RegExp("([?&])"+t+"=.*?(&|#|$)","i");if(e.match(n))return e.replace(n,"$1"+t+"="+a+"$2");{let n="";-1!==e.indexOf("#")&&(n=e.replace(/.*#/,"#"),e=e.replace(/#.*/,""));const i=-1!==e.indexOf("?")?"&":"?";return e+i+t+"="+a+n}}},e.PortHelper=function(t){this.init=async()=>{let a=0;const n={checkUrl:t.helper.linkchecker.check,bookmarks:t.helper.bookmarks.getById,searchBookmarks:t.helper.bookmarks.getBySearchVal,moveBookmark:t.helper.bookmarks.move,updateBookmark:t.helper.bookmarks.update,createBookmark:t.helper.bookmarks.create,deleteBookmark:t.helper.bookmarks.remove,openWebsite:t.openWebsite,reload:t.reload,reinitialize:t.reinitialize,updateShareInfo:t.helper.model.setShareInfo,infoToDisplay:t.helper.model.getInfoToDisplay,languageInfos:t.helper.language.getAvailableLanguages,langvars:t.helper.language.getLangVars,rtlLangs:t.helper.language.getRtlLanguages,favicon:t.helper.image.getFavicon,openLink:t.helper.utility.openLink,userType:t.helper.model.getUserType,activatePremium:t.helper.utility.activatePremium,deactivatePremium:t.helper.utility.removePremiumState,licenseKey:t.helper.model.getLicenseKey,getCache:t.helper.cache.get,setCache:t.helper.cache.set,removeCache:t.helper.cache.remove,websiteStatus:t.helper.utility.checkWebsiteStatus,track:t.helper.analytics.track,iconImageData:t.helper.icon.getImageData,updateIcon:t.helper.icon.setExtensionIcon,reloadIcon:t.helper.icon.init,reloadContextmenus:t.helper.browserAction.initContextmenus,clearNotWorkingTimeout:t.helper.browserAction.clearTimeout,setNotWorkingReason:t.helper.browserAction.setReason,addViewAmount:t.helper.viewAmount.addByUrl,viewAmounts:t.helper.viewAmount.getAll,searchHistory:t.helper.utility.getHistoryBySearchVal,lastUpdateDate:async()=>t.helper.model.getData("lastUpdateDate")};e.api.runtime.onConnect.addListener((e=>{e.name&&"background"===e.name&&e.onMessage.addListener(((i,s)=>{n[i.type]&&(100===a&&(t.helper.analytics.trackUserData(),a%=100),i.tabInfo=s.sender.tab,n[i.type](i).then((t=>{try{e.postMessage({uid:i.uid,result:t})}catch(e){}})),a++)}))}))}},e.UpgradeHelper=function(t){this.loaded=!1,this.init=async()=>{e.api.runtime.onUpdateAvailable.addListener((()=>{e.api.runtime.reload()})),this.loaded=!0},this.onInstalled=()=>{const n=t.helper.model.getData("installationDate");(null===n||+new Date-n<6e4)&&(t.helper.analytics.track({name:"action",value:{name:"install",value:"true"},always:!0}),a("install"),t.helper.utility.openLink({href:e.api.extension.getURL("html/intro.html"),newTab:!0})),t.reinitialize()},this.onUpdated=n=>{e.api.storage.local.remove(["languageInfos"]),t.helper.model.setData("lastUpdateDate",+new Date);const i=e.opts.manifest.version,s=n.previousVersion.split("."),r=i.split(".");s[0]!==r[0]||s[1]!==r[1]?a("upgrade").then((()=>{t.reinitialize()})):t.reinitialize()};const a=t=>new Promise((a=>{let s=0;const r=()=>{s++,s>=3&&a()};e.api.storage.sync.get(null,(a=>{void 0===a.behaviour&&(a.behaviour={}),void 0===a.appearance&&(a.appearance={}),void 0===a.appearance.styles&&(a.appearance.styles={}),void 0===a.newtab&&(a.newtab={}),"upgrade"===t?i(a):"install"===t&&n(a),e.api.storage.sync.set({behaviour:a.behaviour},r),e.api.storage.sync.set({newtab:a.newtab},r),e.api.storage.sync.set({appearance:a.appearance},r)}))})),n=e=>{"zh_CN"===t.helper.language.getUILanguage()?(e.newtab.searchEngine="baidu",e.newtab.topLinks=[{title:"百度",url:"https://www.baidu.com/"}]):e.newtab.topLinks=[{title:"Google",url:"https://google.com"}]},i=a=>{try{if(a.behaviour&&void 0===a.behaviour.preventWebapp&&(a.behaviour.preventWebapp=!1),a.newtab){if(a.newtab.topPagesType&&"pinnedEntries"!==a.newtab.topPagesType&&(a.newtab.gridType=a.newtab.topPagesType),a.newtab.topPagesMaxCols&&(a.newtab.gridMaxCols=a.newtab.topPagesMaxCols),a.newtab.topPagesMaxRows&&(a.newtab.gridMaxRows=a.newtab.topPagesMaxRows),a.newtab.shortcutsPosition&&(a.newtab.topLinksPosition=a.newtab.shortcutsPosition),a.newtab.shortcuts&&a.newtab.shortcuts.length>0){const e=[];a.newtab.shortcuts.forEach((t=>{e.push({title:t.label,url:t.url})})),a.newtab.topLinks=e}if(a.newtab.topPagesType=a.newtab.gridType,a.newtab.topPagesType&&"pinnedEntries"===a.newtab.topPagesType){const a=[];e.api.storage.local.get(["utility"],(n=>{if(n.utility&&n.utility.pinnedEntries){const i=[];Object.entries(n.utility.pinnedEntries).forEach((([e,t])=>{t.index>=0&&(i[t.index]=e)}));const s=i.filter((e=>e&&(""+e).length>0));t.helper.bookmarks.api.get(s).then((n=>{n.forEach((e=>{a.push({title:e.title,url:e.url})})),e.delay(5e3).then((()=>{e.api.storage.sync.get(["newtab"],(n=>{void 0===n.newtab&&(n.newtab={}),n.newtab.gridType="custom",n.newtab.customGridLinks=a,e.api.storage.sync.set({newtab:n.newtab},(()=>{t.reinitialize()}))}))}))}))}}))}}delete a.behaviour.contextmenu,delete a.behaviour.dndOpen,delete a.behaviour.initialOpenOnNewTab,delete a.behaviour.rememberSearch,delete a.behaviour.rememberScroll,delete a.behaviour.autoOpen,delete a.behaviour.pxTolerance,delete a.behaviour.scrollSensitivity,delete a.behaviour.hideEmptyDirs,delete a.behaviour.replaceNewTab,delete a.behaviour.language,delete a.behaviour.model,delete a.appearance.language,delete a.appearance.sidebarPosition,delete a.appearance.addVisual,delete a.appearance.indicatorWidth,delete a.appearance.indicatorIconSize,delete a.newtab.initialOpen,delete a.newtab.topPagesType,delete a.newtab.topPagesMaxCols,delete a.newtab.topPagesMaxRows,delete a.newtab.shortcutsPosition,delete a.newtab.shortcuts}catch(e){}}},e.UtilityHelper=function(t){this.getHistoryBySearchVal=t=>new Promise((a=>{e.api.history?e.api.history.search({text:t.searchVal,maxResults:100},(e=>{const n=t.searchVal.toLowerCase();e.sort(((e,t)=>(e.title.toLowerCase().indexOf(n)>-1?100:0)+(e.url.toLowerCase().indexOf(n)>-1?50:0)+e.visitCount+e.typedCount-((t.title.toLowerCase().indexOf(n)>-1?100:0)+(t.url.toLowerCase().indexOf(n)>-1?50:0)+t.visitCount+t.typedCount))),a({history:e})})):a({history:[]})})),this.removePremiumState=e=>new Promise((e=>{t.helper.model.setLicenseKey(null).then((()=>t.reinitialize({type:"premiumDeactivated"}))).then((()=>{e()}))})),this.activatePremium=e=>new Promise((a=>{t.helper.model.getLicenseKey().then((n=>{n.licenseKey===e.licenseKey?a({success:!0,skip:!0}):this.checkLicenseKey(e.licenseKey).then((n=>{let i={success:!1};!0===n.valid?(i.success=!0,t.helper.model.setLicenseKey(e.licenseKey).then((e=>(i=e,t.reinitialize({type:"premiumActivated"})))).then((()=>{a(i)}))):a(i)}))}))})),this.checkLicenseKey=t=>new Promise((a=>{e.xhr(e.opts.website.premium.checkLicenseKey,{method:"POST",responseType:"json",data:{licenseKey:t}}).then((e=>{e.response&&void 0!==e.response.valid?a({valid:e.response.valid}):a({valid:null})}),(()=>{a({valid:null})}))})),this.checkWebsiteStatus=()=>new Promise((t=>{e.xhr(e.opts.website.api.checkStatus,{method:"POST",responseType:"json",data:{version:e.isDev?"9.9.9":e.opts.manifest.version}}).then((e=>{e.response&&e.response.available?t({status:"available"}):t({status:"unavailable"})}),(()=>{t({status:"unavailable"})}))})),this.getParsedUrl=t=>t?(e.opts.urlAliases[e.browserName]&&e.opts.urlAliases[e.browserName][t]&&(t=e.opts.urlAliases[e.browserName][t]),t):t,this.openLink=a=>new Promise((n=>{if(t.helper.viewAmount.addByEntry(a),a.hrefName){if(!e.opts.website.info[a.hrefName])return void n();a.href=e.opts.website.info[a.hrefName]}let i="";a.params&&(i=Object.entries(a.params).map((([e,t])=>encodeURIComponent(e)+"="+t)).join("&"),i&&(i="?"+i));const s=this.getParsedUrl(a.href)+i;if(a.newTab&&!0===a.newTab){const i=(i=null)=>{e.api.tabs.query({active:!0,currentWindow:!0},(r=>{e.api.tabs.create({url:s,active:void 0===a.active||!!a.active,index:null===i?r[0].index+1:i,openerTabId:r[0].id},(e=>{t.helper.model.setData("openedByExtension",e.id).then(n)}))}))};"afterLast"===a.position?e.api.tabs.query({currentWindow:!0},(e=>{let t=0;e.forEach((e=>{t=Math.max(t,e.index)})),i(t+1)})):"beforeFirst"===a.position?i(0):i()}else a.newWindow&&!0===a.newWindow?(e.api.windows.create({url:s,state:"maximized"}),n()):a.incognito&&!0===a.incognito?(e.api.windows.create({url:s,state:"maximized",incognito:!0}),n()):e.api.tabs.query({active:!0,currentWindow:!0},(a=>{e.api.tabs.update(a[0].id,{url:s},(e=>{t.helper.model.setData("openedByExtension",e.id).then(n)}))}))}))},e.ViewAmountHelper=function(t){this.getAll=()=>new Promise((e=>{a().then((a=>{e({viewAmounts:a,counterStartDate:t.helper.model.getData("installationDate")})}))})),this.addByUrl=e=>new Promise((a=>{null===t.helper.model.getData("openedByExtension")&&t.helper.bookmarks.api.search({url:e.url}).then((t=>{t.some((t=>t.url===e.url&&(this.addByEntry(t),!0))),a()})),t.helper.model.setData("openedByExtension",null)})),this.addByEntry=t=>{t.id&&a().then((a=>{void 0!==a[t.id]&&"object"==typeof a[t.id]||(a[t.id]={c:0}),a[t.id].c++,a[t.id].d=+new Date,e.api.storage.local.set({clickCounter:a})}))};const a=()=>new Promise((t=>{e.api.storage.local.get(["clickCounter"],(e=>{let a={};void 0!==e.clickCounter&&(a=e.clickCounter),t(a)}))}))};(new function(){this.importRunning=!1,this.preventReload=!1,this.reinitialized=null,this.reload=t=>new Promise((a=>{Promise.all([this.helper.newtab.updateConfig(),this.helper.cache.remove({name:"htmlList"}),this.helper.cache.remove({name:"htmlPinnedEntries"})]).then((()=>{e.api.tabs.query({},(n=>{n.forEach(((a,n)=>{const i=a.active?0:100*n;e.delay(i).then((()=>{e.api.tabs.sendMessage(a.id,{action:"reload",scrollTop:t.scrollTop||!1,reinitialized:this.reinitialized,type:t.type})}))})),a()}))}))})),this.reinitialize=(a={})=>new Promise((n=>{this.reinitialized=+new Date;const i={css:"insertCSS",js:"executeScript"};Promise.all([this.helper.newtab.updateConfig(),this.helper.language.init(),this.helper.cache.remove({name:"htmlList"}),this.helper.cache.remove({name:"htmlPinnedEntries"})]).then((()=>{let s=null;a&&a.type&&(s=a.type),e.api.tabs.query({},(a=>{a.forEach(((a,n)=>{if(void 0===a.url||a.url.startsWith("http://")||a.url.startsWith("https://")||a.url.startsWith("file://")){const s=a.active?0:100*n;e.delay(s).then((()=>{Object.entries(i).forEach((([n,i])=>{const s=e.opts.manifest.content_scripts[0][n];let r=!1;s.forEach((s=>{e.api.tabs[i](a.id,{file:s},(()=>{const i=e.api.runtime.lastError;i&&i.message&&!1===r&&(r=!0,t(a.id,n))}))}))}))}))}else t(a.id,s)})),n()}))}))}));const t=(t,a)=>{e.api.tabs.sendMessage(t,{action:"reinitialize",type:a})},a=async()=>{e.api.bookmarks.onImportBegan.addListener((()=>{this.importRunning=!0})),e.api.bookmarks.onImportEnded.addListener((()=>{this.importRunning=!1})),["Changed","Created","Removed"].forEach((t=>{e.api.bookmarks["on"+t].addListener((()=>{!1===this.importRunning&&!1===this.preventReload&&this.reload({type:t})}))})),["Moved","ChildrenReordered"].forEach((t=>{e.api.bookmarks["on"+t].addListener((()=>{Promise.all([this.helper.cache.remove({name:"htmlList"}),this.helper.cache.remove({name:"htmlPinnedEntries"})])}))}))},n=()=>{this.helper={model:new e.ModelHelper(this),bookmarks:new e.Bookmarks(this),language:new e.LanguageHelper(this),upgrade:new e.UpgradeHelper(this),viewAmount:new e.ViewAmountHelper(this),newtab:new e.NewtabHelper(this),image:new e.ImageHelper(this),port:new e.PortHelper(this),icon:new e.IconHelper(this),browserAction:new e.BrowserActionHelper(this),utility:new e.UtilityHelper(this),linkchecker:new e.Linkchecker(this),cache:new e.CacheHelper(this),analytics:new e.AnalyticsHelper(this)}},i=(t,a=0)=>{this.helper&&this.helper.upgrade&&this.helper.upgrade.loaded?"install"===t.reason?this.helper.upgrade.onInstalled(t):"update"===t.reason&&this.helper.upgrade.onUpdated(t):a<100&&e.delay(500).then((()=>{i(t,a+1)}))};this.run=()=>{const t=+new Date;e.api.runtime.onInstalled.addListener((e=>{i(e)})),e.api.runtime.setUninstallURL(e.opts.website.info[e.isDev?"landing":"uninstall"]),n(),Promise.all([this.helper.model.init(),this.helper.language.init(),this.helper.analytics.init(),this.helper.bookmarks.init()]).then((()=>this.helper.icon.init())).then((()=>Promise.all([a(),this.helper.browserAction.init(),this.helper.newtab.init(),this.helper.image.init(),this.helper.port.init(),this.helper.upgrade.init()]))).then((()=>this.helper.analytics.trackUserData())).then((()=>(this.helper.newtab.reload(),this.reinitialize()))).then((()=>{1===Math.floor(20*Math.random())+1&&this.helper.model.getLicenseKey().then((e=>this.helper.utility.checkLicenseKey(e.licenseKey))).then((e=>{!1===e.valid&&this.helper.model.setLicenseKey(null)})),e.isDev&&console&&console.info&&console.info("Finished loading background script",+new Date-t)}))}}).run()})(jsu);