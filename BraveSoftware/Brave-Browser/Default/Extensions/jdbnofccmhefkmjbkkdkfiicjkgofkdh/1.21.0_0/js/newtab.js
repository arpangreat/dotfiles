/*! (c) Philipp König under GPL-3.0 */
(e=>{"use strict";e.EntryHelper=function(e){let t=!1,a={},n={},r={},l={bookmarks:{},directories:{},pinned:{}};this.init=e=>(t=!0,new Promise((t=>{this.update(e).then(t)}))),this.initOnce=()=>new Promise((e=>{t?e():this.init().then(e)})),this.getAmount=t=>{if(i(),0===Object.keys(a).length&&(a=e.helper.model.getData("u/entryAmounts")),a&&a[t]){let e=a[t].visible;return n.showHidden&&(e+=a[t].hidden),e}return null},this.getAllDataByType=e=>Object.values(l[e]||{}),this.getDataById=e=>{let t=null;return"object"==typeof l.bookmarks[e]?(t=l.bookmarks[e],"object"==typeof l.pinned[e]&&(t.pinnedIndex=l.pinned[e].index)):"object"==typeof l.directories[e]&&(t=l.directories[e]),t},this.getParentsById=e=>{const t=[];try{let a=this.getDataById(e).parentId;for(;a;){const e=this.getDataById(a);e&&t.push(e),a=e&&e.parentId?e.parentId:null}}catch(e){}return t},this.addData=(e,t,a)=>{"object"==typeof l.bookmarks[e]?("pinnedIndex"===t&&"object"==typeof l.pinned[e]&&(l.pinned[e].index=a),l.bookmarks[e][t]=a):"object"==typeof l.directories[e]&&(l.directories[e][t]=a)},this.isSeparator=e=>{let t=!1;return"object"==typeof l.bookmarks[e]&&(t="about:blank"===l.bookmarks[e].url&&/^[-_]{3,}/.test(l.bookmarks[e].title)&&/[-_]{3,}$/.test(l.bookmarks[e].title)),t},this.isVisible=e=>{let t=!1;return"object"==typeof l.bookmarks[e]?t=!1===l.bookmarks[e].hidden:"object"==typeof l.directories[e]&&(t=!1===l.directories[e].hidden),t},this.update=(t=null)=>new Promise((n=>{i();const o=[e.helper.model.call("viewAmounts")];null===t&&o.push(e.helper.model.call("bookmarks",{id:0})),Promise.all(o).then((i=>{r=i[0],null===t&&i[1]&&i[1].bookmarks&&i[1].bookmarks[0]&&i[1].bookmarks[0].children&&(t=i[1].bookmarks[0].children),l={bookmarks:{},directories:{},pinned:{}},a={bookmarks:{visible:0,hidden:0},directories:{visible:0,hidden:0},pinned:{visible:0,hidden:0}},s(t),e.helper.model.setData({"u/entryAmounts":a}),n()}))}));const i=()=>{n=e.helper.model.getData(["u/hiddenEntries","u/additionalInfo","u/pinnedEntries","u/showHidden"])},s=(e,t=[],a=!1)=>{e.forEach((e=>{const l=[...t];"0"!==e.parentId&&l.push(e.parentId),e.additionalInfo=n.additionalInfo[e.id]||{},e.hidden=a||!0===n.hiddenEntries[e.id],e.parents=l,e.views={startDate:+new Date(Math.max(e.dateAdded,r.counterStartDate)),total:0},e.url?d(e):e.children&&o(e)}))},o=e=>{e.childrenAmount={bookmarks:0,directories:0,total:0},e.parents.forEach((e=>{l.directories[e].childrenAmount.directories++})),l.directories[e.id]=e,s(e.children,e.parents,e.hidden),e.isDir=!0,e.childrenAmount.total=e.childrenAmount.bookmarks+e.childrenAmount.directories,e.views.perMonth=Math.round(e.views.total/c(e.views.startDate)*100)/100,a.directories[e.hidden?"hidden":"visible"]++},d=e=>{let t=0,i=0;if(r.viewAmounts[e.id]&&(t=r.viewAmounts[e.id].c,i=r.viewAmounts[e.id].d||0),e.views.total=t,e.views.lastView=i,e.views.perMonth=Math.round(t/c(e.views.startDate)*100)/100,e.parents.forEach((e=>{l.directories[e]&&(l.directories[e].childrenAmount.bookmarks++,l.directories[e].views.total+=t,l.directories[e].views.lastView=Math.max(l.directories[e].views.lastView||0,i))})),e.pinned=!1,l.bookmarks[e.id]=e,!1===this.isSeparator(e.id)&&a.bookmarks[e.hidden?"hidden":"visible"]++,n.pinnedEntries[e.id]){e.pinned=!0;const t=Object.assign({},e);t.index=n.pinnedEntries[e.id].index,delete t.parents,delete t.parentId,l.pinned[e.id]=t,a.pinned[e.hidden?"hidden":"visible"]++}},c=e=>Math.max(1,Math.round((+new Date-e)/2627999942.4))},e.EditHelper=function(t){let a=!1;this.init=async()=>{e("<a></a>").addClass(e.cl.newtab.edit).appendTo(t.elm.body),n(),location.href.search(/#edit$/i)>-1&&s()},this.isEditMode=()=>a;const n=()=>{t.elm.body.on("click","a."+e.cl.newtab.edit,(e=>{e.preventDefault(),a||s()}))},r=()=>new Promise((a=>{const n=+new Date,r=t.helper.template.loading().appendTo(t.elm.body);t.elm.body.addClass(e.cl.loading);const i=t.helper.search.getCurrentSearchEngine(),s=i.name;delete i.name;const o=t.elm.gridLinks.children("select["+e.attr.type+"='type']")[0].value,d={"n/searchField":t.elm.search.wrapper.children("select["+e.attr.type+"='searchField']")[0].value,"n/searchEngine":s,"n/searchEngineCustom":i,"n/gridType":o,"n/topLinksPosition":t.elm.topLinks.children("select")[0].value,"n/topLinks":l(t.elm.topLinks.find("> ul > li > a"))};"premium"===t.helper.model.getUserType()&&(d["n/gridMaxCols"]=+t.elm.gridLinks.find("select["+e.attr.type+"='cols']")[0].value,d["n/gridMaxRows"]=+t.elm.gridLinks.find("select["+e.attr.type+"='rows']")[0].value),"custom"===o&&(d["n/customGridLinks"]=l(t.elm.gridLinks.find("> ul > li > a"),!0)),t.helper.model.setData(d).then((()=>{const a=t.elm.body.css("background-image").replace(/(^url\("?|"?\)$)/g,"");return new Promise((t=>{e.api.storage.local.set({newtabBackground_1:a&&"none"!==a?a:null},(()=>{e.api.runtime.lastError,t()}))}))})).then((()=>e.delay(Math.max(0,1e3-(+new Date-n))))).then((()=>{t.elm.body.removeClass(e.cl.loading),r.remove(),a()}))})),l=(t,a=!1)=>{const n=[];return t.forEach((t=>{const r=e(t).text().trim(),l=(e(t).data("href")||"").trim();r&&r.length>0&&l&&l.length>0?n.push({title:r,url:l}):a&&n.push({title:"",url:""})})),n},i=()=>{a=!1,history.pushState({},null,location.href.replace(/#edit/g,"")),t.elm.body.removeClass(e.cl.newtab.edit),t.elm.search.wrapper.children("a."+e.cl.newtab.edit).remove(),t.elm.search.wrapper.children("select").remove(),t.elm.topLinks.children("select").remove(),t.elm.gridLinks.children("select").remove(),t.elm.gridLinks.children("div["+e.attr.type+"='gridsize']").remove(),m(t.elm.gridLinks,"> ul > li > a"),m(t.elm.topLinks,"> ul > li > a"),t.helper.search.updateSearchEngine(t.helper.model.getData("n/searchEngine"),t.helper.model.getData("n/searchEngineCustom")),t.helper.search.setVisibility(t.helper.model.getData("n/searchField")),t.helper.gridLinks.setType(t.helper.model.getData("n/gridType")),t.helper.gridLinks.setMaxCols(t.helper.model.getData("n/gridMaxCols")),t.helper.gridLinks.setMaxRows(t.helper.model.getData("n/gridMaxRows")),t.helper.topLinks.refreshEntries(),t.getBackground().then((e=>{t.setBackground(e)})),e.delay(500).then((()=>{e("menu."+e.cl.newtab.infoBar).remove()}))},s=()=>{a=!0,history.pushState({},null,location.href.replace(/#edit/g,"")+"#edit");const n=e("<menu></menu>").addClass(e.cl.newtab.infoBar).append("<a class='"+e.cl.cancel+"'>"+t.helper.i18n.get("overlay_cancel")+"</a>").append("<a class='"+e.cl.newtab.save+"'>"+t.helper.i18n.get("settings_save")+"</a>").appendTo(t.elm.body),l=e("<div></div>").addClass(e.cl.newtab.upload).appendTo(n);"premium"===t.helper.model.getUserType()?(e("<a></a>").addClass(e.cl.newtab.remove).appendTo(l),e("<div></div>").html("<span>"+t.helper.i18n.get("newtab_upload_background")+'</span><input type="file" accept="image/*" />').appendTo(l)):(l.attr("title",t.helper.i18n.get("premium_restricted_text")),e("<span></span>").text(t.helper.i18n.get("settings_menu_premium")).addClass(e.cl.premium).appendTo(l),e("<div></div>").html("<span>"+t.helper.i18n.get("newtab_upload_background")+"</span>").appendTo(l)),e("menu."+e.cl.newtab.infoBar+" > a").on("click",(t=>{t.preventDefault();const a=e(t.currentTarget);a.hasClass(e.cl.cancel)?i():a.hasClass(e.cl.newtab.save)&&r().then((()=>{i()}))})),"premium"===t.helper.model.getUserType()?(e("menu."+e.cl.newtab.infoBar+" > div."+e.cl.newtab.upload+" input").on("change",(a=>{if(a.currentTarget.files){const n=new FileReader;n.onload=a=>{try{t.elm.body.addClass(e.cl.newtab.customBackground).css("background-image","url("+a.target.result+")")}catch(a){}},n.readAsDataURL(a.currentTarget.files[0])}})),e("menu."+e.cl.newtab.infoBar+" > div."+e.cl.newtab.upload+" a."+e.cl.newtab.remove).on("click",(()=>{t.elm.body.removeClass(e.cl.newtab.customBackground).css("background-image","")}))):e("menu."+e.cl.newtab.infoBar+" > div."+e.cl.newtab.upload).on("click",(()=>{t.helper.model.call("openLink",{href:e.api.extension.getURL("html/settings.html#premium"),newTab:!0})})),e.delay().then((()=>{t.elm.body.addClass(e.cl.newtab.edit),g(),u(),d(),p(),c(),e(document).off("click.edit").on("click.edit",(()=>{e("div."+e.cl.newtab.editLinkTooltip).remove()})),e.delay(500).then((()=>{e(window).trigger("resize")}))}))},o=(a,n,r,l="empty")=>{e("div."+e.cl.newtab.editLinkTooltip).remove();const i=(n.data("href")||"").trim(),s=e("<div></div>").addClass(e.cl.newtab.editLinkTooltip).append("<label>"+t.helper.i18n.get("overlay_bookmark_title")+"</label>").append("<input type='text' value='"+r.text().trim().replace(/'/g,"&#x27;")+"' "+e.attr.type+"='label' />").append("<label>"+t.helper.i18n.get("overlay_bookmark_url")+"</label>").append("<input type='text' value='"+i.replace(/'/g,"&#x27;")+"' "+e.attr.type+"='url' />").append("<button type='submit' "+e.attr.type+"='delete'>"+t.helper.i18n.get("overlay_delete")+"</button>").append("<button type='submit' "+e.attr.type+"='close'>"+t.helper.i18n.get("overlay_close")+"</button>").appendTo(a);s.on("click",(t=>{"BUTTON"!==t.target.tagName?t.stopPropagation():"delete"===e(t.target).attr(e.attr.type)&&("empty"===l?(n.removeAttr("href").removeData("href").attr(e.attr.value,"empty"),r.html("&nbsp;")):"delete"===l&&(r.remove(),n.remove()))})),s.find("input[type='text']").on("change input",(t=>{let a=t.currentTarget.value.trim();switch(e(t.currentTarget).attr(e.attr.type)){case"url":n.removeAttr("href").removeData("href"),a&&a.length>0?(0!==a.search(/^[\w-]+:\/\//)&&(a="http://"+a),n.data("href",a).attr(e.attr.value,"url")):n.attr(e.attr.value,"empty");break;case"label":a&&a.length>0?r.text(a.trim()):r.html("&nbsp;")}}))},d=()=>{const a=e("<select></select>").addClass(e.cl.newtab.edit).attr(e.attr.type,"type").prependTo(t.elm.gridLinks),n=t.helper.gridLinks.getAllTypes(),r=t.helper.model.getData("n/gridType");Object.keys(n).forEach((l=>{const i=t.helper.i18n.get("newtab_grid_links_"+n[l]);e("<option value='"+l+"' "+(r===l?"selected":"")+"></option>").text(i).appendTo(a)})),a.on("input change",(e=>{t.helper.gridLinks.setType(e.currentTarget.value)}))},c=()=>{const a=t.helper.model.getData("n/topLinksPosition"),n=e("<select></select>").addClass(e.cl.newtab.edit).appendTo(t.elm.topLinks);["left","right"].forEach((r=>{e("<option value='"+r+"' "+(a===r?"selected":"")+"></option>").text(t.helper.i18n.get("settings_sidebar_position_"+r)).appendTo(n)})),n.on("input change",(a=>{t.elm.topLinks.attr(e.attr.position,a.currentTarget.value)}));e("<a class='"+e.cl.newtab.add+"'></a>").prependTo(t.elm.topLinks).on("click",(()=>{const a=e("<li></li>").append("<a>&nbsp;</a>").prependTo(t.elm.topLinks.children("ul"));e.delay().then((()=>{const e=a.children("a").eq(0);o(a,e,e,"delete"),h(t.elm.topLinks,"> ul > li > a")}))})),t.elm.topLinks.off("click.edit").on("click.edit","> ul > li > a",(t=>{t.stopPropagation(),t.preventDefault();const a=e(t.currentTarget),n=a.parent("li");o(n,a,a,"delete")})),h(t.elm.topLinks,"> ul > li > a")},p=()=>{t.elm.gridLinks.off("click.edit").on("click.edit","> ul > li > a",(a=>{if("custom"===t.elm.gridLinks.attr(e.attr.type)){a.stopPropagation(),a.preventDefault();const t=e(a.currentTarget),n=t.parent("li"),r=t.children("span").eq(0);o(n,t,r)}})),h(t.elm.gridLinks,"> ul > li > a")},h=(t,a)=>{let n=null;t.find(a).attr("draggable","draggable"),t.off("dragstart.edit").on("dragstart.edit",a,(t=>{n=t.currentTarget,e("div."+e.cl.newtab.editLinkTooltip).remove()})),t.off("dragenter.edit").on("dragenter.edit",a,(t=>{e(t.currentTarget).addClass(e.cl.drag.dragHover)})),t.off("dragover.edit").on("dragover.edit",a,(e=>{e.preventDefault()})),t.off("dragleave.edit").on("dragleave.edit",a,(t=>{e(t.currentTarget).removeClass(e.cl.drag.dragHover)})),t.off("dragend.edit").on("dragend.edit",a,(()=>{t.find(a).removeClass(e.cl.drag.dragHover),e.delay().then((()=>{n=null}))})),t.off("drop.edit").on("drop.edit",a,(r=>{if(r.preventDefault(),t.find(a).removeClass(e.cl.drag.dragHover),n===r.currentTarget)return;const l=r.currentTarget.nextElementSibling,i=r.currentTarget.parentNode;n===l?i.insertBefore(n,r.currentTarget):(n.replaceWith(r.currentTarget),i.insertBefore(n,l))}))},m=(e,t)=>{e.find(t).removeAttr("draggable"),e.off("click.edit"),e.off("dragstart.edit"),e.off("dragenter.edit"),e.off("dragover.edit"),e.off("dragleave.edit"),e.off("dragend.edit"),e.off("drop.edit")},u=()=>{const a=e("<div></div>").attr(e.attr.type,"gridsize").html("<strong>"+t.helper.i18n.get("newtab_grid_links_grid_size")+"</strong>").prependTo(t.elm.gridLinks);["Cols","Rows"].forEach((n=>{const r=t.helper.model.getData("n/gridMax"+n),i=e("<select></select>").addClass(e.cl.newtab.edit).attr(e.attr.type,n.toLowerCase()).appendTo(a);for(let t=1;t<10;t++)e("<option value='"+t+"' "+(r===t?"selected":"")+"></option>").text(t).appendTo(i);i.on("input change",(a=>{const r=l(t.elm.gridLinks.find("> ul > li > a"),!0);t.helper.gridLinks["setMax"+n](a.currentTarget.value).then((()=>{t.elm.gridLinks.find("> ul > li > a").forEach(((t,a)=>{if(!r[a])return!1;e(t).data("href",r[a].url).attr("href",r[a].url).attr(e.attr.value,"url"),e(t).children("span").eq(0).text(r[a].title)}))}))}))})),e("<span></span>").text("x").insertAfter(a.children("select").eq(0)),"premium"!==t.helper.model.getUserType()&&(a.addClass(e.cl.premium).attr("title",t.helper.i18n.get("premium_restricted_text")),a.find("select").attr("disabled","disabled"),e("<span></span>").text(t.helper.i18n.get("settings_menu_premium")).addClass(e.cl.premium).appendTo(a),a.on("click",(()=>{t.helper.model.call("openLink",{href:e.api.extension.getURL("html/settings.html#premium"),newTab:!0})})))},g=()=>{const a=e("<select></select>").addClass(e.cl.newtab.edit).attr(e.attr.type,"searchField").prependTo(t.elm.search.wrapper),n=t.helper.model.getData("n/searchField");["show","hide"].forEach((r=>{const l=t.helper.i18n.get("newtab_search_field_"+r);e("<option value='"+r+"' "+(n===r?"selected":"")+"></option>").text(l).appendTo(a)})),a.on("input change",(e=>{t.helper.search.setVisibility(e.currentTarget.value)}));e("<a></a>").addClass(e.cl.newtab.edit).appendTo(t.elm.search.wrapper).on("click",(e=>{e.preventDefault(),t.helper.overlay.create("searchEngine",t.helper.i18n.get("newtab_search_engine_headline"))}))}},e.FallbackHelper=function(t){this.init=async()=>{const r=new URL(location.href).searchParams.get("type");null!==r&&(t.elm.gridLinks.addClass(e.cl.hidden),t.elm.fallbackInfo.addClass(e.cl.active),l(r),a(r),"new_tab"!==r&&"fallback"!==r||!1!==t.helper.model.getData("n/override")||n())};const a=a=>{t.elm.fallbackInfo.children("a").on("click",(t=>{t.preventDefault();let n="general";switch(a){case"notWhitelisted":case"blacklisted":n="filter"}e.api.tabs.create({url:e.api.extension.getURL("html/settings.html#support_error_"+n)})}))},n=()=>{const a=e("<div></div>").appendTo(t.elm.fallbackInfo),n=t.helper.checkbox.get(t.elm.body,{},"checkbox","switch").appendTo(a);e("<span></span>").html(t.helper.i18n.get("newtab_fallback_set_as_new_tab")).insertAfter(n),n.children("input[type='checkbox']").on("change",(t=>{t.currentTarget.checked?e.api.permissions.request({permissions:["tabs","topSites","history"]},(e=>{e?r(!0):n.trigger("click")})):r(!1)}))},r=a=>{e.api.storage.sync.get(["newtab"],(n=>{const r=n.newtab||{};r.override=a,e.api.storage.sync.set({newtab:r},(()=>{t.enabledSetAsNewtab=!0,t.helper.model.call("reinitialize")}))}))},l=a=>{const n={headline:"newtab_fallback_headline_general",desc:"newtab_fallback_desc",link:"more_link"};switch(a){case"new_tab":case"system":case"extension_page":case"webstore":n.headline="newtab_fallback_headline_"+a;break;case"notWhitelisted":case"blacklisted":n.headline="newtab_fallback_headline_url_filter"}e("<h2></h2>").text(t.helper.i18n.get(n.headline)).appendTo(t.elm.fallbackInfo),e("<p></p>").text(t.helper.i18n.get(n.desc)).appendTo(t.elm.fallbackInfo),e("<a></a>").text(t.helper.i18n.get(n.link)).appendTo(t.elm.fallbackInfo)}},e.GridLinksHelper=function(t){let a=null,n=0,r=0,l=!1;const i={topPages:"default",mostUsed:"most_used",recentlyUsed:"recently_used",custom:"custom",hidden:"hidden"};this.init=async()=>{s(),t.elm.gridLinks.html("<ul></ul>"),a=t.helper.model.getData("n/gridType"),n=t.helper.model.getData("n/gridMaxCols"),r=t.helper.model.getData("n/gridMaxRows"),d(),setInterval((()=>{document.hidden&&d()}),18e4)},this.getAllTypes=()=>i,this.setType=async e=>{a=e,await d()},this.setMaxCols=async e=>{n!==e&&(n=e,await d())},this.setMaxRows=async e=>{r!==e&&(r=e,await d())},this.handleWindowResize=async()=>{const e=o(),a=t.elm.gridLinks.children("ul").data("total");e.total!==a&&await d()};const s=()=>{e(window).on("resize.gridLinks",(()=>{this.handleWindowResize()}),{passive:!0}),t.elm.gridLinks.on("click auxclick","> ul > li > a",(a=>{"custom"===t.elm.gridLinks.attr(e.attr.type)&&t.elm.body.hasClass(e.cl.newtab.edit)||(a.preventDefault(),0!==a.button&&1!==a.button||t.helper.model.call("openLink",{href:e(a.currentTarget).data("href"),newTab:"auxclick"===a.type,position:t.helper.model.getData("b/newTabPosition"),active:"auxclick"!==a.type}))}))},o=()=>{const e={cols:n,rows:r},a=t.elm.content[0].offsetWidth||window.innerWidth,l=(t.elm.content[0].offsetHeight||window.innerHeight)-t.elm.search.wrapper[0].offsetHeight-150;for(;145*e.cols>a&&e.cols>0;)e.cols--;for(;121*e.rows>l&&e.rows>0;)e.rows--;return e.total=e.cols*e.rows,e},d=()=>new Promise((n=>{t.elm.gridLinks.attr(e.attr.type,a);const r=t.elm.gridLinks.children("ul");r.removeClass(e.cl.visible),"hidden"===a?(!1===t.helper.edit.isEditMode()&&r.data("total",0).html(""),n()):!1===l&&(l=!0,Promise.all([c(),e.delay(200)]).then((([a])=>{const n=o();return r.html("").data("total",n.total).css("grid-template-columns","1fr ".repeat(n.cols).trim()),a.forEach((a=>{const n=e("<li></li>").appendTo(r),l=e("<a></a>").attr({href:a.url,title:a.title,[e.attr.value]:0===a.url.length?"empty":"url"}).data("href",a.url).appendTo(n);e("<span></span>").text(a.title).appendTo(l),t.helper.model.call("favicon",{url:a.url}).then((t=>{if(t.img){const a=e("<img />").attr("src",t.img);e("<div></div>").append(a).prependTo(l)}})),"custom"===t.elm.gridLinks.attr(e.attr.type)&&t.elm.body.hasClass(e.cl.newtab.edit)&&l.attr("draggable","draggable")})),e.delay(100)})).then((()=>{r.addClass(e.cl.visible),l=!1,n()})))})),c=()=>new Promise((n=>{const r=o();if(r.total>0)switch(a){case"mostUsed":case"recentlyUsed":new Promise((e=>{t.helper.entry.init().then((()=>{e()}))})).then((()=>{const e=h(a);n(e)}));break;case"custom":{const e=p();n(e);break}case"topPages":default:e.api.topSites&&e.api.topSites.get&&e.api.topSites.get((t=>{if(void 0===e.api.runtime.lastError&&t){const e=t.slice(0,r.total);n(e)}else n([])}))}else n([])})),p=()=>{const e=[],a=o(),n=t.helper.model.getData("n/customGridLinks");for(let t=0;t<a.total;t++)n[t]&&n[t].title&&n[t].url?e.push(n[t]):e.push({title:"",url:""});return e},h=e=>{const a=o(),n=[],r=t.helper.model.getData("u/showHidden"),l=t.helper.entry.getAllDataByType("bookmarks");return t.helper.utility.sortEntries(l,{name:e,dir:"DESC"}),l.some((e=>{if((r||t.helper.entry.isVisible(e.id))&&!1===t.helper.entry.isSeparator(e.id)&&0!==e.url.search(/^file:\/\//)&&(n.push(e),n.length>=a.total))return!0})),n}},e.OverlayHelper=function(t){let a={};this.create=(n,l)=>{switch(a=t.helper.template.overlay(n,l),a.buttonWrapper.children("a."+e.cl.close).text(t.helper.i18n.get("overlay_close")),n){case"searchEngine":r()}s()};const n=()=>{t.helper.utility.triggerEvent("overlayClosed"),a.overlay.removeClass(e.cl.page.visible),e.delay(400).then((()=>{a.overlay.remove()}))},r=()=>{const n=e("<div></div>").addClass(e.cl.scrollBox.wrapper).appendTo(a.modal),r=e("<ul></ul>").appendTo(n),l=t.helper.search.getSearchEngineList(),i=t.helper.search.getCurrentSearchEngine();Object.entries(l).forEach((([n,l])=>{const s=e("<li></li>").append(t.helper.checkbox.get(a.overlay.find("body"),{[e.attr.name]:"searchEngine",[e.attr.value]:n},"radio")).append("<a>"+l.name+"</a>").appendTo(r);l.favicon&&e("<img />").attr("src",l.favicon).prependTo(s.children("a")),i.name===n&&s.find("input["+e.attr.name+"='searchEngine']["+e.attr.value+"='"+n+"']").parent("div."+e.cl.checkbox.box).trigger("click")}));const s=e("<ul></ul>").attr(e.attr.type,"custom").appendTo(n);"custom"===i.name&&s.addClass(e.cl.visible),e("<li></li>").append("<label>"+t.helper.i18n.get("newtab_search_engine_custom_title")+"</label>").append("<input type='text' name='title' value='"+i.title.replace(/'/g,"&#x27;")+"' />").appendTo(s),e("<li></li>").append("<label>"+t.helper.i18n.get("newtab_search_engine_custom_url_homepage")+"</label>").append("<input type='text' name='homepage' value='"+i.homepage.replace(/'/g,"&#x27;")+"' placeholder='https://example.com' />").appendTo(s),e("<li></li>").append("<label>"+t.helper.i18n.get("newtab_search_engine_custom_url_results")+"</label>").append("<input type='text' name='queryUrl' value='"+i.queryUrl.replace(/'/g,"&#x27;")+"' placeholder='https://example.com/?q={1}' />").appendTo(s),e("<a></a>").addClass(e.cl.overlay.action).text(t.helper.i18n.get("overlay_save")).appendTo(a.buttonWrapper)},l=()=>{let t=null;return a.modal.find("input[type='checkbox']").forEach((a=>{if(a.checked)return t=e(a).attr(e.attr.value),!1})),t},i=()=>{const e=l();e&&t.helper.search.updateSearchEngine(e,{title:a.modal.find("input[name='title']")[0].value,homepage:a.modal.find("input[name='homepage']")[0].value,queryUrl:a.modal.find("input[name='queryUrl']")[0].value}),n()},s=()=>{let t=null;a.overlay.find("body").on("mousedown",(e=>{t=e.target})).on("click",(e=>{"BODY"===e.target.tagName&&"BODY"===t.tagName&&n()})),a.modal.find("a."+e.cl.close).on("click",(e=>{e.preventDefault(),n()})),a.modal.on("click","a",(t=>{t.preventDefault();const n=e(t.currentTarget),r=n.prev("div."+e.cl.checkbox.box);r.length()>0&&r.trigger("click"),n.hasClass(e.cl.overlay.action)&&(()=>{switch(a.modal.attr(e.attr.type)){case"searchEngine":i()}})()})),a.modal.find("input[type='checkbox']").on("change",(()=>{e.delay().then((()=>{const t=a.modal.find("ul["+e.attr.type+"='custom']");"custom"===l()?t.addClass(e.cl.visible):t.removeClass(e.cl.visible)}))}))}},e.SearchHelper=function(t){const a={};let n={},r={},l=!1;const i={google:{name:"Google",url:"https://www.google.com/",queryUrl:"https://www.google.com/search?q={1}",favicon:"https://www.google.com/favicon.ico",sorting:10},bing:{name:"Bing",url:"https://www.bing.com/",queryUrl:"https://www.bing.com/search?q={1}",favicon:"https://www.bing.com/favicon.ico",sorting:20},yandex:{name:"Yandex",url:"https://yandex.com/",queryUrl:"https://yandex.com/search/?text={1}",favicon:"https://yandex.com/favicon.ico",sorting:30,lang:{ru:{name:"Яндекс",url:"https://yandex.ru/",queryUrl:"https://yandex.ru/search/?text={1}",sorting:15},uk:{name:"Яндекс",url:"https://yandex.ua/",queryUrl:"https://yandex.ua/search/?text={1}",sorting:15},tr:{url:"https://yandex.com.tr/",queryUrl:"https://yandex.com.tr/search/?text={1}",sorting:15}}},baidu:{name:"Baidu",url:"https://www.baidu.com/",queryUrl:"https://www.baidu.com/s?wd={1}",favicon:"https://www.baidu.com/favicon.ico",sorting:40,lang:{"zh-CN":{name:"百度",sorting:5}}},custom:{sorting:50}};this.init=async()=>{s(),c(),this.updateSearchEngine(t.helper.model.getData("n/searchEngine"),t.helper.model.getData("n/searchEngineCustom")),this.setVisibility(t.helper.model.getData("n/searchField"))},this.setVisibility=a=>{"hide"===a?t.elm.search.wrapper.addClass(e.cl.hidden):t.elm.search.wrapper.removeClass(e.cl.hidden)},this.updateSearchEngine=(e,a={})=>{if(r[e]){n={name:e,title:a.title||"",homepage:a.homepage||"",queryUrl:a.queryUrl||""};const l="custom"===n.name&&n.title?n.title:r[e].label;t.elm.search.field.attr("placeholder",t.helper.i18n.get("newtab_search_placeholder",[l]))}},this.focusSearch=()=>{!1===t.elm.search.wrapper.hasClass(e.cl.hidden)?(!1===l&&(l=!0,t.elm.search.field[0].value=(window.cachedKeys||[]).join("")),t.elm.search.field[0].focus()):t.elm.sidebar&&t.elm.sidebar.iframe&&t.helper.model.getData("n/autoOpen")&&(e(document).trigger(e.opts.events.openSidebar),t.elm.sidebar.iframe[0].focus())},this.getCurrentSearchEngine=()=>n,this.getSearchEngineList=()=>r;const s=()=>{const e=t.helper.i18n.getUILanguage(),a=[];Object.entries(i).forEach((([n,r])=>{if("custom"===n){const e=t.helper.model.getData("n/searchEngineCustom");r.name=t.helper.i18n.get("newtab_search_engine_custom"),r.label=e.title,r.url=e.homepage,r.queryUrl=e.queryUrl}const l={alias:n,name:r.name,label:r.label||r.name,favicon:r.favicon||null,url:r.url,queryUrl:r.queryUrl,sorting:r.sorting};r.lang&&r.lang[e]&&Object.entries(r.lang[e]).forEach((([e,t])=>{l[e]=t})),l.name&&a.push(l)})),a.sort(((e,t)=>(e.sorting||9999)-(t.sorting||9999))),r={},a.forEach((e=>{r[e.alias]=e}))},o=a=>{const n=e("ul."+e.cl.newtab.suggestions+" > li."+e.cl.active);let r="next"===a?0:-1;n.length()>0&&(r=n.prevAll("li").length()+("next"===a?1:-1),n.removeClass(e.cl.active));let l=!1;if(r>=0){const a=e("ul."+e.cl.newtab.suggestions+" > li").eq(r);a.length()>0&&(l=!0,a.addClass(e.cl.active),t.elm.search.field[0].value=(a.attr(e.attr.src)||a.text()).trim())}!1===l&&(t.elm.search.field[0].value=t.elm.search.field.data("typedVal")||"")},d=(e,a={})=>{if(!e||0===e.trim().length)return;const l=e=>{t.helper.model.call("openLink",{href:e,newTab:a.newtab||!1,position:t.helper.model.getData("b/newTabPosition"),active:!a.newtab})};if(0===e.search(/https?\:\/\//)||0===e.search(/s?ftps?\:\/\//)||0===e.search(/chrome\:\/\//))l(e);else if(r[n.name]){let t="";"custom"===n.name&&n.queryUrl?t=n.queryUrl:r[n.name].queryUrl&&(t=r[n.name].queryUrl),t&&(!1===t.includes("{1}")&&(t+="{1}"),l(t.replace("{1}",encodeURIComponent(e))))}},c=()=>{t.elm.search.speechSearch.on("click",(e=>{e.preventDefault(),p()})),t.elm.search.submit.on("click",(e=>{e.preventDefault(),e.stopPropagation();const a=t.elm.search.field[0].value;if(a&&a.trim().length>0)d(a);else if(r[n.name]){let e="";"custom"===n.name&&n.homepage?e=n.homepage:r[n.name].url&&(e=r[n.name].url),e&&t.helper.model.call("openLink",{href:e,newTab:!1})}})),t.elm.search.field.on("keyup click",(n=>{n.preventDefault(),n.stopPropagation();const r=n.currentTarget.value.trim(),l=event.which||event.keyCode;13===l?d(r):40===l?o("next"):38===l?o("prev"):(t.elm.search.field.data("typedVal",r),(n=>new Promise((r=>{if(n)if(a[n])r(a[n]);else{const l=encodeURIComponent(n),i=(e=[])=>{a[n]=e,r(e)},s=[e.xhr("http://google.com/complete/search?client=chrome&q="+l,{responseType:"json"})];n.length>=2&&s.push(t.helper.model.call("searchBookmarks",{searchVal:n})),n.length>=3&&e.api.history&&s.push(t.helper.model.call("searchHistory",{searchVal:n})),Promise.all(s).then((([e,t,a])=>{try{const r=[],l=[];if(t&&t.bookmarks&&t.bookmarks.length>0){let e=0;t.bookmarks.some((t=>{if(t.url&&(r.push({type:"bookmark",label:t.title,url:t.url}),e++,e>=2))return!0}))}if(a&&a.history&&a.history.length>0){let e=0;a.history.some((t=>{if(t.url&&(r.push({type:"history",label:t.title,url:t.url}),e++,e>=2))return!0}))}e.response&&e.response.length>1&&e.response[0]===n&&e.response[1].forEach(((t,a)=>{let n=t;"NAVIGATION"===e.response[4]["google:suggesttype"][a]?(n=n.replace(/^https?:\/\//,""),n=n.replace(/\/$/,""),n=n.replace(/^www\./,""),r.push({type:"url",url:t,label:n})):l.push({type:"word",label:n})})),i(r.concat(l))}catch(e){i()}}),(()=>{i()}))}else r([])})))(r).then((a=>{if(t.elm.search.field.data("typedVal")!==r)return;if(e("ul."+e.cl.newtab.suggestions).remove(),0===a.length)return;const n=e("<ul></ul>").addClass(e.cl.newtab.suggestions).insertAfter(t.elm.search.field);a.some(((t,a)=>{const r=e("<li></li>").attr(e.attr.type,t.type).text(t.label).appendTo(n);if(t.url&&r.attr({title:t.url,[e.attr.src]:t.url}).append("<span>"+t.url+"</span>"),a>5)return!0})),n.css({top:t.elm.search.field[0].offsetTop+"px",left:t.elm.search.field[0].offsetLeft+"px"})})))})),e(document).on("mousemove","ul."+e.cl.newtab.suggestions+" > li",(t=>{e("ul."+e.cl.newtab.suggestions+" > li").removeClass(e.cl.active),e(t.currentTarget).addClass(e.cl.active)})).on("click auxclick","ul."+e.cl.newtab.suggestions+" > li",(t=>{t.preventDefault(),t.stopPropagation();const a=(e(t.currentTarget).attr(e.attr.src)||e(t.currentTarget).text()).trim();d(a,{newtab:"auxclick"===t.type})})),e(document).on("keydown",(a=>{"f"===a.key&&(a.ctrlKey||a.metaKey)&&(a.preventDefault(),t.sidebarHelper&&t.sidebarHelper.search&&t.elm.sidebar&&t.elm.sidebar.iframe&&(e(document).trigger(e.opts.events.openSidebar),t.elm.sidebar.iframe[0].focus(),t.sidebarHelper.search.showSearchField()))})),e(document).on("click",(()=>{e("ul."+e.cl.newtab.suggestions).remove(),!1===t.helper.edit.isEditMode()&&this.focusSearch()})),e(window).on("resize",(()=>{e("ul."+e.cl.newtab.suggestions).remove()}),{passive:!0})},p=()=>{const a=window.webkitSpeechRecognition||window.SpeechRecognition;if(a){if(t.elm.search.wrapper.hasClass(e.cl.newtab.listening)&&t.elm.search.wrapper.data("recognition"))return void t.elm.search.wrapper.data("recognition").stop();const n=new a;t.elm.search.wrapper.data("recognition",n);let r=!1;n.continuous=!1,n.interimResults=!0,n.start(),n.onresult=e=>{let a="",n=!1;for(let t=e.resultIndex;t<e.results.length;++t)a+=e.results[t][0].transcript,e.results[t].isFinal&&(n=!0);a.length>0&&(t.elm.search.field[0].value=a,r=!0),n&&d(a)},n.onstart=()=>{t.elm.search.wrapper.addClass(e.cl.newtab.listening),t.elm.search.field[0].value=t.helper.i18n.get("newtab_speech_search_listening")+" ..."},n.onend=()=>{t.elm.search.wrapper.removeClass(e.cl.newtab.listening),!1===r&&(t.elm.search.field[0].value="")},n.onerror=e=>{n.stop(),n.onend(null),"not-allowed"===e.error&&alert(t.helper.i18n.get("newtab_speech_search_error"))}}}},e.TopLinksHelper=function(t){this.init=async()=>{this.refreshEntries(),a()},this.refreshEntries=()=>{const a=t.helper.model.getData("n/topLinks"),n=t.helper.model.getData("n/topLinksPosition");t.elm.topLinks.attr(e.attr.position,n),t.elm.topLinks.children("ul").remove();const r=e("<ul></ul>").appendTo(t.elm.topLinks);a&&a.length>0&&a.forEach((t=>{const a=e("<li></li>").appendTo(r);e("<a></a>").text(t.title).appendTo(a).data("href",t.url).attr("href",t.url)}))};const a=()=>{t.elm.topLinks.on("click auxclick","> ul > li  > a",(a=>{t.elm.body.hasClass(e.cl.newtab.edit)||(a.preventDefault(),0!==a.button&&1!==a.button||t.helper.model.call("openLink",{href:e(a.currentTarget).data("href"),newTab:"auxclick"===a.type,position:t.helper.model.getData("b/newTabPosition"),active:"auxclick"!==a.type}))}))}};(new function(){this.elm={body:e("body"),content:e("section#content"),topLinks:e("section#content > nav"),search:{wrapper:e("div#search"),field:e("div#search > input[type='text']"),submit:e("div#search > button[type='submit']"),speechSearch:e("div#search > a.speechSearch")},fallbackInfo:e("div#fallbackInfo"),gridLinks:e("div#gridLinks")},this.sidebarHelper={},this.enabledSetAsNewtab=!1,this.run=()=>{r(),t();const l=this.helper.template.loading().appendTo(this.elm.body);this.elm.body.addClass(e.cl.initLoading).attr("id",e.opts.ids.page.newtab),this.helper.model.init().then((()=>{const t=this.helper.model.getData(["a/darkMode","a/highContrast","b/sidebarPosition"]);return!0===t.darkMode?this.elm.body.addClass(e.cl.page.darkMode):!0===t.highContrast&&this.elm.body.addClass(e.cl.page.highContrast),this.elm.body.attr(e.attr.position,t.sidebarPosition),this.helper.font.init(),this.helper.stylesheet.init(),Promise.all([n(),this.helper.i18n.init(),this.helper.stylesheet.addStylesheets(["newtab"],e(document))])})).then((()=>(this.elm.body.parent("html").attr("dir",this.helper.i18n.isRtl()?"rtl":"ltr"),this.helper.i18n.parseHtml(document),Promise.all([this.getBackground(),this.helper.gridLinks.init(),this.helper.topLinks.init(),this.helper.search.init(),this.helper.fallback.init(),this.helper.edit.init(),a(),e.delay(500)])))).then((([t])=>{l.remove(),this.setBackground(t),this.elm.body.removeClass([e.cl.building,e.cl.initLoading]),e(window).trigger("resize"),this.helper.model.getData("n/autoOpen")||!1!==this.elm.search.wrapper.hasClass(e.cl.hidden)||this.helper.search.focusSearch()}))},this.getBackground=()=>new Promise((t=>{"premium"===this.helper.model.getUserType()?e.api.storage.local.get(["newtabBackground_1"],(e=>{e&&e.newtabBackground_1?t(e.newtabBackground_1):t(null)})):t(null)})),this.setBackground=async t=>{null===t?this.elm.body.removeClass(e.cl.newtab.customBackground).css("background-image",""):this.elm.body.addClass(e.cl.newtab.customBackground).css("background-image","url("+t+")")};const t=()=>{this.helper={model:new e.ModelHelper(this),template:new e.TemplateHelper(this),i18n:new e.I18nHelper(this),font:new e.FontHelper(this),stylesheet:new e.StylesheetHelper(this),checkbox:new e.CheckboxHelper(this),utility:new e.UtilityHelper(this),search:new e.SearchHelper(this),overlay:new e.OverlayHelper(this),entry:new e.EntryHelper(this),topLinks:new e.TopLinksHelper(this),gridLinks:new e.GridLinksHelper(this),fallback:new e.FallbackHelper(this),edit:new e.EditHelper(this)}},a=async()=>{e.api.extension.onMessage.addListener((e=>{e&&e.action&&"reinitialize"===e.action&&!1===this.enabledSetAsNewtab&&location.reload(!0)})),e(document).on("keydown",(t=>{"Tab"===t.key&&this.elm.sidebar.sidebar.hasClass(e.cl.sidebar.permanent)&&(t.preventDefault(),this.elm.sidebar.iframe[0].focus())})),this.helper.model.getData("n/autoOpen")&&e(window).on("resize",(()=>{if(this.elm.sidebar&&this.elm.sidebar.iframe&&this.elm.sidebar.sidebar){const t=this.elm.sidebar.sidebar.realWidth();window.innerWidth-t>=500?(this.elm.sidebar.sidebar.addClass(e.cl.sidebar.permanent),t>0&&this.elm.content.addClass(e.cl.newtab.smallContent),e(document).trigger(e.opts.events.openSidebar),e.delay(500).then((()=>{e(document).trigger("click")}))):(this.elm.sidebar.sidebar.removeClass(e.cl.sidebar.permanent),this.elm.content.removeClass(e.cl.newtab.smallContent)),this.helper.gridLinks.handleWindowResize()}}),{passive:!0})},n=async()=>{const t=this.helper.model.getData(["n/faviconShape","n/faviconColor","n/faviconBackground","n/faviconPadding"]),a=await this.helper.model.call("iconImageData",{name:t.faviconShape,color:t.faviconColor,padding:t.faviconPadding,background:t.faviconBackground,asDataURL:!0});e("<link />").attr({rel:"icon",href:a}).appendTo(document.head)},r=()=>new Promise((t=>{e("["+e.attr.type+"='script_sidebar']").remove();const a=[e.opts.events.loaded,e.opts.events.elementsCreated].join(" ");e(document).off(a).on(a,(t=>{this.elm.sidebar=t.detail.elm,this.sidebarHelper=t.detail.helper,e(window).trigger("resize")})),e.opts.manifest.content_scripts[0].css.forEach((t=>{e("<link />").attr({href:e.api.extension.getURL(t),type:"text/css",rel:"stylesheet",[e.attr.type]:"script_sidebar"}).appendTo("head")}));const n=(a=0)=>{const r=e.opts.manifest.content_scripts[0].js[a];if(void 0!==r){const t=document.createElement("script");document.head.appendChild(t),t.onload=()=>n(a+1),t.src="/"+r,e(t).attr(e.attr.type,"script_sidebar")}else t()};n()}))}).run()})(jsu);